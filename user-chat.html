<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat AI - T·∫°o H·ª£p ƒë·ªìng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .sidebar {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .nav-link.active {
            background-color: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
        }
        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }
        .message.bot {
            background-color: white;
            border: 1px solid #e9ecef;
        }
        .contract-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .contract-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        .contract-card.selected {
            border-color: #667eea;
            background-color: #f0f4ff;
        }
        .extracted-data-badge {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }
        .missing-field {
            border-color: #ffc107 !important;
            background-color: #fff8e1;
        }
        .field-filled {
            border-color: #28a745 !important;
            background-color: #e8f5e9;
        }
        .placeholder-inline {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 13px;
            margin: 0 2px;
        }
        .placeholder-inline.filled {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .placeholder-inline.missing {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #333;
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background-color: #667eea;
            border-radius: 50%;
            animation: typing 1s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        .contract-preview {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar text-white p-0">
                <div class="p-3">
                    <h4 class="mb-4">MENU</h4>
                    <div class="nav flex-column" id="mainMenu">
                        <a href="admin-contract.html" class="nav-link text-white mb-2">
                            <i class="bi bi-gear-fill me-2"></i>Qu·∫£n l√Ω M·∫´u H·ª£p ƒë·ªìng
                        </a>
                        <a href="user-extract.html" class="nav-link text-white mb-2">
                            <i class="bi bi-card-image me-2"></i>Tr√≠ch xu·∫•t th√¥ng tin
                        </a>
                        <a href="user-chat.html" class="nav-link text-white active mb-2">
                            <i class="bi bi-chat-dots-fill me-2"></i>Chat AI
                        </a>
                    </div>
                    <div class="mt-4 text-center">
                        <small>Phi√™n b·∫£n 1.0</small>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4 main-content">
                <div class="row">
                    <!-- Chat Section -->
                    <div class="col-md-6">
                        <div class="bg-white rounded shadow-sm p-4 h-100">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    <i class="bi bi-robot me-2"></i>Chat AI - T·∫°o H·ª£p ƒë·ªìng
                                </h5>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearChat()">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            
                            <!-- Extracted Data Info -->
                            <div id="extractedDataInfo" class="mb-3" style="display: none;">
                                <div class="extracted-data-badge">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <span id="extractedDataCount">0</span> th√¥ng tin ƒë√£ ƒë∆∞·ª£c tr√≠ch xu·∫•t
                                </div>
                            </div>
                            
                            <div class="chat-container mb-3" id="chatContainer">
                                <!-- Messages will be added here -->
                            </div>

                            <div class="input-group">
                                <input type="text" 
                                       class="form-control" 
                                       id="chatInput" 
                                       placeholder="Nh·∫≠p tin nh·∫Øn... (VD: T√¥i c·∫ßn t·∫°o h·ª£p ƒë·ªìng thu√™ nh√†)"
                                       onkeypress="handleKeyPress(event)">
                                <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">
                                    <i class="bi bi-send-fill"></i>
                                </button>
                            </div>
                            
                            <div class="mt-2">
                                <small class="text-muted">
                                    G·ª£i √Ω: "T·∫°o h·ª£p ƒë·ªìng thu√™ nh√†", "H·ª£p ƒë·ªìng mua b√°n", "Li·ªát k√™ c√°c h·ª£p ƒë·ªìng"
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Contract Preview Section -->
                    <div class="col-md-6">
                        <div class="bg-white rounded shadow-sm p-4 h-100">
                            <h5 class="mb-3">
                                <i class="bi bi-file-earmark-text me-2"></i>H·ª£p ƒë·ªìng
                            </h5>
                            
                            <!-- Contract Selection -->
                            <div id="contractSelection" style="display: none;">
                                <p class="text-muted mb-3">Ch·ªçn m·∫´u h·ª£p ƒë·ªìng b·∫°n mu·ªën s·ª≠ d·ª•ng:</p>
                                <div id="contractsList"></div>
                            </div>
                            
                            <!-- Missing Fields Form -->
                            <div id="missingFieldsForm" style="display: none;">
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>Thi·∫øu th√¥ng tin!</strong> Vui l√≤ng b·ªï sung c√°c th√¥ng tin sau:
                                </div>
                                <div id="missingFieldsList"></div>
                                <button class="btn btn-primary w-100 mt-3" onclick="submitMissingFields()">
                                    <i class="bi bi-check-lg me-2"></i>Ho√†n th√†nh
                                </button>
                            </div>
                            
                            <!-- Contract Preview -->
                            <div id="contractPreviewSection" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="badge bg-success">H·ª£p ƒë·ªìng ƒë√£ ho√†n th√†nh</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="downloadContract()">
                                            <i class="bi bi-download me-2"></i>T·∫£i Word
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="printContract()">
                                            <i class="bi bi-printer me-2"></i>In
                                        </button>
                                    </div>
                                </div>
                                <div class="contract-preview" id="contractPreview"></div>
                            </div>
                            
                            <!-- Default State -->
                            <div id="defaultState">
                                <div class="text-center text-muted py-5">
                                    <i class="bi bi-chat-left-text" style="font-size: 48px;"></i>
                                    <p class="mt-3">H√£y chat v·ªõi AI ƒë·ªÉ b·∫Øt ƒë·∫ßu t·∫°o h·ª£p ƒë·ªìng</p>
                                    <p class="small">Ho·∫∑c nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ xem c√°c h·ª£p ƒë·ªìng c√≥ s·∫µn</p>
                                    <button class="btn btn-outline-primary" onclick="showAvailableContracts()">
                                        <i class="bi bi-list-ul me-2"></i>Xem danh s√°ch h·ª£p ƒë·ªìng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========== CONFIGURATION ==========
        const CONTRACTS_DB_API = window.location.origin + '/api/contracts-db.php';
        const GEMINI_API_KEY = 'AIzaSyD_6P9ZJW2Yu436attBF0KF8TTLJt7rQAE';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

        // ========== STATE ==========
        let extractedData = {};
        let availableContracts = [];
        let selectedContract = null;
        let filledData = {};
        let missingFields = [];
        let chatHistory = [];

        // ========== INITIALIZATION ==========
        window.addEventListener('load', async () => {
            // Load extracted data from sessionStorage
            loadExtractedData();
            
            // Load available contracts from database
            await loadAvailableContracts();
            
            // Check if coming from extract page
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('fromExtract') === 'true') {
                // Show welcome message with extracted data
                showWelcomeWithData();
            } else {
                // Show default welcome
                showDefaultWelcome();
            }
        });

        function loadExtractedData() {
            const stored = sessionStorage.getItem('extractedData');
            if (stored) {
                const data = JSON.parse(stored);
                extractedData = data;
                
                // Flatten data for easier use
                filledData = flattenExtractedData(data);
                
                // Show extracted data info
                const count = Object.keys(filledData).length;
                if (count > 0) {
                    document.getElementById('extractedDataInfo').style.display = 'block';
                    document.getElementById('extractedDataCount').textContent = count;
                }
            }
        }

        function flattenExtractedData(data) {
            const flattened = {};
            
            // Process CCCD data
            if (data.cccd) {
                Object.entries(data.cccd).forEach(([party, info]) => {
                    Object.entries(info).forEach(([key, value]) => {
                        if (value) {
                            // Create multiple key variations for matching
                            flattened[`${key}_${party.toLowerCase()}`] = value;
                            flattened[`${key}_ben_${party.toLowerCase()}`] = value;
                            if (party === 'A') {
                                flattened[key] = value; // Default to first party
                                flattened[`${key}_ben_a`] = value;
                            }
                            if (party === 'B') {
                                flattened[`${key}_ben_b`] = value;
                            }
                        }
                    });
                });
            }
            
            // Process other document data
            if (data.other) {
                Object.entries(data.other).forEach(([party, info]) => {
                    Object.entries(info).forEach(([key, value]) => {
                        if (value) {
                            flattened[`${key}_${party.toLowerCase()}`] = value;
                        }
                    });
                });
            }
            
            return flattened;
        }

        async function loadAvailableContracts() {
            try {
                const response = await fetch(CONTRACTS_DB_API);
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    availableContracts = data;
                    console.log(`Loaded ${availableContracts.length} contracts from database`);
                }
            } catch (error) {
                console.error('Error loading contracts:', error);
            }
        }

        // ========== CHAT FUNCTIONS ==========
        function showDefaultWelcome() {
            addBotMessage(`Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI gi√∫p b·∫°n t·∫°o h·ª£p ƒë·ªìng.
            
T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:
‚Ä¢ T·∫°o h·ª£p ƒë·ªìng t·ª´ c√°c m·∫´u c√≥ s·∫µn
‚Ä¢ ƒêi·ªÅn th√¥ng tin t·ª± ƒë·ªông t·ª´ gi·∫•y t·ªù ƒë√£ tr√≠ch xu·∫•t
‚Ä¢ Ki·ªÉm tra v√† b·ªï sung th√¥ng tin c√≤n thi·∫øu

B·∫°n mu·ªën t·∫°o lo·∫°i h·ª£p ƒë·ªìng n√†o? (VD: h·ª£p ƒë·ªìng thu√™ nh√†, mua b√°n, ·ªßy quy·ªÅn...)`);
        }

        function showWelcomeWithData() {
            const partyCount = Object.keys(extractedData.cccd || {}).length;
            const fieldCount = Object.keys(filledData).length;
            
            addBotMessage(`Tuy·ªát v·ªùi! T√¥i ƒë√£ nh·∫≠n ƒë∆∞·ª£c th√¥ng tin t·ª´ ${partyCount} ƒë∆∞∆°ng s·ª± v·ªõi ${fieldCount} tr∆∞·ªùng d·ªØ li·ªáu.

üìã **Th√¥ng tin ƒë√£ c√≥:**
${Object.entries(extractedData.cccd || {}).map(([party, data]) => 
    `‚Ä¢ ƒê∆∞∆°ng s·ª± ${party}: ${data.fullname || 'N/A'}`
).join('\n')}

B√¢y gi·ªù b·∫°n mu·ªën t·∫°o lo·∫°i h·ª£p ƒë·ªìng n√†o?
${availableContracts.length > 0 ? `\nüìÇ H·ªá th·ªëng c√≥ ${availableContracts.length} m·∫´u h·ª£p ƒë·ªìng s·∫µn c√≥.` : ''}

üí° G·ª£i √Ω: "T·∫°o h·ª£p ƒë·ªìng thu√™ nh√†" ho·∫∑c "Xem danh s√°ch h·ª£p ƒë·ªìng"`);
        }

        function addBotMessage(text, isHtml = false) {
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = 'message bot';
            
            if (isHtml) {
                div.innerHTML = `
                    <div class="d-flex align-items-start">
                        <i class="bi bi-robot me-2" style="font-size: 20px; color: #667eea;"></i>
                        <div class="flex-grow-1">${text}</div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="d-flex align-items-start">
                        <i class="bi bi-robot me-2" style="font-size: 20px; color: #667eea;"></i>
                        <div class="flex-grow-1">${text.replace(/\n/g, '<br>').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')}</div>
                    </div>
                `;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            
            chatHistory.push({ role: 'bot', content: text });
        }

        function addUserMessage(text) {
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = 'message user';
            div.innerHTML = `<div>${text}</div>`;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            
            chatHistory.push({ role: 'user', content: text });
        }

        function showTypingIndicator() {
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = 'message bot';
            div.id = 'typingIndicator';
            div.innerHTML = `
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addUserMessage(message);
            input.value = '';
            
            showTypingIndicator();
            
            try {
                await processUserMessage(message);
            } catch (error) {
                console.error('Error processing message:', error);
                addBotMessage('Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
            }
            
            hideTypingIndicator();
        }

        async function processUserMessage(message) {
            const lowerMessage = message.toLowerCase();
            
            // Check for contract creation intent
            if (lowerMessage.includes('h·ª£p ƒë·ªìng') || 
                lowerMessage.includes('t·∫°o') || 
                lowerMessage.includes('l·∫≠p') ||
                lowerMessage.includes('thu√™') ||
                lowerMessage.includes('mua b√°n') ||
                lowerMessage.includes('·ªßy quy·ªÅn')) {
                
                // Find matching contracts
                const matches = findMatchingContracts(message);
                
                if (matches.length > 0) {
                    showContractOptions(matches, message);
                } else if (availableContracts.length > 0) {
                    addBotMessage(`T√¥i kh√¥ng t√¨m th·∫•y m·∫´u h·ª£p ƒë·ªìng ph√π h·ª£p v·ªõi "${message}".

ƒê√¢y l√† c√°c m·∫´u h·ª£p ƒë·ªìng c√≥ s·∫µn trong h·ªá th·ªëng:`);
                    showAvailableContracts();
                } else {
                    addBotMessage(`Hi·ªán t·∫°i ch∆∞a c√≥ m·∫´u h·ª£p ƒë·ªìng n√†o trong h·ªá th·ªëng.

Vui l√≤ng li√™n h·ªá Admin ƒë·ªÉ th√™m m·∫´u h·ª£p ƒë·ªìng, ho·∫∑c b·∫°n c√≥ th·ªÉ m√¥ t·∫£ lo·∫°i h·ª£p ƒë·ªìng c·∫ßn t·∫°o v√† t√¥i s·∫Ω h·ªó tr·ª£.`);
                }
            }
            // List contracts
            else if (lowerMessage.includes('danh s√°ch') || 
                     lowerMessage.includes('li·ªát k√™') || 
                     lowerMessage.includes('xem') ||
                     lowerMessage.includes('c√≥ g√¨')) {
                showAvailableContracts();
            }
            // General chat - use AI
            else {
                await chatWithAI(message);
            }
        }

        function findMatchingContracts(query) {
            const lowerQuery = query.toLowerCase();
            const keywords = lowerQuery.split(/\s+/);
            
            return availableContracts.filter(contract => {
                const name = contract.name.toLowerCase();
                return keywords.some(keyword => 
                    keyword.length > 2 && name.includes(keyword)
                );
            });
        }

        function showContractOptions(contracts, userQuery) {
            if (contracts.length === 1) {
                addBotMessage(`T√¥i t√¨m th·∫•y m·∫´u h·ª£p ƒë·ªìng ph√π h·ª£p: **${contracts[0].name}**
                
B·∫°n c√≥ mu·ªën s·ª≠ d·ª•ng m·∫´u n√†y kh√¥ng?`);
            } else {
                addBotMessage(`T√¥i t√¨m th·∫•y ${contracts.length} m·∫´u h·ª£p ƒë·ªìng ph√π h·ª£p. Vui l√≤ng ch·ªçn m·ªôt m·∫´u:`);
            }
            
            showContractSelection(contracts);
        }

        function showAvailableContracts() {
            if (availableContracts.length === 0) {
                addBotMessage('Hi·ªán t·∫°i ch∆∞a c√≥ m·∫´u h·ª£p ƒë·ªìng n√†o trong h·ªá th·ªëng. Vui l√≤ng li√™n h·ªá Admin ƒë·ªÉ th√™m m·∫´u.');
                return;
            }
            
            addBotMessage(`üìÇ C√≥ ${availableContracts.length} m·∫´u h·ª£p ƒë·ªìng trong h·ªá th·ªëng. Vui l√≤ng ch·ªçn m·ªôt m·∫´u b√™n ph·∫£i.`);
            showContractSelection(availableContracts);
        }

        function showContractSelection(contracts) {
            document.getElementById('defaultState').style.display = 'none';
            document.getElementById('contractSelection').style.display = 'block';
            document.getElementById('missingFieldsForm').style.display = 'none';
            document.getElementById('contractPreviewSection').style.display = 'none';
            
            const container = document.getElementById('contractsList');
            container.innerHTML = '';
            
            contracts.forEach((contract, index) => {
                const card = document.createElement('div');
                card.className = 'contract-card';
                card.onclick = () => selectContract(contract.id);
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${contract.name}</h6>
                            <small class="text-muted">
                                <i class="bi bi-file-earmark me-1"></i>${contract.file_type === 'word' ? 'Word' : 'PDF'}
                                <span class="ms-2"><i class="bi bi-calendar me-1"></i>${formatDate(contract.created_at)}</span>
                            </small>
                        </div>
                        <i class="bi bi-chevron-right text-muted"></i>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function selectContract(contractId) {
            // Show loading
            addBotMessage('ƒêang t·∫£i m·∫´u h·ª£p ƒë·ªìng...');
            
            try {
                // Load full contract data
                const response = await fetch(`${CONTRACTS_DB_API}?id=${contractId}`);
                const contract = await response.json();
                
                if (!contract || contract.error) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i h·ª£p ƒë·ªìng');
                }
                
                selectedContract = contract;
                
                // Parse placeholder mappings
                let placeholders = [];
                if (contract.placeholder_mappings) {
                    placeholders = typeof contract.placeholder_mappings === 'string' 
                        ? JSON.parse(contract.placeholder_mappings) 
                        : contract.placeholder_mappings;
                }
                
                // Also extract from modified_content if available
                if (contract.modified_content) {
                    const regex = /data-field="([^"]+)"/g;
                    let match;
                    while ((match = regex.exec(contract.modified_content)) !== null) {
                        const field = match[1];
                        if (!placeholders.some(p => p.field === field)) {
                            placeholders.push({ field: field, label: field });
                        }
                    }
                }
                
                // Find missing fields
                missingFields = findMissingFields(placeholders);
                
                if (missingFields.length > 0) {
                    addBotMessage(`ƒê√£ ch·ªçn h·ª£p ƒë·ªìng: **${contract.name}**

‚ö†Ô∏è C√≥ ${missingFields.length} th√¥ng tin c√≤n thi·∫øu c·∫ßn b·ªï sung.
Vui l√≤ng ƒëi·ªÅn v√†o form b√™n ph·∫£i.`);
                    showMissingFieldsForm();
                } else {
                    addBotMessage(`ƒê√£ ch·ªçn h·ª£p ƒë·ªìng: **${contract.name}**

‚úÖ T·∫•t c·∫£ th√¥ng tin ƒë√£ ƒë·∫ßy ƒë·ªß! ƒêang t·∫°o h·ª£p ƒë·ªìng...`);
                    generateContract();
                }
                
            } catch (error) {
                console.error('Error loading contract:', error);
                addBotMessage('L·ªói khi t·∫£i h·ª£p ƒë·ªìng. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        function findMissingFields(placeholders) {
            const missing = [];
            
            placeholders.forEach(placeholder => {
                const field = placeholder.field;
                const label = placeholder.label || field;
                
                // Check if we have data for this field using the same logic as generateContract
                const value = getValueForField(field);
                
                if (!value) {
                    missing.push({
                        field: field,
                        label: label,
                        sampleData: placeholder.sampleData || ''
                    });
                }
            });
            
            return missing;
        }

        function showMissingFieldsForm() {
            document.getElementById('defaultState').style.display = 'none';
            document.getElementById('contractSelection').style.display = 'none';
            document.getElementById('missingFieldsForm').style.display = 'block';
            document.getElementById('contractPreviewSection').style.display = 'none';
            
            const container = document.getElementById('missingFieldsList');
            container.innerHTML = '';
            
            missingFields.forEach((field, index) => {
                const div = document.createElement('div');
                div.className = 'mb-3';
                div.innerHTML = `
                    <label class="form-label">
                        ${field.label}
                        <span class="text-danger">*</span>
                    </label>
                    <input type="text" 
                           class="form-control missing-field" 
                           id="field_${field.field}"
                           placeholder="${field.sampleData || 'Nh·∫≠p ' + field.label}"
                           data-field="${field.field}">
                `;
                container.appendChild(div);
            });
        }

        function submitMissingFields() {
            // Collect values from form
            let allFilled = true;
            
            missingFields.forEach(field => {
                const input = document.getElementById(`field_${field.field}`);
                const value = input.value.trim();
                
                if (value) {
                    filledData[field.field] = value;
                    input.classList.remove('missing-field');
                    input.classList.add('field-filled');
                } else {
                    allFilled = false;
                    input.classList.add('is-invalid');
                }
            });
            
            if (!allFilled) {
                addBotMessage('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c th√¥ng tin c√≤n thi·∫øu.');
                return;
            }
            
            addBotMessage('‚úÖ ƒê√£ nh·∫≠n ƒë·ªß th√¥ng tin! ƒêang t·∫°o h·ª£p ƒë·ªìng...');
            generateContract();
        }

        function generateContract() {
            if (!selectedContract) return;
            
            document.getElementById('defaultState').style.display = 'none';
            document.getElementById('contractSelection').style.display = 'none';
            document.getElementById('missingFieldsForm').style.display = 'none';
            document.getElementById('contractPreviewSection').style.display = 'block';
            
            let content = selectedContract.modified_content || selectedContract.template || '';
            
            console.log('=== GENERATE CONTRACT ===');
            console.log('FilledData:', filledData);
            
            // Only replace placeholders that admin has configured
            // Method 1: Replace placeholder spans with data-field attribute
            content = content.replace(/<span[^>]*class="[^"]*placeholder-inline[^"]*"[^>]*data-field="([^"]+)"[^>]*>[\s\S]*?<\/span>/gi, 
                (match, field) => {
                    // Only replace if we have data for this exact field
                    const value = getValueForField(field);
                    console.log(`Field "${field}" => Value "${value}"`);
                    
                    if (value) {
                        // Replace with actual value, keep original text style (no color change)
                        return escapeHtml(value);
                    } else {
                        // Keep placeholder visible if no data
                        return `[${field}]`;
                    }
                }
            );
            
            // Method 2: Replace {{field}} syntax in template
            content = content.replace(/\{\{([^}]+)\}\}/g, (match, field) => {
                const value = getValueForField(field.trim());
                if (value) {
                    return escapeHtml(value);
                }
                return `[${field.trim()}]`;
            });
            
            document.getElementById('contractPreview').innerHTML = content || '<p class="text-muted">Kh√¥ng c√≥ n·ªôi dung h·ª£p ƒë·ªìng</p>';
            
            addBotMessage(`üéâ H·ª£p ƒë·ªìng **${selectedContract.name}** ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!

B·∫°n c√≥ th·ªÉ:
‚Ä¢ Xem tr∆∞·ªõc b√™n ph·∫£i
‚Ä¢ T·∫£i xu·ªëng file Word
‚Ä¢ In tr·ª±c ti·∫øp

C·∫ßn t√¥i gi√∫p g√¨ th√™m kh√¥ng?`);
        }

        // Get value for a specific field from extracted data
        function getValueForField(field) {
            if (!field) return null;
            
            console.log(`Looking for field: "${field}"`);
            
            // 1. Exact match first
            if (filledData[field]) {
                console.log(`  -> Exact match found: ${filledData[field]}`);
                return filledData[field];
            }
            
            // 2. Case-insensitive match
            const fieldLower = field.toLowerCase();
            for (const [key, value] of Object.entries(filledData)) {
                if (key.toLowerCase() === fieldLower) {
                    console.log(`  -> Case-insensitive match: ${key} = ${value}`);
                    return value;
                }
            }
            
            // 3. Try common field name mappings
            // Extract party identifier from field (e.g., fullname_ben_a -> party A)
            const partyMatch = field.match(/[_-](ben[_-]?)?([ab])$/i);
            const party = partyMatch ? partyMatch[2].toUpperCase() : null;
            
            // Get base field name without party suffix
            const baseField = field.replace(/[_-](ben[_-]?)?[ab]$/i, '').toLowerCase();
            
            console.log(`  -> Base field: "${baseField}", Party: "${party}"`);
            
            // Map of field aliases
            const aliases = {
                'fullname': ['fullname', 'hovaten', 'hoten', 'name', 'ten'],
                'birthday': ['birthday', 'ngaysinh', 'dob', 'birthdate'],
                'idcard': ['idcard', 'cccd', 'cmnd', 'id', 'socccd', 'socmnd'],
                'address': ['address', 'diachi', 'thuongtru', 'noio', 'dktt'],
                'issue_date': ['issue_date', 'ngaycap', 'issuedate'],
                'expiry_date': ['expiry_date', 'ngayhethan', 'expirydate'],
                'phone': ['phone', 'dienthoai', 'sdt', 'mobile'],
                'email': ['email', 'mail']
            };
            
            // Find which category this field belongs to
            let matchedCategory = null;
            for (const [category, aliasList] of Object.entries(aliases)) {
                if (aliasList.some(a => baseField.includes(a) || a.includes(baseField))) {
                    matchedCategory = category;
                    break;
                }
            }
            
            if (matchedCategory) {
                console.log(`  -> Matched category: ${matchedCategory}`);
                
                // Look for data with this category and party
                for (const [key, value] of Object.entries(filledData)) {
                    const keyLower = key.toLowerCase();
                    const keyPartyMatch = key.match(/[_-]([ab])$/i);
                    const keyParty = keyPartyMatch ? keyPartyMatch[1].toUpperCase() : null;
                    const keyBase = key.replace(/[_-][ab]$/i, '').toLowerCase();
                    
                    // Check if this key matches our category
                    const keyMatchesCategory = aliases[matchedCategory].some(a => 
                        keyBase.includes(a) || a.includes(keyBase)
                    );
                    
                    if (keyMatchesCategory) {
                        // If field specifies a party, match party
                        if (party && keyParty && party === keyParty) {
                            console.log(`  -> Found with party match: ${key} = ${value}`);
                            return value;
                        }
                        // If no party specified in field, return first match
                        if (!party) {
                            console.log(`  -> Found without party: ${key} = ${value}`);
                            return value;
                        }
                    }
                }
            }
            
            console.log(`  -> No match found for: ${field}`);
            return null;
        }

        async function chatWithAI(message) {
            try {
                const prompt = `B·∫°n l√† tr·ª£ l√Ω AI chuy√™n v·ªÅ h·ª£p ƒë·ªìng v√† ph√°p l√Ω Vi·ªát Nam. 
H√£y tr·∫£ l·ªùi ng·∫Øn g·ªçn, th√¢n thi·ªán.
N·∫øu ng∆∞·ªùi d√πng h·ªèi v·ªÅ vi·ªác t·∫°o h·ª£p ƒë·ªìng, h√£y g·ª£i √Ω h·ªç n√≥i "T·∫°o h·ª£p ƒë·ªìng [lo·∫°i]" ho·∫∑c "Xem danh s√°ch h·ª£p ƒë·ªìng".

Ng∆∞·ªùi d√πng: ${message}`;

                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7, maxOutputTokens: 500 }
                    })
                });

                const data = await response.json();
                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 
                    'Xin l·ªói, t√¥i kh√¥ng th·ªÉ tr·∫£ l·ªùi l√∫c n√†y.';
                
                addBotMessage(aiResponse);
            } catch (error) {
                console.error('AI Error:', error);
                addBotMessage('Xin l·ªói, ƒë√£ c√≥ l·ªói khi k·∫øt n·ªëi AI. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        function clearChat() {
            if (confirm('X√≥a to√†n b·ªô l·ªãch s·ª≠ chat?')) {
                document.getElementById('chatContainer').innerHTML = '';
                chatHistory = [];
                selectedContract = null;
                missingFields = [];
                
                document.getElementById('defaultState').style.display = 'block';
                document.getElementById('contractSelection').style.display = 'none';
                document.getElementById('missingFieldsForm').style.display = 'none';
                document.getElementById('contractPreviewSection').style.display = 'none';
                
                showDefaultWelcome();
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('vi-VN');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function downloadContract() {
            if (!selectedContract) return;
            
            const content = document.getElementById('contractPreview').innerHTML;
            
            // Create HTML document
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${selectedContract.name}</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; font-size: 14pt; line-height: 1.5; margin: 40px; }
                        .placeholder-inline { background: none; color: inherit; padding: 0; }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `;
            
            const blob = new Blob([html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${selectedContract.name}.doc`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function printContract() {
            const content = document.getElementById('contractPreview').innerHTML;
            
            const printWindow = window.open('', '', 'height=800,width=600');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${selectedContract?.name || 'H·ª£p ƒë·ªìng'}</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; font-size: 14pt; line-height: 1.5; margin: 40px; }
                        .placeholder-inline { background: none; color: inherit; padding: 0; }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>
