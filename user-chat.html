<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat AI - T·∫°o H·ª£p ƒë·ªìng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .sidebar {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .nav-link.active {
            background-color: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
        }
        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }
        .message.bot {
            background-color: white;
            border: 1px solid #e9ecef;
        }
        .contract-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .contract-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        .contract-card.selected {
            border-color: #667eea;
            background-color: #f0f4ff;
        }
        .extracted-data-badge {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }
        .missing-field {
            border-color: #ffc107 !important;
            background-color: #fff8e1;
        }
        .field-filled {
            border-color: #28a745 !important;
            background-color: #e8f5e9;
        }
        .placeholder-inline {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 13px;
            margin: 0 2px;
        }
        .placeholder-inline.filled {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .placeholder-inline.missing {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #333;
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background-color: #667eea;
            border-radius: 50%;
            animation: typing 1s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        .contract-preview {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        .transaction-select {
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 14px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
        }
        .transaction-select:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
            border-color: #764ba2;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar text-white p-0">
                <div class="p-3">
                    <h4 class="mb-4">MENU</h4>
                    <div class="nav flex-column" id="mainMenu">
                        <a href="admin-contract.html" class="nav-link text-white mb-2">
                            <i class="bi bi-gear-fill me-2"></i>Qu·∫£n l√Ω M·∫´u H·ª£p ƒë·ªìng
                        </a>
                        <a href="user-extract.html" class="nav-link text-white mb-2">
                            <i class="bi bi-card-image me-2"></i>Tr√≠ch xu·∫•t th√¥ng tin
                        </a>
                        <a href="user-chat.html" class="nav-link text-white active mb-2">
                            <i class="bi bi-chat-dots-fill me-2"></i>Chat AI
                        </a>
                    </div>
                    <div class="mt-4 text-center">
                        <small>Phi√™n b·∫£n 1.0</small>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4 main-content">
                <div class="row">
                    <!-- Chat Section -->
                    <div class="col-md-6">
                        <div class="bg-white rounded shadow-sm p-4 h-100">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    <i class="bi bi-robot me-2"></i>Chat AI - T·∫°o H·ª£p ƒë·ªìng
                                </h5>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearChat()">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            
                            <!-- Transaction Type Selector -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-tag-fill me-2 text-primary"></i>Ch·ªçn lo·∫°i giao d·ªãch:
                                </label>
                                <select class="form-select transaction-select" id="transactionType" onchange="onTransactionTypeChange()">
                                    <option value="">‚Äî Ch·ªçn lo·∫°i giao d·ªãch ‚Äî</option>
                                    <option value="gd01">1. VƒÉn b·∫£n l·ª±a ch·ªçn ng∆∞·ªùi gi√°m h·ªô</option>
                                    <option value="gd02">2. VƒÉn b·∫£n t·∫∑ng cho b·∫•t ƒë·ªông s·∫£n</option>
                                    <option value="gd03">3. Di ch√∫c c·ªßa ng∆∞·ªùi h·∫°n ch·∫ø th·ªÉ ch·∫•t / kh√¥ng bi·∫øt ch·ªØ</option>
                                    <option value="gd04">4. VƒÉn b·∫£n ·ªßy quy·ªÅn ƒë·∫°i di·ªán kh√°ng c√°o v·ª• vi·ªác d√¢n s·ª±</option>
                                    <option value="gd05">5. Hƒê mua b√°n / thu√™ mua nh√† ·ªü, c√¥ng tr√¨nh (gi·ªØa c√° nh√¢n)</option>
                                    <option value="gd06">6. Hƒê giao d·ªãch nh√† ·ªü (mua b√°n, thu√™ mua, t·∫∑ng cho, ƒë·ªïi, g√≥p v·ªën, th·∫ø ch·∫•p)</option>
                                    <option value="gd07">7. VƒÉn b·∫£n th·ª´a k·∫ø nh√† ·ªü</option>
                                    <option value="gd08">8. Hƒê chuy·ªÉn nh∆∞·ª£ng / t·∫∑ng cho / th·∫ø ch·∫•p / g√≥p v·ªën QSDƒê v√† t√†i s·∫£n g·∫Øn li·ªÅn</option>
                                    <option value="gd09">9. VƒÉn b·∫£n v·ªÅ th·ª´a k·∫ø QSDƒê, QSDƒê v√† t√†i s·∫£n g·∫Øn li·ªÅn</option>
                                    <option value="gd10">10. Gi·∫•y t·ªù mua b√°n / t·∫∑ng cho / ƒë·ªïi / th·ª´a k·∫ø nh√† ·ªü tr∆∞·ªõc 01/7/2006</option>
                                    <option value="gd11">11. Hƒê thu√™ ƒë·∫•t / g√≥p v·ªën / h·ª£p t√°c ho·∫∑c vƒÉn b·∫£n ƒë·ªìng √Ω x√¢y d·ª±ng nh√† ·ªü</option>
                                    <option value="gd12">12. Hƒê thu√™ ƒë·∫•t / g√≥p v·ªën / h·ª£p t√°c ho·∫∑c vƒÉn b·∫£n ƒë·ªìng √Ω x√¢y d·ª±ng c√¥ng tr√¨nh</option>
                                    <option value="gd13">13. VƒÉn b·∫£n th·ªèa thu·∫≠n ch·∫ø ƒë·ªô t√†i s·∫£n v·ª£ ch·ªìng tr∆∞·ªõc khi k·∫øt h√¥n</option>
                                    <option value="gd14">14. VƒÉn b·∫£n th·ªèa thu·∫≠n v·ªÅ vi·ªác mang thai h·ªô</option>
                                    <option value="gd15">15. VƒÉn b·∫£n s·ª≠a ƒë·ªïi, b·ªï sung th·ªèa thu·∫≠n v·ªÅ ch·∫ø ƒë·ªô t√†i s·∫£n c·ªßa v·ª£ ch·ªìng</option>
                                    <option value="gd16">16. H·ª£p ƒë·ªìng cho thu√™ doanh nghi·ªáp t∆∞ nh√¢n</option>
                                    <option value="gd17">17. VƒÉn b·∫£n ·ªßy quy·ªÅn ƒë·∫°i di·ªán kh√°ng c√°o b·∫£n √°n, quy·∫øt ƒë·ªãnh c·ªßa t√≤a √°n c·∫•p s∆° th·∫©m trong v·ª• vi·ªác h√†nh ch√≠nh</option>
                                    <option value="gd18">18. VƒÉn b·∫£n ·ªßy quy·ªÅn c·ªßa ng∆∞·ªùi c√≥ t√™n trong Hƒê thu√™ nh√† ·ªü ƒë√£ xu·∫•t c·∫£nh cho th√†nh vi√™n kh√°c ƒë·ª©ng t√™n mua nh√† ·ªü c≈© thu·ªôc t√†i s·∫£n c√¥ng</option>
                                    <option value="gd19">19. H·ª£p ƒë·ªìng chuy·ªÉn nh∆∞·ª£ng h·ª£p ƒë·ªìng kinh doanh b·∫•t ƒë·ªông s·∫£n</option>
                                    <option value="gd20">20. VƒÉn b·∫£n th·ªèa thu·∫≠n c·ªßa c√°c th√†nh vi√™n c√≥ chung QSDƒê ƒë·ªìng √Ω ƒë∆∞a QSDƒê v√†o doanh nghi·ªáp</option>
                                    <option value="gd21">21. VƒÉn b·∫£n ·ªßy quy·ªÅn gi·∫£i quy·∫øt vi·ªác thi h√†nh √°n li√™n quan ƒë·∫øn t√†i s·∫£n khi ng∆∞·ªùi ph·∫£i thi h√†nh √°n xu·∫•t c·∫£nh</option>
                                    <option value="gd22">22. VƒÉn b·∫£n ·ªßy quy·ªÅn th·ª±c hi·ªán quy·ªÅn khi·∫øu n·∫°i</option>
                                    <option value="gd23">23. H·ª£p ƒë·ªìng chuy·ªÉn nh∆∞·ª£ng VƒÉn ph√≤ng Th·ª´a ph√°t l·∫°i</option>
                                    <option value="gd24">24. C√°c giao d·ªãch kh√°c theo quy ƒë·ªãnh c·ªßa lu·∫≠t v√† ngh·ªã ƒë·ªãnh</option>
                                </select>
                            </div>
                            
                            <!-- Extracted Data Info -->
                            <div id="extractedDataInfo" class="mb-3" style="display: none;">
                                <div class="extracted-data-badge">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <span id="extractedDataCount">0</span> th√¥ng tin ƒë√£ ƒë∆∞·ª£c tr√≠ch xu·∫•t
                                </div>
                            </div>
                            
                            <div class="chat-container mb-3" id="chatContainer">
                                <!-- Messages will be added here -->
                            </div>

                            <div class="input-group">
                                <input type="text" 
                                       class="form-control" 
                                       id="chatInput" 
                                       placeholder="Nh·∫≠p tin nh·∫Øn... (VD: T√¥i c·∫ßn t·∫°o h·ª£p ƒë·ªìng thu√™ nh√†)"
                                       onkeypress="handleKeyPress(event)">
                                <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">
                                    <i class="bi bi-send-fill"></i>
                                </button>
                            </div>
                            
                            <div class="mt-2">
                                <small class="text-muted">
                                    üí° Ch·ªçn lo·∫°i giao d·ªãch v√† m√¥ t·∫£ nhu c·∫ßu c·ªßa b·∫°n ƒë·ªÉ ƒë∆∞·ª£c t∆∞ v·∫•n ph√°p l√Ω
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Contract Preview Section -->
                    <div class="col-md-6">
                        <div class="bg-white rounded shadow-sm p-4 h-100">
                            <h5 class="mb-3">
                                <i class="bi bi-file-earmark-text me-2"></i>H·ª£p ƒë·ªìng
                            </h5>
                            
                            <!-- Contract Selection -->
                            <div id="contractSelection" style="display: none;">
                                <p class="text-muted mb-3">Ch·ªçn m·∫´u h·ª£p ƒë·ªìng b·∫°n mu·ªën xem tr∆∞·ªõc:</p>
                                <div id="contractsList"></div>
                            </div>
                            
                            <!-- Contract Preview Before Selecting -->
                            <div id="contractPreviewBeforeSelect" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="badge bg-info">Xem tr∆∞·ªõc h·ª£p ƒë·ªìng</span>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="backToContractList()">
                                        <i class="bi bi-arrow-left me-1"></i>Quay l·∫°i
                                    </button>
                                </div>
                                <h6 id="previewContractName" class="text-primary mb-3"></h6>
                                <div class="contract-preview mb-3" id="contractPreviewContent" style="max-height: 350px;"></div>
                                <button class="btn btn-success w-100" onclick="confirmSelectContract()">
                                    <i class="bi bi-check-circle me-2"></i>Ch·ªçn h·ª£p ƒë·ªìng n√†y
                                </button>
                            </div>
                            
                            <!-- Missing Fields Form -->
                            <div id="missingFieldsForm" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="badge bg-warning text-dark">ƒêi·ªÅn th√¥ng tin</span>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="backToPreview()">
                                        <i class="bi bi-arrow-left me-1"></i>Quay l·∫°i
                                    </button>
                                </div>
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>B·ªï sung th√¥ng tin!</strong> Vui l√≤ng ƒëi·ªÅn c√°c th√¥ng tin c√≤n thi·∫øu:
                                </div>
                                <div id="missingFieldsList"></div>
                                <button class="btn btn-primary w-100 mt-3" onclick="submitMissingFields()">
                                    <i class="bi bi-check-lg me-2"></i>Ho√†n th√†nh v√† t·∫°o h·ª£p ƒë·ªìng
                                </button>
                            </div>
                            
                            <!-- Contract Preview (Final) -->
                            <div id="contractPreviewSection" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="badge bg-success">H·ª£p ƒë·ªìng ƒë√£ ho√†n th√†nh</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="downloadContract()">
                                            <i class="bi bi-download me-2"></i>T·∫£i Word
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="printContract()">
                                            <i class="bi bi-printer me-2"></i>In
                                        </button>
                                    </div>
                                </div>
                                <div class="contract-preview" id="contractPreview"></div>
                            </div>
                            
                            <!-- Default State -->
                            <div id="defaultState">
                                <div class="text-center text-muted py-5">
                                    <i class="bi bi-chat-left-text" style="font-size: 48px;"></i>
                                    <p class="mt-3">H√£y chat v·ªõi AI ƒë·ªÉ b·∫Øt ƒë·∫ßu t·∫°o h·ª£p ƒë·ªìng</p>
                                    <p class="small">Ho·∫∑c nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ xem c√°c h·ª£p ƒë·ªìng c√≥ s·∫µn</p>
                                    <button class="btn btn-outline-primary" onclick="showAvailableContracts()">
                                        <i class="bi bi-list-ul me-2"></i>Xem danh s√°ch h·ª£p ƒë·ªìng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========== CONFIGURATION ==========
        const CONTRACTS_DB_API = window.location.origin + '/api/contracts-db.php';
        const N8N_WEBHOOK_URL = 'https://demo.vnlawai.com/webhook/luongtuvan';
        const GEMINI_API_KEY = 'AIzaSyD_6P9ZJW2Yu436attBF0KF8TTLJt7rQAE';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

        // ========== STATE ==========
        let extractedData = {};
        let availableContracts = [];
        let selectedContract = null;
        let previewingContract = null; // Contract being previewed before selection
        let filledData = {};
        let missingFields = [];
        let chatHistory = [];
        let selectedTransactionType = '';
        let selectedTransactionText = '';

        // ========== INITIALIZATION ==========
        window.addEventListener('load', async () => {
            // Load extracted data from sessionStorage
            loadExtractedData();
            
            // Load available contracts from database
            await loadAvailableContracts();
            
            // Check if coming from extract page
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('fromExtract') === 'true') {
                // Show welcome message with extracted data
                showWelcomeWithData();
            } else {
                // Show default welcome
                showDefaultWelcome();
            }
        });

        function loadExtractedData() {
            const stored = sessionStorage.getItem('extractedData');
            if (stored) {
                const data = JSON.parse(stored);
                extractedData = data;
                
                // Flatten data for easier use
                filledData = flattenExtractedData(data);
                
                // Show extracted data info
                const count = Object.keys(filledData).length;
                if (count > 0) {
                    document.getElementById('extractedDataInfo').style.display = 'block';
                    document.getElementById('extractedDataCount').textContent = count;
                }
            }
        }

        function flattenExtractedData(data) {
            const flattened = {};
            
            // Process CCCD data
            if (data.cccd) {
                Object.entries(data.cccd).forEach(([party, info]) => {
                    Object.entries(info).forEach(([key, value]) => {
                        if (value) {
                            // Create multiple key variations for matching
                            flattened[`${key}_${party.toLowerCase()}`] = value;
                            flattened[`${key}_ben_${party.toLowerCase()}`] = value;
                            if (party === 'A') {
                                flattened[key] = value; // Default to first party
                                flattened[`${key}_ben_a`] = value;
                            }
                            if (party === 'B') {
                                flattened[`${key}_ben_b`] = value;
                            }
                        }
                    });
                });
            }
            
            // Process other document data
            if (data.other) {
                Object.entries(data.other).forEach(([party, info]) => {
                    Object.entries(info).forEach(([key, value]) => {
                        if (value) {
                            flattened[`${key}_${party.toLowerCase()}`] = value;
                        }
                    });
                });
            }
            
            return flattened;
        }

        async function loadAvailableContracts() {
            try {
                const response = await fetch(CONTRACTS_DB_API);
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    availableContracts = data;
                    console.log(`Loaded ${availableContracts.length} contracts from database`);
                }
            } catch (error) {
                console.error('Error loading contracts:', error);
            }
        }

        // ========== CHAT FUNCTIONS ==========
        function showDefaultWelcome() {
            const hasData = Object.keys(filledData).length > 0;
            
            if (hasData) {
                const partyCount = Object.keys(extractedData.cccd || {}).length;
                addBotMessage(`Xin ch√†o! T√¥i ƒë√£ nh·∫≠n ƒë∆∞·ª£c th√¥ng tin t·ª´ ${partyCount} ƒë∆∞∆°ng s·ª±.

üìã **Th√¥ng tin ƒë√£ c√≥:**
${Object.entries(extractedData.cccd || {}).map(([party, data]) => 
    `‚Ä¢ ƒê∆∞∆°ng s·ª± ${party}: ${data.fullname || 'N/A'}`
).join('\n')}

**ƒê·ªÉ ƒë∆∞·ª£c t∆∞ v·∫•n ph√°p l√Ω, b·∫°n h√£y:**
1Ô∏è‚É£ Ch·ªçn **lo·∫°i giao d·ªãch** ·ªü dropdown ph√≠a tr√™n
2Ô∏è‚É£ M√¥ t·∫£ chi ti·∫øt **nhu c·∫ßu** c·ªßa b·∫°n
3Ô∏è‚É£ T√¥i s·∫Ω t∆∞ v·∫•n v√† g·ª£i √Ω h·ª£p ƒë·ªìng ph√π h·ª£p`);
            } else {
                addBotMessage(`Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI t∆∞ v·∫•n ph√°p l√Ω.

**ƒê·ªÉ b·∫Øt ƒë·∫ßu, b·∫°n h√£y:**
1Ô∏è‚É£ Ch·ªçn **lo·∫°i giao d·ªãch** ·ªü dropdown ph√≠a tr√™n
2Ô∏è‚É£ M√¥ t·∫£ chi ti·∫øt **nhu c·∫ßu** c·ªßa b·∫°n (VD: "T√¥i mu·ªën cho thu√™ cƒÉn h·ªô 50m2 t·∫°i qu·∫≠n 1")
3Ô∏è‚É£ T√¥i s·∫Ω **t∆∞ v·∫•n ph√°p l√Ω** v√† g·ª£i √Ω m·∫´u h·ª£p ƒë·ªìng ph√π h·ª£p

üí° *M√¥ t·∫£ c√†ng chi ti·∫øt, t∆∞ v·∫•n c√†ng ch√≠nh x√°c!*`);
            }
        }

        function showWelcomeWithData() {
            showDefaultWelcome();
        }

        function onTransactionTypeChange() {
            const select = document.getElementById('transactionType');
            selectedTransactionType = select.value;
            selectedTransactionText = select.options[select.selectedIndex].text;
            
            if (selectedTransactionType) {
                addBotMessage(`‚úÖ B·∫°n ƒë√£ ch·ªçn: **${selectedTransactionText}**

B√¢y gi·ªù h√£y m√¥ t·∫£ chi ti·∫øt nhu c·∫ßu c·ªßa b·∫°n. V√≠ d·ª•:
‚Ä¢ C√°c b√™n tham gia l√† ai?
‚Ä¢ T√†i s·∫£n/ƒë·ªëi t∆∞·ª£ng giao d·ªãch l√† g√¨?
‚Ä¢ Gi√° tr·ªã, th·ªùi h·∫°n, ƒëi·ªÅu ki·ªán ƒë·∫∑c bi·ªát?

T√¥i s·∫Ω t∆∞ v·∫•n ph√°p l√Ω v√† g·ª£i √Ω m·∫´u h·ª£p ƒë·ªìng ph√π h·ª£p!`);
            }
        }

        function addBotMessage(text, isHtml = false) {
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = 'message bot';
            
            if (isHtml) {
                div.innerHTML = `
                    <div class="d-flex align-items-start">
                        <i class="bi bi-robot me-2" style="font-size: 20px; color: #667eea;"></i>
                        <div class="flex-grow-1">${text}</div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="d-flex align-items-start">
                        <i class="bi bi-robot me-2" style="font-size: 20px; color: #667eea;"></i>
                        <div class="flex-grow-1">${text.replace(/\n/g, '<br>').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')}</div>
                    </div>
                `;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            
            chatHistory.push({ role: 'bot', content: text });
        }

        function addUserMessage(text) {
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = 'message user';
            div.innerHTML = `<div>${text}</div>`;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            
            chatHistory.push({ role: 'user', content: text });
        }

        function showTypingIndicator() {
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = 'message bot';
            div.id = 'typingIndicator';
            div.innerHTML = `
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addUserMessage(message);
            input.value = '';
            
            showTypingIndicator();
            
            try {
                await processUserMessage(message);
            } catch (error) {
                console.error('Error processing message:', error);
                addBotMessage('Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
            }
            
            hideTypingIndicator();
        }

        async function processUserMessage(message) {
            // Check if transaction type is selected
            if (!selectedTransactionType) {
                addBotMessage(`‚ö†Ô∏è Vui l√≤ng **ch·ªçn lo·∫°i giao d·ªãch** t·ª´ dropdown ph√≠a tr√™n tr∆∞·ªõc khi chat.`);
                return;
            }
            
            const lowerMessage = message.toLowerCase();
            
            // Check if user wants to see/create contracts
            if (lowerMessage.includes('xem h·ª£p ƒë·ªìng') || 
                lowerMessage.includes('danh s√°ch') || 
                lowerMessage.includes('li·ªát k√™') ||
                lowerMessage.includes('ch·ªçn m·∫´u') ||
                lowerMessage.includes('t·∫°o h·ª£p ƒë·ªìng')) {
                // Use internal AI to suggest contracts
                await suggestContractsWithAI(message);
            } else {
                // Send to n8n webhook for legal consultation only
                await chatWithN8N(message);
            }
        }

        // Chat with n8n webhook - only for legal consultation
        async function chatWithN8N(message) {
            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        transactionType: selectedTransactionType,
                        transactionText: selectedTransactionText,
                        extractedData: filledData,
                        chatHistory: chatHistory.slice(-10)
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Display consultation response
                if (data.message || data.response || data.output) {
                    const botMessage = data.message || data.response || data.output;
                    addBotMessage(botMessage);
                } else if (typeof data === 'string') {
                    addBotMessage(data);
                } else {
                    addBotMessage('C·∫£m ∆°n b·∫°n ƒë√£ g·ª≠i th√¥ng tin. T√¥i ƒëang x·ª≠ l√Ω...');
                }
                
                // After consultation, ask if user wants to see contracts
                setTimeout(() => {
                    addBotMessage(`üí° B·∫°n c√≥ mu·ªën **xem c√°c m·∫´u h·ª£p ƒë·ªìng** ph√π h·ª£p v·ªõi lo·∫°i giao d·ªãch n√†y kh√¥ng?
                    
G√µ "**xem h·ª£p ƒë·ªìng**" ho·∫∑c "**t·∫°o h·ª£p ƒë·ªìng**" ƒë·ªÉ t√¥i g·ª£i √Ω m·∫´u ph√π h·ª£p.`);
                }, 1000);
                
            } catch (error) {
                console.error('N8N Webhook Error:', error);
                addBotMessage('‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi h·ªá th·ªëng t∆∞ v·∫•n. Vui l√≤ng th·ª≠ l·∫°i sau.');
            }
        }

        // Internal AI to suggest contracts from database
        async function suggestContractsWithAI(message) {
            try {
                // Build contract list
                const contractList = availableContracts.map((c, i) => `${i + 1}. ${c.name}`).join('\n');
                
                const prompt = `B·∫°n l√† tr·ª£ l√Ω AI g·ª£i √Ω h·ª£p ƒë·ªìng.

LO·∫†I GIAO D·ªäCH: ${selectedTransactionText}
Y√äU C·∫¶U NG∆Ø·ªúI D√ôNG: ${message}

DANH S√ÅCH M·∫™U H·ª¢P ƒê·ªíNG C√ì S·∫¥N:
${contractList || 'Ch∆∞a c√≥ m·∫´u h·ª£p ƒë·ªìng n√†o'}

NHI·ªÜM V·ª§:
1. D·ª±a v√†o lo·∫°i giao d·ªãch v√† y√™u c·∫ßu, ch·ªçn 1-3 m·∫´u h·ª£p ƒë·ªìng ph√π h·ª£p nh·∫•t
2. Gi·∫£i th√≠ch ng·∫Øn g·ªçn t·∫°i sao ph√π h·ª£p

TR·∫¢ L·ªúI FORMAT JSON:
{
    "message": "L·ªùi gi·ªõi thi·ªáu ng·∫Øn",
    "suggestions": [
        {"index": 1, "reason": "L√Ω do ph√π h·ª£p"}
    ]
}

N·∫øu kh√¥ng c√≥ m·∫´u ph√π h·ª£p, tr·∫£ v·ªÅ suggestions r·ªóng v√† g·ª£i √Ω li√™n h·ªá Admin.`;

                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.3, maxOutputTokens: 800 }
                    })
                });

                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                // Parse AI response
                const jsonMatch = aiText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const result = JSON.parse(jsonMatch[0]);
                    
                    addBotMessage(result.message || 'ƒê√¢y l√† c√°c m·∫´u h·ª£p ƒë·ªìng ph√π h·ª£p:');
                    
                    if (result.suggestions && result.suggestions.length > 0) {
                        // Show suggested contracts
                        const suggestedContracts = result.suggestions
                            .filter(s => s.index > 0 && s.index <= availableContracts.length)
                            .map(s => ({
                                ...availableContracts[s.index - 1],
                                reason: s.reason
                            }));
                        
                        if (suggestedContracts.length > 0) {
                            showSuggestedContracts(suggestedContracts);
                        } else {
                            showAvailableContracts();
                        }
                    } else {
                        showAvailableContracts();
                    }
                } else {
                    // Fallback: show all contracts
                    addBotMessage('ƒê√¢y l√† c√°c m·∫´u h·ª£p ƒë·ªìng c√≥ s·∫µn trong h·ªá th·ªëng:');
                    showAvailableContracts();
                }
                
            } catch (error) {
                console.error('AI Suggestion Error:', error);
                addBotMessage('ƒê√¢y l√† c√°c m·∫´u h·ª£p ƒë·ªìng c√≥ s·∫µn:');
                showAvailableContracts();
            }
        }

        // Show AI suggested contracts with reasons
        function showSuggestedContracts(contracts) {
            hideAllSections();
            document.getElementById('contractSelection').style.display = 'block';
            
            const container = document.getElementById('contractsList');
            container.innerHTML = '<p class="text-success mb-3"><i class="bi bi-stars me-2"></i><strong>AI g·ª£i √Ω c√°c m·∫´u ph√π h·ª£p (click ƒë·ªÉ xem tr∆∞·ªõc):</strong></p>';
            
            contracts.forEach((contract) => {
                const card = document.createElement('div');
                card.className = 'contract-card';
                card.style.borderColor = '#28a745';
                card.style.background = 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)';
                card.onclick = () => previewContract(contract.id);
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1 text-success">
                                <i class="bi bi-check-circle-fill me-2"></i>${contract.name}
                            </h6>
                            <p class="mb-1 small text-muted">${contract.reason || ''}</p>
                            <small class="text-muted">
                                <i class="bi bi-file-earmark me-1"></i>${contract.file_type === 'word' ? 'Word' : 'PDF'}
                            </small>
                        </div>
                        <div class="text-end">
                            <i class="bi bi-eye text-success me-2" title="Xem tr∆∞·ªõc"></i>
                            <i class="bi bi-arrow-right-circle-fill text-success" style="font-size: 24px;"></i>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            
            // Add button to see all
            const allBtn = document.createElement('button');
            allBtn.className = 'btn btn-outline-secondary w-100 mt-3';
            allBtn.innerHTML = '<i class="bi bi-list-ul me-2"></i>Xem t·∫•t c·∫£ m·∫´u h·ª£p ƒë·ªìng';
            allBtn.onclick = () => showAvailableContracts();
            container.appendChild(allBtn);
        }

        function findMatchingContracts(query) {
            const lowerQuery = query.toLowerCase();
            const keywords = lowerQuery.split(/\s+/);
            
            return availableContracts.filter(contract => {
                const name = contract.name.toLowerCase();
                return keywords.some(keyword => 
                    keyword.length > 2 && name.includes(keyword)
                );
            });
        }

        function showContractOptions(contracts, userQuery) {
            if (contracts.length === 1) {
                addBotMessage(`T√¥i t√¨m th·∫•y m·∫´u h·ª£p ƒë·ªìng ph√π h·ª£p: **${contracts[0].name}**
                
B·∫°n c√≥ mu·ªën s·ª≠ d·ª•ng m·∫´u n√†y kh√¥ng?`);
            } else {
                addBotMessage(`T√¥i t√¨m th·∫•y ${contracts.length} m·∫´u h·ª£p ƒë·ªìng ph√π h·ª£p. Vui l√≤ng ch·ªçn m·ªôt m·∫´u:`);
            }
            
            showContractSelection(contracts);
        }

        function showAvailableContracts() {
            if (availableContracts.length === 0) {
                addBotMessage('Hi·ªán t·∫°i ch∆∞a c√≥ m·∫´u h·ª£p ƒë·ªìng n√†o trong h·ªá th·ªëng. Vui l√≤ng li√™n h·ªá Admin ƒë·ªÉ th√™m m·∫´u.');
                return;
            }
            
            addBotMessage(`üìÇ C√≥ ${availableContracts.length} m·∫´u h·ª£p ƒë·ªìng trong h·ªá th·ªëng. Vui l√≤ng ch·ªçn m·ªôt m·∫´u b√™n ph·∫£i.`);
            showContractSelection(availableContracts);
        }

        function showContractSelection(contracts) {
            hideAllSections();
            document.getElementById('contractSelection').style.display = 'block';
            
            const container = document.getElementById('contractsList');
            container.innerHTML = '';
            
            contracts.forEach((contract, index) => {
                const card = document.createElement('div');
                card.className = 'contract-card';
                card.onclick = () => previewContract(contract.id);
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${contract.name}</h6>
                            <small class="text-muted">
                                <i class="bi bi-file-earmark me-1"></i>${contract.file_type === 'word' ? 'Word' : 'PDF'}
                                <span class="ms-2"><i class="bi bi-calendar me-1"></i>${formatDate(contract.created_at)}</span>
                            </small>
                        </div>
                        <div class="text-end">
                            <i class="bi bi-eye text-primary me-2" title="Xem tr∆∞·ªõc"></i>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Preview contract before selecting
        async function previewContract(contractId) {
            addBotMessage('ƒêang t·∫£i xem tr∆∞·ªõc h·ª£p ƒë·ªìng...');
            
            try {
                const response = await fetch(`${CONTRACTS_DB_API}?id=${contractId}`);
                const contract = await response.json();
                
                if (!contract || contract.error) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i h·ª£p ƒë·ªìng');
                }
                
                previewingContract = contract;
                
                // Show preview section
                hideAllSections();
                document.getElementById('contractPreviewBeforeSelect').style.display = 'block';
                
                // Set contract name
                document.getElementById('previewContractName').textContent = contract.name;
                
                // Show contract content
                const content = contract.modified_content || contract.template || '<p class="text-muted">Kh√¥ng c√≥ n·ªôi dung</p>';
                document.getElementById('contractPreviewContent').innerHTML = content;
                
                addBotMessage(`üìÑ ƒêang xem tr∆∞·ªõc: **${contract.name}**

Xem n·ªôi dung h·ª£p ƒë·ªìng b√™n ph·∫£i. N·∫øu ph√π h·ª£p, nh·∫•n **"Ch·ªçn h·ª£p ƒë·ªìng n√†y"** ƒë·ªÉ ti·∫øp t·ª•c ƒëi·ªÅn th√¥ng tin.`);
                
            } catch (error) {
                console.error('Error loading contract:', error);
                addBotMessage('L·ªói khi t·∫£i h·ª£p ƒë·ªìng. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // Back to contract list from preview
        function backToContractList() {
            previewingContract = null;
            hideAllSections();
            document.getElementById('contractSelection').style.display = 'block';
            addBotMessage('Quay l·∫°i danh s√°ch h·ª£p ƒë·ªìng. Ch·ªçn m·∫´u b·∫°n mu·ªën xem.');
        }

        // Confirm select contract after preview
        async function confirmSelectContract() {
            if (!previewingContract) return;
            
            selectedContract = previewingContract;
            previewingContract = null;
            
            // Parse placeholder mappings
            let placeholders = [];
            if (selectedContract.placeholder_mappings) {
                placeholders = typeof selectedContract.placeholder_mappings === 'string' 
                    ? JSON.parse(selectedContract.placeholder_mappings) 
                    : selectedContract.placeholder_mappings;
            }
            
            // Extract from modified_content
            if (selectedContract.modified_content) {
                const regex = /data-field="([^"]+)"/g;
                let match;
                while ((match = regex.exec(selectedContract.modified_content)) !== null) {
                    const field = match[1];
                    if (!placeholders.some(p => p.field === field)) {
                        placeholders.push({ field: field, label: field });
                    }
                }
            }
            
            // Find missing fields
            missingFields = findMissingFields(placeholders);
            
            if (missingFields.length > 0) {
                addBotMessage(`‚úÖ ƒê√£ ch·ªçn h·ª£p ƒë·ªìng: **${selectedContract.name}**

‚ö†Ô∏è C√≥ **${missingFields.length} th√¥ng tin** c√≤n thi·∫øu c·∫ßn b·ªï sung.
Vui l√≤ng ƒëi·ªÅn v√†o form b√™n ph·∫£i.`);
                showMissingFieldsForm();
            } else {
                addBotMessage(`‚úÖ ƒê√£ ch·ªçn h·ª£p ƒë·ªìng: **${selectedContract.name}**

üéâ T·∫•t c·∫£ th√¥ng tin ƒë√£ ƒë·∫ßy ƒë·ªß! ƒêang t·∫°o h·ª£p ƒë·ªìng...`);
                generateContract();
            }
        }

        // Back to preview from missing fields form
        function backToPreview() {
            if (selectedContract) {
                previewingContract = selectedContract;
                selectedContract = null;
                
                hideAllSections();
                document.getElementById('contractPreviewBeforeSelect').style.display = 'block';
                document.getElementById('previewContractName').textContent = previewingContract.name;
                
                const content = previewingContract.modified_content || previewingContract.template || '';
                document.getElementById('contractPreviewContent').innerHTML = content;
            }
        }

        // Hide all sections helper
        function hideAllSections() {
            document.getElementById('defaultState').style.display = 'none';
            document.getElementById('contractSelection').style.display = 'none';
            document.getElementById('contractPreviewBeforeSelect').style.display = 'none';
            document.getElementById('missingFieldsForm').style.display = 'none';
            document.getElementById('contractPreviewSection').style.display = 'none';
        }

        async function selectContract(contractId) {
            // This now just calls previewContract
            await previewContract(contractId);
        }

        function findMissingFields(placeholders) {
            const missing = [];
            
            placeholders.forEach(placeholder => {
                const field = placeholder.field;
                const label = placeholder.label || field;
                
                // Check if we have data for this field using the same logic as generateContract
                const value = getValueForField(field);
                
                if (!value) {
                    missing.push({
                        field: field,
                        label: label,
                        sampleData: placeholder.sampleData || ''
                    });
                }
            });
            
            return missing;
        }

        function showMissingFieldsForm() {
            hideAllSections();
            document.getElementById('missingFieldsForm').style.display = 'block';
            
            const container = document.getElementById('missingFieldsList');
            container.innerHTML = '';
            
            missingFields.forEach((field, index) => {
                const div = document.createElement('div');
                div.className = 'mb-3';
                div.innerHTML = `
                    <label class="form-label">
                        ${field.label}
                        <span class="text-danger">*</span>
                    </label>
                    <input type="text" 
                           class="form-control missing-field" 
                           id="field_${field.field}"
                           placeholder="${field.sampleData || 'Nh·∫≠p ' + field.label}"
                           data-field="${field.field}">
                `;
                container.appendChild(div);
            });
        }

        function submitMissingFields() {
            // Collect values from form
            let allFilled = true;
            
            missingFields.forEach(field => {
                const input = document.getElementById(`field_${field.field}`);
                const value = input.value.trim();
                
                if (value) {
                    filledData[field.field] = value;
                    input.classList.remove('missing-field');
                    input.classList.add('field-filled');
                } else {
                    allFilled = false;
                    input.classList.add('is-invalid');
                }
            });
            
            if (!allFilled) {
                addBotMessage('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c th√¥ng tin c√≤n thi·∫øu.');
                return;
            }
            
            addBotMessage('‚úÖ ƒê√£ nh·∫≠n ƒë·ªß th√¥ng tin! ƒêang t·∫°o h·ª£p ƒë·ªìng...');
            generateContract();
        }

        function generateContract() {
            if (!selectedContract) return;
            
            document.getElementById('defaultState').style.display = 'none';
            document.getElementById('contractSelection').style.display = 'none';
            document.getElementById('missingFieldsForm').style.display = 'none';
            document.getElementById('contractPreviewSection').style.display = 'block';
            
            let content = selectedContract.modified_content || selectedContract.template || '';
            
            console.log('=== GENERATE CONTRACT ===');
            console.log('FilledData:', filledData);
            
            // Only replace placeholders that admin has configured
            // Method 1: Replace placeholder spans with data-field attribute
            content = content.replace(/<span[^>]*class="[^"]*placeholder-inline[^"]*"[^>]*data-field="([^"]+)"[^>]*>[\s\S]*?<\/span>/gi, 
                (match, field) => {
                    // Only replace if we have data for this exact field
                    const value = getValueForField(field);
                    console.log(`Field "${field}" => Value "${value}"`);
                    
                    if (value) {
                        // Replace with actual value, keep original text style (no color change)
                        return escapeHtml(value);
                    } else {
                        // Keep placeholder visible if no data
                        return `[${field}]`;
                    }
                }
            );
            
            // Method 2: Replace {{field}} syntax in template
            content = content.replace(/\{\{([^}]+)\}\}/g, (match, field) => {
                const value = getValueForField(field.trim());
                if (value) {
                    return escapeHtml(value);
                }
                return `[${field.trim()}]`;
            });
            
            document.getElementById('contractPreview').innerHTML = content || '<p class="text-muted">Kh√¥ng c√≥ n·ªôi dung h·ª£p ƒë·ªìng</p>';
            
            addBotMessage(`üéâ H·ª£p ƒë·ªìng **${selectedContract.name}** ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!

B·∫°n c√≥ th·ªÉ:
‚Ä¢ Xem tr∆∞·ªõc b√™n ph·∫£i
‚Ä¢ T·∫£i xu·ªëng file Word
‚Ä¢ In tr·ª±c ti·∫øp

C·∫ßn t√¥i gi√∫p g√¨ th√™m kh√¥ng?`);
        }

        // Get value for a specific field from extracted data
        function getValueForField(field) {
            if (!field) return null;
            
            console.log(`Looking for field: "${field}"`);
            
            // 1. Exact match first
            if (filledData[field]) {
                console.log(`  -> Exact match found: ${filledData[field]}`);
                return filledData[field];
            }
            
            // 2. Case-insensitive match
            const fieldLower = field.toLowerCase();
            for (const [key, value] of Object.entries(filledData)) {
                if (key.toLowerCase() === fieldLower) {
                    console.log(`  -> Case-insensitive match: ${key} = ${value}`);
                    return value;
                }
            }
            
            // 3. Try common field name mappings
            // Extract party identifier from field (e.g., fullname_ben_a -> party A)
            const partyMatch = field.match(/[_-](ben[_-]?)?([ab])$/i);
            const party = partyMatch ? partyMatch[2].toUpperCase() : null;
            
            // Get base field name without party suffix
            const baseField = field.replace(/[_-](ben[_-]?)?[ab]$/i, '').toLowerCase();
            
            console.log(`  -> Base field: "${baseField}", Party: "${party}"`);
            
            // Map of field aliases
            const aliases = {
                'fullname': ['fullname', 'hovaten', 'hoten', 'name', 'ten'],
                'birthday': ['birthday', 'ngaysinh', 'dob', 'birthdate'],
                'idcard': ['idcard', 'cccd', 'cmnd', 'id', 'socccd', 'socmnd'],
                'address': ['address', 'diachi', 'thuongtru', 'noio', 'dktt'],
                'issue_date': ['issue_date', 'ngaycap', 'issuedate'],
                'expiry_date': ['expiry_date', 'ngayhethan', 'expirydate'],
                'phone': ['phone', 'dienthoai', 'sdt', 'mobile'],
                'email': ['email', 'mail']
            };
            
            // Find which category this field belongs to
            let matchedCategory = null;
            for (const [category, aliasList] of Object.entries(aliases)) {
                if (aliasList.some(a => baseField.includes(a) || a.includes(baseField))) {
                    matchedCategory = category;
                    break;
                }
            }
            
            if (matchedCategory) {
                console.log(`  -> Matched category: ${matchedCategory}`);
                
                // Look for data with this category and party
                for (const [key, value] of Object.entries(filledData)) {
                    const keyLower = key.toLowerCase();
                    const keyPartyMatch = key.match(/[_-]([ab])$/i);
                    const keyParty = keyPartyMatch ? keyPartyMatch[1].toUpperCase() : null;
                    const keyBase = key.replace(/[_-][ab]$/i, '').toLowerCase();
                    
                    // Check if this key matches our category
                    const keyMatchesCategory = aliases[matchedCategory].some(a => 
                        keyBase.includes(a) || a.includes(keyBase)
                    );
                    
                    if (keyMatchesCategory) {
                        // If field specifies a party, match party
                        if (party && keyParty && party === keyParty) {
                            console.log(`  -> Found with party match: ${key} = ${value}`);
                            return value;
                        }
                        // If no party specified in field, return first match
                        if (!party) {
                            console.log(`  -> Found without party: ${key} = ${value}`);
                            return value;
                        }
                    }
                }
            }
            
            console.log(`  -> No match found for: ${field}`);
            return null;
        }

        function clearChat() {
            if (confirm('X√≥a to√†n b·ªô l·ªãch s·ª≠ chat?')) {
                document.getElementById('chatContainer').innerHTML = '';
                chatHistory = [];
                selectedContract = null;
                previewingContract = null;
                missingFields = [];
                selectedTransactionType = '';
                selectedTransactionText = '';
                document.getElementById('transactionType').value = '';
                
                hideAllSections();
                document.getElementById('defaultState').style.display = 'block';
                
                showDefaultWelcome();
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('vi-VN');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function downloadContract() {
            if (!selectedContract) return;
            
            const content = document.getElementById('contractPreview').innerHTML;
            
            // Create HTML document
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${selectedContract.name}</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; font-size: 14pt; line-height: 1.5; margin: 40px; }
                        .placeholder-inline { background: none; color: inherit; padding: 0; }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `;
            
            const blob = new Blob([html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${selectedContract.name}.doc`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function printContract() {
            const content = document.getElementById('contractPreview').innerHTML;
            
            const printWindow = window.open('', '', 'height=800,width=600');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${selectedContract?.name || 'H·ª£p ƒë·ªìng'}</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; font-size: 14pt; line-height: 1.5; margin: 40px; }
                        .placeholder-inline { background: none; color: inherit; padding: 0; }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>
