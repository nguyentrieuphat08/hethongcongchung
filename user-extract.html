<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trích xuất Thông tin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .sidebar {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .nav-link.active {
            background-color: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        .main-content {
            background-color: #f8f9fa;
        }
        .party-card {
            border-left: 4px solid #667eea;
            background-color: #f0f4ff;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }
        .image-item {
            position: relative;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            height: 120px;
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-item .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
        }
        .image-item .image-label {
            position: absolute;
            bottom: 4px;
            left: 4px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .add-image-btn {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f8f9fa;
        }
        .add-image-btn:hover {
            border-color: #667eea;
            background-color: #fff;
        }
        .party-badge {
            background-color: #e7f3ff;
            color: #0066cc;
            padding: 8px 16px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .party-badge .remove-party {
            color: #dc3545;
            cursor: pointer;
            font-size: 18px;
        }
        .party-badge .remove-party:hover {
            color: #bb2d3b;
        }
    </style>
    <script src="js/auth.js"></script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar text-white p-0" id="sidebarMenu">
                <!-- Menu will be generated by JS -->
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4 main-content">
                <!-- Header -->
                <div class="bg-white rounded shadow-sm p-4 mb-4">
                    <h3 class="mb-2">
                        <i class="bi bi-file-text-fill text-primary me-2"></i>
                        Hệ thống Trích xuất Thông tin Giấy tờ
                    </h3>
                    <p class="text-muted mb-0">Upload ảnh giấy tờ bất kỳ để tự động trích xuất thông tin</p>
                </div>

                <!-- Quản lý Đương sự -->
                <div class="bg-white rounded shadow-sm p-4 mb-4">
                    <h5 class="mb-3">
                        <i class="bi bi-people-fill text-primary me-2"></i>
                        Quản lý Đương sự
                    </h5>
                    
                    <!-- Chọn nhanh -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Chọn nhanh:</label>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-outline-primary" onclick="setDefaultParties(2)">2 đương sự</button>
                            <button class="btn btn-outline-primary" onclick="setDefaultParties(3)">3 đương sự</button>
                            <button class="btn btn-outline-primary" onclick="setDefaultParties(4)">4 đương sự</button>
                            <button class="btn btn-outline-primary" onclick="setDefaultParties(5)">5 đương sự</button>
                        </div>
                    </div>

                    <!-- Danh sách đương sự -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Danh sách hiện tại:</label>
                        <div id="partiesList" class="d-flex gap-2 flex-wrap"></div>
                    </div>

                    <!-- Thêm đương sự mới -->
                    <div>
                        <label class="form-label fw-semibold">Thêm đương sự tùy chỉnh:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newPartyInput" 
                                   placeholder="Nhập tên đương sự (VD: A1, B2, C...)"
                                   onkeypress="if(event.key==='Enter') addParty()">
                            <button class="btn btn-primary" onclick="addParty()">
                                <i class="bi bi-plus-lg me-1"></i>Thêm
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab chọn loại giấy tờ -->
                <div class="bg-white rounded shadow-sm p-4 mb-4">
                    <h5 class="mb-3">
                        <i class="bi bi-file-earmark-fill text-primary me-2"></i>
                        Loại giấy tờ
                    </h5>
                    <ul class="nav nav-tabs" role="tablist" id="documentTypeTabs">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="cccd-tab" data-bs-toggle="tab" data-bs-target="#cccd-content" type="button" role="tab">
                                <i class="bi bi-card-list me-2"></i>CCCD/CMND
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="other-tab" data-bs-toggle="tab" data-bs-target="#other-content" type="button" role="tab">
                                <i class="bi bi-file-earmark me-2"></i>Các loại giấy tờ khác
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Upload ảnh CCCD -->
                <div class="bg-white rounded shadow-sm p-4 mb-4">
                    <div class="tab-content" id="documentTypeContent">
                        <!-- Tab 1: CCCD -->
                        <div class="tab-pane fade show active" id="cccd-content" role="tabpanel">
                            <h5 class="mb-3">
                                <i class="bi bi-cloud-upload-fill text-primary me-2"></i>
                                Upload ảnh CCCD/CMND
                            </h5>
                            <div id="uploadAreaCCCD"></div>

                            <div class="d-flex gap-2 mt-4">
                                <button class="btn btn-primary" onclick="extractAllInfoCCCD()" id="extractBtnCCCD" disabled>
                                    <i class="bi bi-gear-fill me-2"></i>TRÍCH XUẤT THÔNG TIN
                                </button>
                                <button class="btn btn-secondary" onclick="clearAllCCCD()">
                                    <i class="bi bi-trash-fill me-2"></i>XÓA TẤT CẢ
                                </button>
                            </div>
                        </div>

                        <!-- Tab 2: Các loại giấy tờ khác -->
                        <div class="tab-pane fade" id="other-content" role="tabpanel">
                            <h5 class="mb-3">
                                <i class="bi bi-cloud-upload-fill text-primary me-2"></i>
                                Upload ảnh Giấy tờ
                            </h5>
                            <div id="uploadAreaOther"></div>

                            <div class="d-flex gap-2 mt-4">
                                <button class="btn btn-primary" onclick="extractAllInfoOther()" id="extractBtnOther" disabled>
                                    <i class="bi bi-gear-fill me-2"></i>TRÍCH XUẤT THÔNG TIN
                                </button>
                                <button class="btn btn-secondary" onclick="clearAllOther()">
                                    <i class="bi bi-trash-fill me-2"></i>XÓA TẤT CẢ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thông tin đã trích xuất -->
                <div class="bg-white rounded shadow-sm p-4">
                    <h5 class="mb-3">
                        <i class="bi bi-file-earmark-text-fill text-primary me-2"></i>
                        Thông tin đã trích xuất
                    </h5>
                    
                    <!-- Tab kết quả -->
                    <ul class="nav nav-tabs mb-3" role="tablist" id="resultTabs">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="result-cccd-tab" data-bs-toggle="tab" data-bs-target="#result-cccd-content" type="button" role="tab">
                                <i class="bi bi-card-list me-2"></i>CCCD/CMND
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="result-other-tab" data-bs-toggle="tab" data-bs-target="#result-other-content" type="button" role="tab">
                                <i class="bi bi-file-earmark me-2"></i>Các loại giấy tờ khác
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="resultContent">
                        <!-- CCCD Results -->
                        <div class="tab-pane fade show active" id="result-cccd-content" role="tabpanel">
                            <div id="extractedInfoCCCD">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Chưa có thông tin nào được trích xuất. Vui lòng upload đầy đủ ảnh CCCD và nhấn "Trích xuất thông tin".
                                </div>
                            </div>

                            <div id="extractedDetailsCCCD" style="display: none;">
                                <div id="extractedDataContainerCCCD"></div>
                                
                                <div class="d-flex gap-2 mt-4">
                                    <button class="btn btn-success" onclick="downloadDataCCCD()">
                                        <i class="bi bi-download me-2"></i>Tải xuống
                                    </button>
                                    <button class="btn btn-primary" onclick="printDataCCCD()">
                                        <i class="bi bi-printer-fill me-2"></i>In
                                    </button>
                                    <button class="btn btn-info" onclick="goToCreateContract()">
                                        <i class="bi bi-file-earmark-plus me-2"></i>Tạo hợp đồng
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Other Documents Results -->
                        <div class="tab-pane fade" id="result-other-content" role="tabpanel">
                            <div id="extractedInfoOther">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Chưa có thông tin nào được trích xuất. Vui lòng upload ảnh giấy tờ và nhấn "Trích xuất thông tin".
                                </div>
                            </div>

                            <div id="extractedDetailsOther" style="display: none;">
                                <div id="extractedDataContainerOther"></div>
                                
                                <div class="d-flex gap-2 mt-4">
                                    <button class="btn btn-success" onclick="downloadDataOther()">
                                        <i class="bi bi-download me-2"></i>Tải xuống
                                    </button>
                                    <button class="btn btn-primary" onclick="printDataOther()">
                                        <i class="bi bi-printer-fill me-2"></i>In
                                    </button>
                                    <button class="btn btn-info" onclick="goToCreateContract()">
                                        <i class="bi bi-file-earmark-plus me-2"></i>Tạo hợp đồng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // N8N API Configuration
        const N8N_EXTRACT_API_CCCD = 'https://demo.vnlawai.com/webhook/cccd';
        const N8N_EXTRACT_API_OTHER = 'https://demo.vnlawai.com/webhook/giaytokhac';

        // State management - CCCD
        // Structure: {party: [person1, person2, ...]}
        let partiesCCCD = {A: [1], B: [1]};
        let imagesCCCD = {}; // Key: "A_1", "A_2", "B_1"...
        let extractedDataCCCD = {};

        // State management - Other documents  
        let partiesOther = {A: [1], B: [1]};
        let imagesOther = {};
        let extractedDataOther = {};

        // Helper to get all party-person keys
        function getPartyPersonKeys(parties) {
            const keys = [];
            Object.entries(parties).forEach(([party, persons]) => {
                persons.forEach(person => {
                    keys.push(`${party}_${person}`);
                });
            });
            return keys;
        }

        // Initialize
        window.addEventListener('load', () => {
            // Check auth and generate sidebar
            if (!initPage('user-extract')) return;
            document.getElementById('sidebarMenu').innerHTML = generateSidebar('user-extract');
            
            renderParties();
            renderUploadAreaCCCD();
            renderUploadAreaOther();
        });

        // ========== SHARED FUNCTIONS ==========
        function renderParties() {
            const container = document.getElementById('partiesList');
            container.innerHTML = '';
            
            Object.entries(partiesCCCD).forEach(([party, persons]) => {
                const partyDiv = document.createElement('div');
                partyDiv.className = 'd-flex flex-column gap-1 mb-2';
                
                // Party header with add person button
                const headerDiv = document.createElement('div');
                headerDiv.className = 'd-flex align-items-center gap-2';
                headerDiv.innerHTML = `
                    <span class="party-badge">
                        <span class="fw-semibold">Đương sự ${party}</span>
                        <span class="remove-party" onclick="removeParty('${party}')" title="Xóa đương sự">×</span>
                    </span>
                    <button class="btn btn-sm btn-outline-success" onclick="addPerson('${party}')" title="Thêm người">
                        <i class="bi bi-person-plus"></i>
                    </button>
                `;
                partyDiv.appendChild(headerDiv);
                
                // List of persons
                if (persons.length > 1) {
                    const personsDiv = document.createElement('div');
                    personsDiv.className = 'd-flex gap-1 flex-wrap ms-3';
                    persons.forEach(person => {
                        personsDiv.innerHTML += `
                            <span class="badge bg-light text-dark border">
                                Người ${person}
                                ${persons.length > 1 ? `<span class="text-danger ms-1" style="cursor:pointer" onclick="removePerson('${party}', ${person})">×</span>` : ''}
                            </span>
                        `;
                    });
                    partyDiv.appendChild(personsDiv);
                }
                
                container.appendChild(partyDiv);
            });
        }

        function addPerson(party) {
            const maxPerson = Math.max(...partiesCCCD[party], 0);
            partiesCCCD[party].push(maxPerson + 1);
            partiesOther[party] = [...partiesCCCD[party]];
            renderParties();
            renderUploadAreaCCCD();
            renderUploadAreaOther();
        }

        function removePerson(party, person) {
            if (partiesCCCD[party].length <= 1) {
                alert('Phải có ít nhất 1 người trong mỗi đương sự!');
                return;
            }
            if (confirm(`Xóa Người ${person} của Đương sự ${party}?`)) {
                partiesCCCD[party] = partiesCCCD[party].filter(p => p !== person);
                partiesOther[party] = [...partiesCCCD[party]];
                const key = `${party}_${person}`;
                delete imagesCCCD[key];
                delete imagesOther[key];
                delete extractedDataCCCD[key];
                delete extractedDataOther[key];
                renderParties();
                renderUploadAreaCCCD();
                renderUploadAreaOther();
            }
        }

        function setDefaultParties(num) {
            partiesCCCD = {};
            partiesOther = {};
            for (let i = 0; i < num; i++) {
                const party = String.fromCharCode(65 + i);
                partiesCCCD[party] = [1];
                partiesOther[party] = [1];
            }
            imagesCCCD = {};
            imagesOther = {};
            extractedDataCCCD = {};
            extractedDataOther = {};
            renderParties();
            renderUploadAreaCCCD();
            renderUploadAreaOther();
            hideAllExtractedData();
        }

        function addParty() {
            const input = document.getElementById('newPartyInput');
            const newParty = input.value.trim().toUpperCase();
            
            if (!newParty) {
                alert('Vui lòng nhập tên đương sự!');
                return;
            }
            
            if (partiesCCCD[newParty]) {
                alert('Tên đương sự đã tồn tại!');
                return;
            }
            
            partiesCCCD[newParty] = [1];
            partiesOther[newParty] = [1];
            input.value = '';
            renderParties();
            renderUploadAreaCCCD();
            renderUploadAreaOther();
        }

        function removeParty(party) {
            if (Object.keys(partiesCCCD).length <= 1) {
                alert('Phải có ít nhất 1 đương sự!');
                return;
            }
            
            if (confirm(`Bạn có chắc muốn xóa đương sự ${party} và tất cả người trong đó?`)) {
                // Remove all person keys for this party
                partiesCCCD[party].forEach(person => {
                    const key = `${party}_${person}`;
                    delete imagesCCCD[key];
                    delete imagesOther[key];
                    delete extractedDataCCCD[key];
                    delete extractedDataOther[key];
                });
                delete partiesCCCD[party];
                delete partiesOther[party];
                renderParties();
                renderUploadAreaCCCD();
                renderUploadAreaOther();
            }
        }

        // ========== CCCD FUNCTIONS ==========
        function renderUploadAreaCCCD() {
            const container = document.getElementById('uploadAreaCCCD');
            container.innerHTML = '';
            
            Object.entries(partiesCCCD).forEach(([party, persons]) => {
                const partySection = document.createElement('div');
                partySection.className = 'mb-4';
                
                const partyHeader = document.createElement('h6');
                partyHeader.className = 'fw-bold text-primary mb-3';
                partyHeader.innerHTML = `<i class="bi bi-people-fill me-2"></i>Đương sự ${party}`;
                partySection.appendChild(partyHeader);
                
                persons.forEach(person => {
                    const key = `${party}_${person}`;
                    const personCard = document.createElement('div');
                    personCard.className = 'party-card p-3 rounded mb-2';
                    
                    const header = document.createElement('div');
                    header.className = 'd-flex justify-content-between align-items-center mb-3';
                    header.innerHTML = `
                        <span class="fw-semibold">
                            <i class="bi bi-person-fill me-1"></i>
                            ${persons.length > 1 ? `Người ${person}` : `Đương sự ${party}`}
                        </span>
                        <span class="badge bg-primary">${imagesCCCD[key] ? imagesCCCD[key].length : 0} ảnh</span>
                    `;
                    
                    const imageGrid = document.createElement('div');
                    imageGrid.className = 'image-grid';
                    imageGrid.id = `imageGridCCCD_${key}`;
                    
                    personCard.appendChild(header);
                    personCard.appendChild(imageGrid);
                    partySection.appendChild(personCard);
                    
                    container.appendChild(partySection);
                    renderImagesCCCD(key);
                });
            });
            
            updateExtractButtonCCCD();
        }

        function renderImagesCCCD(key) {
            const grid = document.getElementById(`imageGridCCCD_${key}`);
            if (!grid) return;
            
            grid.innerHTML = '';
            const images = imagesCCCD[key] || [];
            
            images.forEach((image, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.innerHTML = `
                    <img src="${image.dataUrl}" alt="Ảnh ${index + 1}">
                    <button class="btn btn-sm btn-danger remove-btn" onclick="removeImageCCCD('${key}', ${index})">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <div class="image-label">Ảnh ${index + 1}</div>
                `;
                grid.appendChild(imageItem);
            });
            
            const addBtn = document.createElement('label');
            addBtn.className = 'add-image-btn';
            addBtn.innerHTML = `
                <input type="file" style="display: none;" onchange="handleImageUploadCCCD('${key}', this)">
                <div class="text-center">
                    <i class="bi bi-plus-lg" style="font-size: 24px; color: #6c757d;"></i>
                    <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">Thêm ảnh</div>
                </div>
            `;
            grid.appendChild(addBtn);
        }

        function handleImageUploadCCCD(key, input) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                alert('File quá lớn! Vui lòng chọn file nhỏ hơn 10MB.');
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (!imagesCCCD[key]) {
                    imagesCCCD[key] = [];
                }
                
                imagesCCCD[key].push({
                    file: file,
                    dataUrl: e.target.result,
                    base64: e.target.result.split(',')[1]
                });
                
                renderImagesCCCD(key);
                updateExtractButtonCCCD();
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        function removeImageCCCD(key, index) {
            if (imagesCCCD[key]) {
                imagesCCCD[key].splice(index, 1);
                if (imagesCCCD[key].length === 0) {
                    delete imagesCCCD[key];
                }
                renderImagesCCCD(key);
                updateExtractButtonCCCD();
            }
        }

        function updateExtractButtonCCCD() {
            const extractBtn = document.getElementById('extractBtnCCCD');
            const keys = getPartyPersonKeys(partiesCCCD);
            const canExtract = keys.some(key => imagesCCCD[key] && imagesCCCD[key].length >= 1);
            extractBtn.disabled = !canExtract;
        }

        async function extractAllInfoCCCD() {
            const extractBtn = document.getElementById('extractBtnCCCD');
            extractBtn.disabled = true;
            extractBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...';
            
            try {
                extractedDataCCCD = {};
                const keys = getPartyPersonKeys(partiesCCCD);
                
                for (const key of keys) {
                    const keyImages = imagesCCCD[key] || [];
                    
                    if (keyImages.length >= 1) {
                        const data = await callN8nExtractAPI(key, keyImages, 'CCCD');
                        extractedDataCCCD[key] = data;
                    }
                }
                
                if (Object.keys(extractedDataCCCD).length === 0) {
                    alert('Vui lòng upload ít nhất 1 ảnh!');
                } else {
                    displayExtractedDataCCCD();
                }
            } catch (error) {
                console.error('Error extracting info:', error);
                alert('Lỗi khi trích xuất thông tin: ' + error.message);
            } finally {
                extractBtn.disabled = false;
                extractBtn.innerHTML = '<i class="bi bi-gear-fill me-2"></i>TRÍCH XUẤT THÔNG TIN';
            }
        }

        function displayExtractedDataCCCD() {
            const container = document.getElementById('extractedDataContainerCCCD');
            container.innerHTML = '';
            
            Object.entries(partiesCCCD).forEach(([party, persons]) => {
                persons.forEach(person => {
                    const key = `${party}_${person}`;
                    if (extractedDataCCCD[key]) {
                        const data = extractedDataCCCD[key];
                        const card = document.createElement('div');
                        card.className = 'border rounded p-3 mb-3';
                        
                        // Determine display name
                        const displayName = persons.length > 1 
                            ? `Đương sự ${party} - Người ${person}`
                            : `Đương sự ${party}`;
                        
                        card.innerHTML = `
                            <h6 class="fw-bold text-success mb-3">
                                <i class="bi bi-check-circle-fill me-2"></i>Thông tin ${displayName}
                            </h6>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-muted">Họ và tên:</label>
                                    <input type="text" class="form-control form-control-sm" value="${data.fullname || ''}" readonly>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-muted">Ngày sinh:</label>
                                    <input type="text" class="form-control form-control-sm" value="${data.birthday || ''}" readonly>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-muted">Số CMND/CCCD:</label>
                                    <input type="text" class="form-control form-control-sm" value="${data.idcard || ''}" readonly>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-muted">Ngày cấp:</label>
                                    <input type="text" class="form-control form-control-sm" value="${data.issue_date || ''}" readonly>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-muted">Cơ quan cấp:</label>
                                    <input type="text" class="form-control form-control-sm" value="${data.issuing_authority || ''}" readonly>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-muted">Ngày hết hạn:</label>
                                    <input type="text" class="form-control form-control-sm" value="${data.expiry_date || ''}" readonly>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-muted">Địa chỉ:</label>
                                    <input type="text" class="form-control form-control-sm" value="${data.address || ''}" readonly>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    }
                });
            });
            
            document.getElementById('extractedInfoCCCD').style.display = 'none';
            document.getElementById('extractedDetailsCCCD').style.display = 'block';
        }

        function clearAllCCCD() {
            if (confirm('Bạn có chắc muốn xóa tất cả dữ liệu?')) {
                imagesCCCD = {};
                extractedDataCCCD = {};
                renderUploadAreaCCCD();
                hideExtractedDataCCCD();
            }
        }

        function hideExtractedDataCCCD() {
            document.getElementById('extractedInfoCCCD').style.display = 'block';
            document.getElementById('extractedDetailsCCCD').style.display = 'none';
        }

        function downloadDataCCCD() {
            if (Object.keys(extractedDataCCCD).length === 0) return;
            
            const dataStr = JSON.stringify(extractedDataCCCD, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'thong-tin-cccd-' + Date.now() + '.json';
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function printDataCCCD() {
            if (Object.keys(extractedDataCCCD).length === 0) return;
            
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Thông tin CCCD</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="container mt-4">');
            printWindow.document.write('<h2>Thông tin CCCD/CMND</h2>');
            
            Object.entries(partiesCCCD).forEach(([party, persons]) => {
                persons.forEach(person => {
                    const key = `${party}_${person}`;
                    if (extractedDataCCCD[key]) {
                        const data = extractedDataCCCD[key];
                        const displayName = persons.length > 1 
                            ? `Đương sự ${party} - Người ${person}`
                            : `Đương sự ${party}`;
                        printWindow.document.write(`<h4 class="mt-4">${displayName}</h4>`);
                        printWindow.document.write('<table class="table table-bordered">');
                        printWindow.document.write('<tr><th>Họ và tên</th><td>' + (data.fullname || '') + '</td></tr>');
                        printWindow.document.write('<tr><th>Ngày sinh</th><td>' + (data.birthday || '') + '</td></tr>');
                        printWindow.document.write('<tr><th>Số CMND/CCCD</th><td>' + (data.idcard || '') + '</td></tr>');
                        printWindow.document.write('<tr><th>Ngày cấp</th><td>' + (data.issue_date || '') + '</td></tr>');
                        printWindow.document.write('<tr><th>Cơ quan cấp</th><td>' + (data.issuing_authority || '') + '</td></tr>');
                        printWindow.document.write('<tr><th>Ngày hết hạn</th><td>' + (data.expiry_date || '') + '</td></tr>');
                        printWindow.document.write('<tr><th>Địa chỉ</th><td>' + (data.address || '') + '</td></tr>');
                        printWindow.document.write('</table>');
                    }
                });
            });
            
            printWindow.document.write('</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        // ========== OTHER DOCUMENTS FUNCTIONS ==========
        function renderUploadAreaOther() {
            const container = document.getElementById('uploadAreaOther');
            container.innerHTML = '';
            
            Object.entries(partiesOther).forEach(([party, persons]) => {
                const partySection = document.createElement('div');
                partySection.className = 'mb-4';
                
                const partyHeader = document.createElement('h6');
                partyHeader.className = 'fw-bold text-primary mb-3';
                partyHeader.innerHTML = `<i class="bi bi-people-fill me-2"></i>Đương sự ${party}`;
                partySection.appendChild(partyHeader);
                
                persons.forEach(person => {
                    const key = `${party}_${person}`;
                    const personCard = document.createElement('div');
                    personCard.className = 'party-card p-3 rounded mb-2';
                    
                    const header = document.createElement('div');
                    header.className = 'd-flex justify-content-between align-items-center mb-3';
                    header.innerHTML = `
                        <span class="fw-semibold">
                            <i class="bi bi-person-fill me-1"></i>
                            ${persons.length > 1 ? `Người ${person}` : `Đương sự ${party}`}
                        </span>
                        <span class="badge bg-primary">${imagesOther[key] ? imagesOther[key].length : 0} ảnh</span>
                    `;
                    
                    const imageGrid = document.createElement('div');
                    imageGrid.className = 'image-grid';
                    imageGrid.id = `imageGridOther_${key}`;
                    
                    personCard.appendChild(header);
                    personCard.appendChild(imageGrid);
                    partySection.appendChild(personCard);
                    
                    container.appendChild(partySection);
                    renderImagesOther(key);
                });
            });
            
            updateExtractButtonOther();
        }

        function renderImagesOther(key) {
            const grid = document.getElementById(`imageGridOther_${key}`);
            if (!grid) return;
            
            grid.innerHTML = '';
            const images = imagesOther[key] || [];
            
            images.forEach((image, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.innerHTML = `
                    <img src="${image.dataUrl}" alt="Ảnh ${index + 1}">
                    <button class="btn btn-sm btn-danger remove-btn" onclick="removeImageOther('${key}', ${index})">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <div class="image-label">Ảnh ${index + 1}</div>
                `;
                grid.appendChild(imageItem);
            });
            
            const addBtn = document.createElement('label');
            addBtn.className = 'add-image-btn';
            addBtn.innerHTML = `
                <input type="file" style="display: none;" onchange="handleImageUploadOther('${key}', this)">
                <div class="text-center">
                    <i class="bi bi-plus-lg" style="font-size: 24px; color: #6c757d;"></i>
                    <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">Thêm ảnh</div>
                </div>
            `;
            grid.appendChild(addBtn);
        }

        function handleImageUploadOther(key, input) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                alert('File quá lớn! Vui lòng chọn file nhỏ hơn 10MB.');
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (!imagesOther[key]) {
                    imagesOther[key] = [];
                }
                
                imagesOther[key].push({
                    file: file,
                    dataUrl: e.target.result,
                    base64: e.target.result.split(',')[1]
                });
                
                renderImagesOther(key);
                updateExtractButtonOther();
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        function removeImageOther(key, index) {
            if (imagesOther[key]) {
                imagesOther[key].splice(index, 1);
                if (imagesOther[key].length === 0) {
                    delete imagesOther[key];
                }
                renderImagesOther(key);
                updateExtractButtonOther();
            }
        }

        function updateExtractButtonOther() {
            const extractBtn = document.getElementById('extractBtnOther');
            const keys = getPartyPersonKeys(partiesOther);
            const canExtract = keys.some(key => imagesOther[key] && imagesOther[key].length >= 1);
            extractBtn.disabled = !canExtract;
        }

        async function extractAllInfoOther() {
            const extractBtn = document.getElementById('extractBtnOther');
            extractBtn.disabled = true;
            extractBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...';
            
            try {
                extractedDataOther = {};
                const keys = getPartyPersonKeys(partiesOther);
                
                for (const key of keys) {
                    const keyImages = imagesOther[key] || [];
                    
                    if (keyImages.length >= 1) {
                        const data = await callN8nExtractAPI(key, keyImages, 'OTHER');
                        extractedDataOther[key] = data;
                    }
                }
                
                if (Object.keys(extractedDataOther).length === 0) {
                    alert('Vui lòng upload ít nhất 1 ảnh!');
                } else {
                    displayExtractedDataOther();
                }
            } catch (error) {
                console.error('Error extracting info:', error);
                alert('Lỗi khi trích xuất thông tin: ' + error.message);
            } finally {
                extractBtn.disabled = false;
                extractBtn.innerHTML = '<i class="bi bi-gear-fill me-2"></i>TRÍCH XUẤT THÔNG TIN';
            }
        }

        function displayExtractedDataOther() {
            const container = document.getElementById('extractedDataContainerOther');
            container.innerHTML = '';
            
            Object.entries(partiesOther).forEach(([party, persons]) => {
                persons.forEach(person => {
                    const key = `${party}_${person}`;
                    if (extractedDataOther[key]) {
                        const data = extractedDataOther[key];
                        const card = document.createElement('div');
                        card.className = 'border rounded p-3 mb-3';
                        
                        // Determine display name
                        const displayName = persons.length > 1 
                            ? `Đương sự ${party} - Người ${person}`
                            : `Đương sự ${party}`;
                        
                        let fieldHTML = `
                            <h6 class="fw-bold text-success mb-3">
                                <i class="bi bi-check-circle-fill me-2"></i>Thông tin ${displayName}
                            </h6>
                            <div class="row">
                        `;
                        
                        // Dynamic fields from n8n response
                        Object.entries(data).forEach(([key, value]) => {
                            // Convert camelCase or snake_case to readable label
                            const label = key
                                .replace(/([A-Z])/g, ' $1')
                                .replace(/_/g, ' ')
                                .replace(/^./, str => str.toUpperCase());
                            
                            fieldHTML += `
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-muted">${label}:</label>
                                    <input type="text" class="form-control form-control-sm" value="${value || ''}" readonly>
                                </div>
                            `;
                        });
                        
                        fieldHTML += '</div>';
                        card.innerHTML = fieldHTML;
                        container.appendChild(card);
                    }
                });
            });
            
            document.getElementById('extractedInfoOther').style.display = 'none';
            document.getElementById('extractedDetailsOther').style.display = 'block';
        }

        function clearAllOther() {
            if (confirm('Bạn có chắc muốn xóa tất cả dữ liệu?')) {
                imagesOther = {};
                extractedDataOther = {};
                renderUploadAreaOther();
                hideExtractedDataOther();
            }
        }

        function hideExtractedDataOther() {
            document.getElementById('extractedInfoOther').style.display = 'block';
            document.getElementById('extractedDetailsOther').style.display = 'none';
        }

        function downloadDataOther() {
            if (Object.keys(extractedDataOther).length === 0) return;
            
            const dataStr = JSON.stringify(extractedDataOther, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'thong-tin-giay-to-' + Date.now() + '.json';
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function printDataOther() {
            if (Object.keys(extractedDataOther).length === 0) return;
            
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Thông tin Giấy tờ</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="container mt-4">');
            printWindow.document.write('<h2>Thông tin Giấy tờ</h2>');
            
            partiesOther.forEach(party => {
                if (extractedDataOther[party]) {
                    const data = extractedDataOther[party];
                    printWindow.document.write(`<h4 class="mt-4">Đương sự ${party}</h4>`);
                    printWindow.document.write('<table class="table table-bordered">');
                    
                    Object.entries(data).forEach(([key, value]) => {
                        const label = key
                            .replace(/([A-Z])/g, ' $1')
                            .replace(/_/g, ' ')
                            .replace(/^./, str => str.toUpperCase());
                        printWindow.document.write(`<tr><th>${label}</th><td>${value || ''}</td></tr>`);
                    });
                    
                    printWindow.document.write('</table>');
                }
            });
            
            printWindow.document.write('</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        // ========== SHARED API CALL ==========
        async function callN8nExtractAPI(party, partyImages, docType = 'CCCD') {
            try {
                // Select appropriate webhook based on document type
                const apiUrl = docType === 'OTHER' ? N8N_EXTRACT_API_OTHER : N8N_EXTRACT_API_CCCD;
                
                console.log('Calling API:', apiUrl, 'DocType:', docType, 'Party:', party);
                
                // Send original images without compression
                const images = partyImages.map((img) => ({
                    name: img.file.name,
                    base64: img.base64
                }));
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        party: party,
                        documentType: docType,
                        images: images
                    })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                if (data.success === false) {
                    throw new Error(data.message || 'API returned error');
                }
                
                return data.data || data;
            } catch (error) {
                console.error('Error calling extract API:', error);
                if (error.message === 'Failed to fetch') {
                    throw new Error('Không thể kết nối đến server. Vui lòng kiểm tra: 1) Webhook đã được kích hoạt trong n8n, 2) Kết nối mạng');
                }
                throw error;
            }
        }

        // Hide all extracted data
        function hideAllExtractedData() {
            hideExtractedDataCCCD();
            hideExtractedDataOther();
        }

        // ========== SAVE & GO TO CONTRACT ==========
        function saveExtractedDataToStorage() {
            // Combine all extracted data
            const allData = {
                cccd: extractedDataCCCD,
                other: extractedDataOther,
                timestamp: new Date().toISOString()
            };
            
            // Save to sessionStorage for passing to chat page
            sessionStorage.setItem('extractedData', JSON.stringify(allData));
            
            // Also save to localStorage for persistence
            localStorage.setItem('lastExtractedData', JSON.stringify(allData));
            
            return allData;
        }

        function goToCreateContract() {
            // Check if there's any extracted data
            if (Object.keys(extractedDataCCCD).length === 0 && Object.keys(extractedDataOther).length === 0) {
                alert('Chưa có thông tin nào được trích xuất!');
                return;
            }
            
            // Save data to storage
            saveExtractedDataToStorage();
            
            // Redirect to chat page
            window.location.href = 'user-chat.html?fromExtract=true';
        }
    </script>
</body>
</html>