<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trích xuất Thông tin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .sidebar {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .nav-link.active {
            background-color: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        .main-content {
            background-color: #f8f9fa;
        }
        .party-card {
            border-left: 4px solid #667eea;
            background-color: #f0f4ff;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }
        .image-item {
            position: relative;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            height: 120px;
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-item .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
        }
        .image-item .image-label {
            position: absolute;
            bottom: 4px;
            left: 4px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .add-image-btn {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f8f9fa;
        }
        .add-image-btn:hover {
            border-color: #667eea;
            background-color: #fff;
        }
        .party-badge {
            background-color: #e7f3ff;
            color: #0066cc;
            padding: 8px 16px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .party-badge .remove-party {
            color: #dc3545;
            cursor: pointer;
            font-size: 18px;
        }
        .party-badge .remove-party:hover {
            color: #bb2d3b;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar text-white p-0">
                <div class="p-3">
                    <h4 class="mb-4">MENU</h4>
                    <div class="nav flex-column">
                        <a href="admin-contract.html" class="nav-link text-white mb-2">
                            <i class="bi bi-gear-fill me-2"></i>Quản lý Mẫu Hợp đồng
                        </a>
                        <a href="user-extract.html" class="nav-link text-white active mb-2">
                            <i class="bi bi-card-image me-2"></i>Trích xuất thông tin
                        </a>
                        <a href="user-chat.html" class="nav-link text-white mb-2">
                            <i class="bi bi-chat-dots-fill me-2"></i>Chat AI
                        </a>
                    </div>
                    <div class="mt-4 text-center">
                        <small>Phiên bản 1.0</small>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4 main-content">
                <!-- Header -->
                <div class="bg-white rounded shadow-sm p-4 mb-4">
                    <h3 class="mb-2">
                        <i class="bi bi-file-text-fill text-primary me-2"></i>
                        Hệ thống Trích xuất Thông tin CCCD
                    </h3>
                    <p class="text-muted mb-0">Upload ảnh CCCD để tự động trích xuất thông tin</p>
                </div>

                <!-- Quản lý Đương sự -->
                <div class="bg-white rounded shadow-sm p-4 mb-4">
                    <h5 class="mb-3">
                        <i class="bi bi-people-fill text-primary me-2"></i>
                        Quản lý Đương sự
                    </h5>
                    
                    <!-- Chọn nhanh -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Chọn nhanh:</label>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-outline-primary" onclick="setDefaultParties(2)">2 đương sự</button>
                            <button class="btn btn-outline-primary" onclick="setDefaultParties(3)">3 đương sự</button>
                            <button class="btn btn-outline-primary" onclick="setDefaultParties(4)">4 đương sự</button>
                            <button class="btn btn-outline-primary" onclick="setDefaultParties(5)">5 đương sự</button>
                        </div>
                    </div>

                    <!-- Danh sách đương sự -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Danh sách hiện tại:</label>
                        <div id="partiesList" class="d-flex gap-2 flex-wrap"></div>
                    </div>

                    <!-- Thêm đương sự mới -->
                    <div>
                        <label class="form-label fw-semibold">Thêm đương sự tùy chỉnh:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newPartyInput" 
                                   placeholder="Nhập tên đương sự (VD: A1, B2, C...)"
                                   onkeypress="if(event.key==='Enter') addParty()">
                            <button class="btn btn-primary" onclick="addParty()">
                                <i class="bi bi-plus-lg me-1"></i>Thêm
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Upload ảnh CCCD -->
                <div class="bg-white rounded shadow-sm p-4 mb-4">
                    <h5 class="mb-3">
                        <i class="bi bi-cloud-upload-fill text-primary me-2"></i>
                        Upload ảnh CCCD
                    </h5>
                    <div id="uploadArea"></div>

                    <div class="d-flex gap-2 mt-4">
                        <button class="btn btn-primary" onclick="extractAllInfo()" id="extractBtn" disabled>
                            <i class="bi bi-gear-fill me-2"></i>TRÍCH XUẤT THÔNG TIN
                        </button>
                        <button class="btn btn-secondary" onclick="clearAll()">
                            <i class="bi bi-trash-fill me-2"></i>XÓA TẤT CẢ
                        </button>
                    </div>
                </div>

                <!-- Thông tin đã trích xuất -->
                <div class="bg-white rounded shadow-sm p-4">
                    <h5 class="mb-3">
                        <i class="bi bi-file-earmark-text-fill text-primary me-2"></i>
                        Thông tin đã trích xuất
                    </h5>
                    
                    <div id="extractedInfo">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Chưa có thông tin nào được trích xuất. Vui lòng upload đầy đủ ảnh CCCD và nhấn "Trích xuất thông tin".
                        </div>
                    </div>

                    <div id="extractedDetails" style="display: none;">
                        <div id="extractedDataContainer"></div>
                        
                        <div class="d-flex gap-2 mt-4">
                            <button class="btn btn-success" onclick="downloadData()">
                                <i class="bi bi-download me-2"></i>Tải xuống
                            </button>
                            <button class="btn btn-primary" onclick="printData()">
                                <i class="bi bi-printer-fill me-2"></i>In
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // N8N API Configuration
        const N8N_EXTRACT_API = 'https://hethongcongchung.vercel.app/api/extract-party-info';

        // State management
        let parties = ['A', 'B'];
        let images = {};
        let extractedData = {};

        // Initialize
        window.addEventListener('load', () => {
            renderParties();
            renderUploadArea();
        });

        // Render danh sách đương sự
        function renderParties() {
            const container = document.getElementById('partiesList');
            container.innerHTML = '';
            
            parties.forEach(party => {
                const badge = document.createElement('div');
                badge.className = 'party-badge';
                badge.innerHTML = `
                    <span class="fw-semibold">Đương sự ${party}</span>
                    <span class="remove-party" onclick="removeParty('${party}')" title="Xóa">×</span>
                `;
                container.appendChild(badge);
            });
        }

        // Set default parties
        function setDefaultParties(num) {
            parties = Array.from({length: num}, (_, i) => String.fromCharCode(65 + i));
            images = {};
            extractedData = {};
            renderParties();
            renderUploadArea();
            hideExtractedData();
        }

        // Add party
        function addParty() {
            const input = document.getElementById('newPartyInput');
            const newParty = input.value.trim();
            
            if (!newParty) {
                alert('Vui lòng nhập tên đương sự!');
                return;
            }
            
            if (parties.includes(newParty)) {
                alert('Tên đương sự đã tồn tại!');
                return;
            }
            
            parties.push(newParty);
            input.value = '';
            renderParties();
            renderUploadArea();
        }

        // Remove party
        function removeParty(party) {
            if (parties.length <= 1) {
                alert('Phải có ít nhất 1 đương sự!');
                return;
            }
            
            if (confirm(`Bạn có chắc muốn xóa đương sự ${party}?`)) {
                parties = parties.filter(p => p !== party);
                delete images[party];
                delete extractedData[party];
                renderParties();
                renderUploadArea();
            }
        }

        // Render upload area
        function renderUploadArea() {
            const container = document.getElementById('uploadArea');
            container.innerHTML = '';
            
            parties.forEach(party => {
                const partyCard = document.createElement('div');
                partyCard.className = 'party-card p-3 rounded mb-3';
                
                const header = document.createElement('div');
                header.className = 'd-flex justify-content-between align-items-center mb-3';
                header.innerHTML = `
                    <h6 class="mb-0 fw-bold">Đương sự ${party}</h6>
                    <span class="badge bg-primary">${images[party] ? images[party].length : 0} ảnh</span>
                `;
                
                const imageGrid = document.createElement('div');
                imageGrid.className = 'image-grid';
                imageGrid.id = `imageGrid_${party}`;
                
                partyCard.appendChild(header);
                partyCard.appendChild(imageGrid);
                container.appendChild(partyCard);
                
                renderImages(party);
            });
            
            updateExtractButton();
        }

        // Render images for a party
        function renderImages(party) {
            const grid = document.getElementById(`imageGrid_${party}`);
            if (!grid) return;
            
            grid.innerHTML = '';
            const partyImages = images[party] || [];
            
            // Render existing images
            partyImages.forEach((image, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.innerHTML = `
                    <img src="${image.dataUrl}" alt="Ảnh ${index + 1}">
                    <button class="btn btn-sm btn-danger remove-btn" onclick="removeImage('${party}', ${index})">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <div class="image-label">Ảnh ${index + 1}</div>
                `;
                grid.appendChild(imageItem);
            });
            
            // Add button
            const addBtn = document.createElement('label');
            addBtn.className = 'add-image-btn';
            addBtn.innerHTML = `
                <input type="file" accept="image/*" style="display: none;" onchange="handleImageUpload('${party}', this)">
                <div class="text-center">
                    <i class="bi bi-plus-lg" style="font-size: 24px; color: #6c757d;"></i>
                    <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">Thêm ảnh</div>
                </div>
            `;
            grid.appendChild(addBtn);
        }

        // Handle image upload
        function handleImageUpload(party, input) {
            const file = input.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Vui lòng chọn file hình ảnh!');
                input.value = '';
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('File quá lớn! Vui lòng chọn file nhỏ hơn 5MB.');
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (!images[party]) {
                    images[party] = [];
                }
                
                images[party].push({
                    file: file,
                    dataUrl: e.target.result,
                    base64: e.target.result.split(',')[1]
                });
                
                renderImages(party);
                updateExtractButton();
            };
            reader.readAsDataURL(file);
            
            input.value = '';
        }

        // Remove image
        function removeImage(party, index) {
            if (images[party]) {
                images[party].splice(index, 1);
                if (images[party].length === 0) {
                    delete images[party];
                }
                renderImages(party);
                updateExtractButton();
            }
        }

        // Update extract button state
        function updateExtractButton() {
            const extractBtn = document.getElementById('extractBtn');
            const canExtract = parties.some(party => images[party] && images[party].length >= 2);
            extractBtn.disabled = !canExtract;
        }

        // Extract all info
        async function extractAllInfo() {
            const extractBtn = document.getElementById('extractBtn');
            extractBtn.disabled = true;
            extractBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...';
            
            try {
                extractedData = {};
                
                for (const party of parties) {
                    const partyImages = images[party] || [];
                    
                    if (partyImages.length >= 2) {
                        const data = await callN8nExtractAPI(party, partyImages);
                        extractedData[party] = data;
                    }
                }
                
                if (Object.keys(extractedData).length === 0) {
                    alert('Vui lòng upload ít nhất 2 ảnh cho mỗi đương sự!');
                } else {
                    displayExtractedData();
                }
            } catch (error) {
                console.error('Error extracting info:', error);
                alert('Lỗi khi trích xuất thông tin: ' + error.message);
            } finally {
                extractBtn.disabled = false;
                extractBtn.innerHTML = '<i class="bi bi-gear-fill me-2"></i>TRÍCH XUẤT THÔNG TIN';
            }
        }

        // Call N8N API
        async function callN8nExtractAPI(party, partyImages) {
            try {
                const response = await fetch(N8N_EXTRACT_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        party: party,
                        images: partyImages.map(img => img.base64)
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'Unknown error');
                }
                
                return data.data;
            } catch (error) {
                console.error('Error calling extract API:', error);
                throw error;
            }
        }

        // Display extracted data
        function displayExtractedData() {
            const container = document.getElementById('extractedDataContainer');
            container.innerHTML = '';
            
            parties.forEach(party => {
                if (extractedData[party]) {
                    const data = extractedData[party];
                    const card = document.createElement('div');
                    card.className = 'border rounded p-3 mb-3';
                    card.innerHTML = `
                        <h6 class="fw-bold text-success mb-3">
                            <i class="bi bi-check-circle-fill me-2"></i>Thông tin Đương sự ${party}
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label small text-muted">Họ và tên:</label>
                                <input type="text" class="form-control form-control-sm" value="${data.fullname || ''}" readonly>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label small text-muted">Ngày sinh:</label>
                                <input type="text" class="form-control form-control-sm" value="${data.birthday || ''}" readonly>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label small text-muted">Số CMND/CCCD:</label>
                                <input type="text" class="form-control form-control-sm" value="${data.idcard || ''}" readonly>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label small text-muted">Ngày cấp:</label>
                                <input type="text" class="form-control form-control-sm" value="${data.issue_date || ''}" readonly>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label small text-muted">Ngày hết hạn:</label>
                                <input type="text" class="form-control form-control-sm" value="${data.expiry_date || ''}" readonly>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label small text-muted">Địa chỉ:</label>
                                <input type="text" class="form-control form-control-sm" value="${data.address || ''}" readonly>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                }
            });
            
            document.getElementById('extractedInfo').style.display = 'none';
            document.getElementById('extractedDetails').style.display = 'block';
        }

        // Hide extracted data
        function hideExtractedData() {
            document.getElementById('extractedInfo').style.display = 'block';
            document.getElementById('extractedDetails').style.display = 'none';
        }

        // Clear all
        function clearAll() {
            if (confirm('Bạn có chắc muốn xóa tất cả dữ liệu?')) {
                images = {};
                extractedData = {};
                renderUploadArea();
                hideExtractedData();
            }
        }

        // Download data
        function downloadData() {
            if (Object.keys(extractedData).length === 0) return;
            
            const dataStr = JSON.stringify(extractedData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'thong-tin-trich-xuat.json';
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // Print data
        function printData() {
            if (Object.keys(extractedData).length === 0) return;
            
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Thông tin trích xuất</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="container mt-4">');
            printWindow.document.write('<h2>Thông tin đã trích xuất</h2>');
            
            parties.forEach(party => {
                if (extractedData[party]) {
                    const data = extractedData[party];
                    printWindow.document.write(`<h4 class="mt-4">Đương sự ${party}</h4>`);
                    printWindow.document.write('<table class="table table-bordered">');
                    printWindow.document.write('<tr><th>Họ và tên</th><td>' + data.fullname + '</td></tr>');
                    printWindow.document.write('<tr><th>Ngày sinh</th><td>' + data.birthday + '</td></tr>');
                    printWindow.document.write('<tr><th>Số CMND/CCCD</th><td>' + data.idcard + '</td></tr>');
                    printWindow.document.write('<tr><th>Ngày cấp</th><td>' + data.issue_date + '</td></tr>');
                    printWindow.document.write('<tr><th>Ngày hết hạn</th><td>' + data.expiry_date + '</td></tr>');
                    printWindow.document.write('<tr><th>Địa chỉ</th><td>' + data.address + '</td></tr>');
                    printWindow.document.write('</table>');
                }
            });
            
            printWindow.document.write('</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>