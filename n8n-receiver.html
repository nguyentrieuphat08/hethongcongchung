<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>n8n Contract Receiver</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="alert alert-info">
                    <h4 class="alert-heading">
                        <i class="bi bi-info-circle"></i> n8n Contract Receiver
                    </h4>
                    <p>Trang này nhận dữ liệu hợp đồng từ n8n và lưu vào hệ thống.</p>
                    <hr>
                    <p class="mb-0">Status: <span id="status">Đang chờ...</span></p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="log" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                            <div class="text-muted">Sẵn sàng nhận dữ liệu từ n8n...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString('vi-VN');
            const colors = {
                info: '#0dcaf0',
                success: '#198754',
                error: '#dc3545',
                warning: '#ffc107'
            };
            
            const entry = document.createElement('div');
            entry.style.color = colors[type] || colors.info;
            entry.textContent = `[${time}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Listen for URL parameters
        window.addEventListener('load', async () => {
            const params = new URLSearchParams(window.location.search);
            const name = params.get('name');
            const url = params.get('url');
            const id = params.get('id');

            if (name && url) {
                log('Nhận được dữ liệu từ URL parameters', 'info');
                log(`Name: ${name}`, 'info');
                log(`URL: ${url}`, 'info');
                log(`ID: ${id || 'auto-generated'}`, 'info');
                
                await processContract({ name, url, id });
            } else {
                log('Không có dữ liệu trong URL parameters', 'warning');
            }

            // Listen for POST data via postMessage
            window.addEventListener('message', async (event) => {
                log('Nhận được message từ parent window', 'info');
                
                if (event.data.type === 'NEW_CONTRACT') {
                    log('Type: NEW_CONTRACT', 'info');
                    await processContract(event.data.contract);
                }
            });
        });

        async function processContract(data) {
            try {
                document.getElementById('status').textContent = 'Đang xử lý...';
                document.getElementById('status').className = 'text-warning';
                
                log('Bắt đầu xử lý hợp đồng...', 'info');

                // Validate data
                if (!data.name || !data.url) {
                    throw new Error('Thiếu thông tin name hoặc url');
                }

                // Save to storage
                log('Đang lưu vào storage...', 'info');
                await window.storage.set('pending_contract', JSON.stringify({
                    name: data.name,
                    url: data.url,
                    id: data.id || 'contract_' + Date.now(),
                    timestamp: new Date().toISOString()
                }));

                log('✓ Đã lưu vào storage thành công!', 'success');
                document.getElementById('status').textContent = 'Thành công! Hợp đồng đã được lưu.';
                document.getElementById('status').className = 'text-success';

                // Redirect to admin page after 2 seconds
                log('Chuyển hướng đến trang admin sau 2 giây...', 'info');
                setTimeout(() => {
                    window.location.href = 'admin-contract.html';
                }, 2000);

            } catch (error) {
                log('✗ Lỗi: ' + error.message, 'error');
                document.getElementById('status').textContent = 'Lỗi: ' + error.message;
                document.getElementById('status').className = 'text-danger';
            }
        }

        // Expose function for external calls
        window.receiveFromN8n = processContract;
    </script>
</body>
</html>