<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Mẫu Hợp đồng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .sidebar {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .nav-link.active {
            background-color: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .placeholder-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: grab;
            font-size: 13px;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
        }
        .placeholder-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .placeholder-item:active {
            cursor: grabbing;
        }
        .drag-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0.9;
        }
        .placeholder-item .delete-placeholder {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            opacity: 0.7;
        }
        .placeholder-item .delete-placeholder:hover {
            opacity: 1;
        }
        .placeholder-item {
            position: relative;
        }
        .placeholder-tag {
            display: inline-block;
            background: rgba(255,255,255,0.25);
            color: #fff;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-family: monospace;
        }
        .placeholder-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        .custom-placeholder {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .pdf-container {
            position: relative;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            min-height: 600px;
            background-color: #f8f9fa;
            overflow: auto;
        }
        .pdf-container.drag-over {
            border-color: #667eea;
            background-color: #f0f4ff;
        }
        .pdf-page {
            position: relative;
            margin: 20px auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .field-marker {
            position: absolute;
            background-color: transparent;
            color: #000;
            padding: 2px 4px;
            border: none;
            cursor: grab;
            white-space: nowrap;
            z-index: 100;
            user-select: none;
        }
        .field-marker:hover {
            background-color: rgba(102, 126, 234, 0.15);
            border: 1px dashed #667eea;
            border-radius: 2px;
        }
        .field-marker:active, .field-marker.dragging {
            cursor: grabbing;
            background-color: rgba(102, 126, 234, 0.25);
            border: 2px solid #667eea;
            z-index: 1000;
        }
        .field-marker .remove-marker {
            display: none;
        }
        .field-marker:hover .remove-marker {
            display: inline;
        }
        .field-marker .remove-marker {
            margin-left: 8px;
            cursor: pointer;
            opacity: 0.8;
        }
        .field-marker .remove-marker:hover {
            opacity: 1;
        }
        /* Inline placeholder styles - giống n8n variable tags */
        .placeholder-inline {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: grab;
            white-space: nowrap;
            height: 22px;
            line-height: 22px;
            vertical-align: middle;
            margin: 0 2px;
            user-select: none;
            transition: all 0.2s;
        }
        .placeholder-inline:hover {
            background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        .placeholder-inline:active {
            cursor: grabbing;
        }
        .placeholder-inline.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .placeholder-inline .remove-placeholder-inline {
            margin-left: 6px;
            cursor: pointer;
            opacity: 0.7;
            font-size: 11px;
        }
        .placeholder-inline .remove-placeholder-inline:hover {
            opacity: 1;
        }
        /* Chế độ xem mẫu - hiển thị text thuần không viền */
        .placeholder-inline.sample-view {
            background: transparent;
            color: #333;
            padding: 0;
            border-radius: 0;
            font-weight: normal;
            cursor: default;
            height: auto;
            line-height: inherit;
            margin: 0;
            box-shadow: none;
        }
        .placeholder-inline.sample-view:hover {
            background: transparent;
            box-shadow: none;
        }
        .placeholder-inline.sample-view .remove-placeholder-inline {
            display: none;
        }
        /* Drop zone highlight */
        .word-content {
            cursor: text;
        }
        .word-content.drop-active {
            background-color: #fff8e1;
        }
        /* Caret indicator */
        .drop-caret {
            display: inline-block;
            width: 2px;
            height: 1em;
            background-color: #667eea;
            animation: blink 1s infinite;
            vertical-align: middle;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        /* Placeholder edit popup */
        .placeholder-edit-popup {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 250px;
            top: 100%;
            left: 0;
            margin-top: 5px;
        }
        .add-placeholder-form {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        .contract-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .contract-item:hover {
            background-color: #e9ecef;
        }
        .page-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .word-document {
            position: relative;
            background: white;
            margin: 20px auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-height: 800px;
            overflow: hidden;
        }
        .word-document .docx-wrapper {
            background: white !important;
            padding: 0 !important;
        }
        .word-document section.docx {
            box-shadow: none !important;
            margin-bottom: 0 !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar text-white p-0">
                <div class="p-3">
                    <h4 class="mb-4">MENU</h4>
                    <div class="nav flex-column" id="mainMenu">
                        <a href="admin-contract.html" class="nav-link text-white active mb-2">
                            <i class="bi bi-gear-fill me-2"></i>Quản lý Mẫu Hợp đồng
                        </a>
                        <a href="user-extract.html" class="nav-link text-white mb-2">
                            <i class="bi bi-card-image me-2"></i>Trích xuất thông tin
                        </a>
                        <a href="user-chat.html" class="nav-link text-white mb-2">
                            <i class="bi bi-chat-dots-fill me-2"></i>Chat AI
                        </a>
                    </div>
                    <div class="mt-4 text-center">
                        <small>Phiên bản 1.0</small>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4 main-content">
                <div class="bg-white rounded shadow-sm p-4">
                    <h3 class="mb-4">
                        <i class="bi bi-file-earmark-text me-2"></i>Quản lý Mẫu Hợp đồng
                    </h3>

                    <!-- API Endpoint Info -->
                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>API Endpoint để n8n gửi hợp đồng</h6>
                        <p class="mb-1"><strong>URL:</strong> <code id="apiEndpoint"></code></p>
                        <p class="mb-1"><strong>Method:</strong> <code>POST</code></p>
                        <p class="mb-0"><strong>Body:</strong> <code>{ "name": "Tên hợp đồng", "url": "https://link-to-pdf...", "description": "Mô tả" }</code></p>
                    </div>

                    <!-- Thêm hợp đồng thủ công -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-plus-circle me-2"></i>Thêm hợp đồng mới
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-5">
                                    <label class="form-label">Tên hợp đồng</label>
                                    <input type="text" class="form-control" id="uploadContractName" placeholder="VD: Hợp đồng mua bán nhà">
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label">Chọn file PDF hoặc Word</label>
                                    <input type="file" class="form-control" id="uploadContractFile" accept=".pdf,.docx,.doc">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" onclick="uploadContractFile()">
                                        <i class="bi bi-upload me-1"></i>Upload
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Contract Selection and Editor -->
                    <div class="row">
                        <!-- Left Panel: Contract Selection & Placeholders -->
                        <div class="col-md-3">
                            <!-- Chọn hợp đồng -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-file-text me-2"></i>Chọn hợp đồng
                                </label>
                                <select class="form-select" id="contractSelect" onchange="loadContract()">
                                    <option value="">-- Chọn hợp đồng --</option>
                                </select>
                                <button class="btn btn-outline-danger btn-sm w-100 mt-2" onclick="deleteSelectedContract()" id="deleteContractBtn" style="display: none;">
                                    <i class="bi bi-trash me-1"></i>Xóa hợp đồng này
                                </button>
                            </div>

                            <!-- Thêm placeholder tùy chỉnh -->
                            <div class="add-placeholder-form">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-plus-circle me-2"></i>Thêm Placeholder mới
                                </label>
                                <div class="input-group input-group-sm mb-2">
                                    <input type="text" class="form-control" id="newPlaceholderName" placeholder="Tên hiển thị">
                                </div>
                                <div class="input-group input-group-sm mb-2">
                                    <input type="text" class="form-control" id="newPlaceholderField" placeholder="Tên biến (VD: so_hop_dong)">
                                </div>
                                <div class="input-group input-group-sm mb-2">
                                    <input type="text" class="form-control" id="newPlaceholderSample" placeholder="Dữ liệu mẫu (VD: HD-001)">
                                </div>
                                <button class="btn btn-success btn-sm w-100" onclick="addCustomPlaceholder()">
                                    <i class="bi bi-plus-lg me-1"></i>Thêm Placeholder
                                </button>
                            </div>

                            <!-- Cài đặt font chữ -->
                            <div class="card mb-3">
                                <div class="card-header py-2">
                                    <small class="fw-bold"><i class="bi bi-fonts me-1"></i>Cài đặt font chữ</small>
                                </div>
                                <div class="card-body py-2">
                                    <div class="mb-2">
                                        <label class="form-label small mb-1">Font chữ</label>
                                        <select class="form-select form-select-sm" id="fontFamily" onchange="updateFontSettings()">
                                            <option value="'Times New Roman', Times, serif">Times New Roman</option>
                                            <option value="Arial, sans-serif">Arial</option>
                                            <option value="'Courier New', monospace">Courier New</option>
                                            <option value="Georgia, serif">Georgia</option>
                                            <option value="Verdana, sans-serif">Verdana</option>
                                            <option value="Tahoma, sans-serif">Tahoma</option>
                                            <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                                            <option value="'Palatino Linotype', serif">Palatino</option>
                                        </select>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small mb-1">Cỡ chữ gốc (pt)</label>
                                        <input type="number" class="form-control form-control-sm" id="fontSize" value="14" min="8" max="36" onchange="updateFontSettings()">
                                    </div>
                                    <div>
                                        <label class="form-label small mb-1">Hệ số scale</label>
                                        <input type="number" class="form-control form-control-sm" id="fontScale" value="1.5" min="0.5" max="3" step="0.1" onchange="updateFontSettings()">
                                        <small class="text-muted">PDF: 1.5 | Word: 1.0-1.33</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Danh sách placeholder -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-tags me-2"></i>Các biến Placeholder
                                </label>
                                <small class="d-block text-muted mb-2">Kéo thả vào hợp đồng bên phải</small>
                            </div>

                            <div id="placeholdersList"></div>

                            <div class="mt-4">
                                <button class="btn btn-success w-100" onclick="saveContractConfig()" id="saveBtn" disabled>
                                    <i class="bi bi-save me-2"></i>Lưu cấu hình
                                </button>
                                <button class="btn btn-warning w-100 mt-2" onclick="clearAllMarkers()" id="clearMarkersBtn" disabled>
                                    <i class="bi bi-eraser me-2"></i>Xóa tất cả placeholder
                                </button>
                                <button class="btn btn-info w-100 mt-2" onclick="autoDetectPlaceholders()" id="aiDetectBtn" disabled>
                                    <i class="bi bi-robot me-2"></i>AI tự động chèn placeholder
                                </button>
                                <div class="btn-group w-100 mt-2" role="group">
                                    <button class="btn btn-outline-secondary active" onclick="toggleViewMode('label')" id="btnViewLabel">
                                        <i class="bi bi-tag me-1"></i>Xem Label
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="toggleViewMode('sample')" id="btnViewSample">
                                        <i class="bi bi-eye me-1"></i>Xem Mẫu
                                    </button>
                                </div>
                                <button class="btn btn-outline-danger w-100 mt-2" onclick="clearCustomPlaceholders()">
                                    <i class="bi bi-trash me-2"></i>Xóa placeholder tùy chỉnh
                                </button>
                            </div>
                        </div>

                        <!-- Right Panel: Contract Canvas -->
                        <div class="col-md-9">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label fw-bold mb-0">
                                    <i class="bi bi-file-pdf me-2"></i>Hợp đồng mẫu
                                </label>
                                <div id="pageInfo" style="display: none;">
                                    <span class="badge bg-secondary">Trang <span id="currentPageNum">1</span> / <span id="totalPages">1</span></span>
                                </div>
                            </div>

                            <div class="pdf-container" id="pdfContainer">
                                <div class="alert alert-secondary text-center m-4">
                                    <i class="bi bi-arrow-left-circle me-2"></i>
                                    Chọn một hợp đồng từ menu bên trái để bắt đầu chỉnh sửa
                                </div>
                            </div>

                            <!-- Page Navigation -->
                            <div class="page-navigation" id="pageNavigation" style="display: none;">
                                <button class="btn btn-outline-primary btn-sm" onclick="prevPage()" id="prevPageBtn">
                                    <i class="bi bi-chevron-left"></i> Trang trước
                                </button>
                                <span id="pageIndicator">1 / 1</span>
                                <button class="btn btn-outline-primary btn-sm" onclick="nextPage()" id="nextPageBtn">
                                    Trang sau <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-check-circle-fill text-success me-2" id="toastIcon"></i>
                <strong class="me-auto" id="toastTitle">Thông báo</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx-preview@0.1.4/dist/docx-preview.min.js"></script>
    <script>
        // ========== CONFIGURATION ==========
        const CONTRACTS_KEY = 'contracts';
        const PLACEHOLDERS_KEY = 'custom_placeholders';
        const API_ENDPOINT = window.location.origin + '/api/receive-contract';
        const CONTRACTS_API = window.location.origin + '/api/contracts';
        const GEMINI_API_KEY = 'AIzaSyCpk0DKaYp_nTBUEPpasKE4rwIG5quPhpQ';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
        
        // Multiple CORS proxies to try
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://proxy.cors.sh/'
        ];

        // Default placeholders with sample data
        const DEFAULT_PLACEHOLDERS = [
            { field: 'fullname', label: 'Họ và tên', icon: 'bi-person-fill', isDefault: true, sampleData: 'Nguyễn Văn A' },
            { field: 'birthday', label: 'Ngày sinh', icon: 'bi-calendar-event', isDefault: true, sampleData: '01/01/1990' },
            { field: 'idcard', label: 'Số CMND/CCCD', icon: 'bi-credit-card-2-front', isDefault: true, sampleData: '001234567890' },
            { field: 'issue_date', label: 'Ngày cấp', icon: 'bi-calendar-check', isDefault: true, sampleData: '01/01/2020' },
            { field: 'expiry_date', label: 'Ngày hết hạn', icon: 'bi-calendar-x', isDefault: true, sampleData: '01/01/2030' },
            { field: 'address', label: 'Địa chỉ', icon: 'bi-geo-alt-fill', isDefault: true, sampleData: '123 Đường ABC, Quận 1, TP.HCM' },
            { field: 'phone', label: 'Số điện thoại', icon: 'bi-telephone-fill', isDefault: true, sampleData: '0901234567' },
            { field: 'email', label: 'Email', icon: 'bi-envelope-fill', isDefault: true, sampleData: 'email@example.com' }
        ];

        // ========== STATE ==========
        let contracts = [];
        let customPlaceholders = [];
        let currentContract = null;
        let currentPdf = null;
        let currentPage = 1;
        let totalPages = 1;
        let markers = [];
        let placeholderMappings = []; // Store placeholder mappings for Word documents
        let originalWordContent = ''; // Store original Word HTML content
        let viewMode = 'label'; // 'label' or 'sample' - for admin viewing
        let fontSettings = {
            fontFamily: "'Times New Roman', Times, serif",
            fontSize: 14,
            fontScale: 1.5
        };
        let pdfScale = 1.5; // PDF render scale
        
        // Drag state
        let isDragging = false;
        let dragType = null; // 'placeholder' or 'marker'
        let dragData = null;
        let dragGhost = null;
        let dragOffset = { x: 0, y: 0 };

        // ========== INITIALIZATION ==========
        window.addEventListener('load', async () => {
            document.getElementById('apiEndpoint').textContent = API_ENDPOINT;
            loadFontSettings();
            await loadContracts();
            loadCustomPlaceholders();
            renderPlaceholders();
            setupReceiveContract();
            
            // Auto-refresh contracts every 10 seconds
            setInterval(fetchContractsFromAPI, 10000);
        });

        // ========== FONT SETTINGS ==========
        function loadFontSettings() {
            const saved = localStorage.getItem('fontSettings');
            if (saved) {
                fontSettings = JSON.parse(saved);
                document.getElementById('fontFamily').value = fontSettings.fontFamily;
                document.getElementById('fontSize').value = fontSettings.fontSize;
                document.getElementById('fontScale').value = fontSettings.fontScale || 1.5;
            }
        }

        function saveFontSettings() {
            localStorage.setItem('fontSettings', JSON.stringify(fontSettings));
        }

        function updateFontSettings() {
            fontSettings.fontFamily = document.getElementById('fontFamily').value;
            fontSettings.fontSize = parseInt(document.getElementById('fontSize').value) || 14;
            fontSettings.fontScale = parseFloat(document.getElementById('fontScale').value) || 1.5;
            saveFontSettings();
            renderMarkers();
        }

        // Setup to receive contract from n8n (via URL params or postMessage)
        function setupReceiveContract() {
            // Check URL params
            const urlParams = new URLSearchParams(window.location.search);
            const name = urlParams.get('name');
            const url = urlParams.get('url');
            
            if (name && url) {
                addContract({ name: decodeURIComponent(name), url: decodeURIComponent(url) });
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // Listen for postMessage
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'add-contract') {
                    addContract(event.data.contract);
                }
            });
        }

        // ========== CONTRACTS MANAGEMENT ==========
        async function loadContracts() {
            // Load from localStorage first
            const saved = localStorage.getItem(CONTRACTS_KEY);
            contracts = saved ? JSON.parse(saved) : [];
            
            // Then fetch from API to get contracts from n8n
            await fetchContractsFromAPI();
            
            renderContractSelect();
        }

        async function fetchContractsFromAPI() {
            try {
                const response = await fetch(CONTRACTS_API);
                const data = await response.json();
                
                if (data.success && data.contracts && data.contracts.length > 0) {
                    // Merge with existing contracts (avoid duplicates)
                    data.contracts.forEach(apiContract => {
                        const exists = contracts.some(c => c.url === apiContract.url);
                        if (!exists) {
                            contracts.push(apiContract);
                        }
                    });
                    
                    saveContracts();
                    renderContractSelect();
                }
            } catch (error) {
                console.log('Could not fetch contracts from API:', error);
            }
        }

        function saveContracts() {
            localStorage.setItem(CONTRACTS_KEY, JSON.stringify(contracts));
        }

        function renderContractSelect() {
            const select = document.getElementById('contractSelect');
            select.innerHTML = '<option value="">-- Chọn hợp đồng --</option>';
            
            contracts.forEach((contract, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = contract.name;
                select.appendChild(option);
            });
        }

        function addContract(contractData) {
            const { name, url, description } = contractData;
            
            if (!name || !url) {
                showToast('Lỗi', 'Thiếu tên hoặc URL hợp đồng', 'error');
                return;
            }

            // Check duplicate
            if (contracts.some(c => c.url === url)) {
                showToast('Thông báo', 'Hợp đồng này đã tồn tại', 'warning');
                return;
            }

            contracts.push({
                id: 'contract_' + Date.now(),
                name,
                url,
                description: description || '',
                markers: [],
                createdAt: new Date().toISOString()
            });

            saveContracts();
            renderContractSelect();
            showToast('Thành công', `Đã thêm hợp đồng: ${name}`, 'success');
        }

        function addContractManually() {
            const name = document.getElementById('newContractName').value.trim();
            const url = document.getElementById('newContractUrl').value.trim();

            if (!name || !url) {
                showToast('Lỗi', 'Vui lòng nhập đầy đủ tên và URL', 'error');
                return;
            }

            addContract({ name, url });
            
            document.getElementById('newContractName').value = '';
            document.getElementById('newContractUrl').value = '';
        }

        function deleteSelectedContract() {
            const select = document.getElementById('contractSelect');
            const index = parseInt(select.value);
            
            if (isNaN(index)) return;
            
            if (confirm(`Bạn có chắc muốn xóa hợp đồng "${contracts[index].name}"?`)) {
                contracts.splice(index, 1);
                saveContracts();
                renderContractSelect();
                currentContract = null;
                currentPdf = null;
                markers = [];
                
                document.getElementById('pdfContainer').innerHTML = `
                    <div class="alert alert-secondary text-center m-4">
                        <i class="bi bi-arrow-left-circle me-2"></i>
                        Chọn một hợp đồng từ menu bên trái để bắt đầu chỉnh sửa
                    </div>
                `;
                document.getElementById('deleteContractBtn').style.display = 'none';
                document.getElementById('pageNavigation').style.display = 'none';
                document.getElementById('pageInfo').style.display = 'none';
                document.getElementById('saveBtn').disabled = true;
                document.getElementById('clearMarkersBtn').disabled = true;
                
                showToast('Đã xóa', 'Hợp đồng đã được xóa', 'success');
            }
        }

        // Upload PDF or Word file from computer
        function uploadContractFile() {
            const name = document.getElementById('uploadContractName').value.trim();
            const fileInput = document.getElementById('uploadContractFile');
            const file = fileInput.files[0];

            if (!name) {
                showToast('Lỗi', 'Vui lòng nhập tên hợp đồng', 'error');
                return;
            }

            if (!file) {
                showToast('Lỗi', 'Vui lòng chọn file', 'error');
                return;
            }

            const isPdf = file.type === 'application/pdf' || file.name.endsWith('.pdf');
            const isWord = file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || 
                          file.name.endsWith('.docx') || file.name.endsWith('.doc');

            if (!isPdf && !isWord) {
                showToast('Lỗi', 'Vui lòng chọn file PDF hoặc Word (.docx)', 'error');
                return;
            }

            // Check if duplicate
            if (contracts.some(c => c.name === name)) {
                showToast('Lỗi', 'Tên hợp đồng đã tồn tại', 'error');
                return;
            }

            // Read file
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                
                contracts.push({
                    id: 'contract_' + Date.now(),
                    name,
                    url: dataUrl,
                    fileType: isPdf ? 'pdf' : 'word',
                    isLocal: true,
                    description: '',
                    markers: [],
                    createdAt: new Date().toISOString()
                });

                saveContracts();
                renderContractSelect();
                showToast('Thành công', `Đã upload hợp đồng: ${name}`, 'success');
                
                // Clear form
                document.getElementById('uploadContractName').value = '';
                fileInput.value = '';
            };

            reader.onerror = function() {
                showToast('Lỗi', 'Không thể đọc file', 'error');
            };

            reader.readAsDataURL(file);
        }

        // ========== PLACEHOLDERS MANAGEMENT ==========
        function loadCustomPlaceholders() {
            const saved = localStorage.getItem(PLACEHOLDERS_KEY);
            customPlaceholders = saved ? JSON.parse(saved) : [];
        }

        function saveCustomPlaceholders() {
            localStorage.setItem(PLACEHOLDERS_KEY, JSON.stringify(customPlaceholders));
        }

        function getAllPlaceholders() {
            return [...DEFAULT_PLACEHOLDERS, ...customPlaceholders];
        }

        function renderPlaceholders() {
            const container = document.getElementById('placeholdersList');
            container.innerHTML = '';
            
            const allPlaceholders = getAllPlaceholders();
            
            allPlaceholders.forEach((placeholder, index) => {
                const div = document.createElement('div');
                div.className = `placeholder-item ${placeholder.isDefault ? '' : 'custom-placeholder'}`;
                div.dataset.field = placeholder.field;
                div.dataset.label = placeholder.label;
                div.draggable = true;
                
                div.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="${placeholder.icon || 'bi-tag'} me-2"></i>
                        <div class="flex-grow-1">
                            <span class="fw-medium">${placeholder.label}</span>
                            <small class="d-block text-light opacity-75" style="font-size: 10px;">${placeholder.sampleData || ''}</small>
                        </div>
                        <span class="placeholder-tag ms-2">${placeholder.field}</span>
                    </div>
                    ${!placeholder.isDefault ? `<i class="bi bi-x-circle delete-placeholder" onclick="event.stopPropagation(); deleteCustomPlaceholder('${placeholder.field}')"></i>` : ''}
                `;
                
                // HTML5 Drag events
                div.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('delete-placeholder')) return;
                    e.dataTransfer.setData('field', placeholder.field);
                    e.dataTransfer.setData('label', placeholder.label);
                    e.dataTransfer.setData('sampleData', placeholder.sampleData || placeholder.label);
                    e.dataTransfer.effectAllowed = 'copy';
                    div.classList.add('dragging');
                });
                
                div.addEventListener('dragend', () => {
                    div.classList.remove('dragging');
                });
                
                // Mouse down - start drag (backup for custom drag ghost)
                div.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('delete-placeholder')) return;
                    // Let HTML5 drag handle it
                });
                
                container.appendChild(div);
            });
        }

        // ========== IMPROVED DRAG SYSTEM ==========
        function startDragPlaceholder(e, placeholder) {
            isDragging = true;
            dragType = 'placeholder';
            dragData = {
                field: placeholder.field,
                label: placeholder.label,
                sampleData: placeholder.sampleData || placeholder.label
            };
            
            // Create ghost element
            createDragGhost(placeholder.label, e.clientX, e.clientY);
            
            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('mouseup', onDragEnd);
        }

        function startDragMarker(e, marker, markerElement) {
            e.preventDefault();
            e.stopPropagation();
            
            isDragging = true;
            dragType = 'marker';
            dragData = marker;
            
            const rect = markerElement.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            markerElement.classList.add('dragging');
            
            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('mouseup', onDragEnd);
        }

        function createDragGhost(text, x, y) {
            dragGhost = document.createElement('div');
            dragGhost.className = 'drag-ghost';
            dragGhost.textContent = text;
            dragGhost.style.left = (x + 10) + 'px';
            dragGhost.style.top = (y + 10) + 'px';
            document.body.appendChild(dragGhost);
        }

        function onDragMove(e) {
            if (!isDragging) return;
            
            if (dragType === 'placeholder' && dragGhost) {
                dragGhost.style.left = (e.clientX + 10) + 'px';
                dragGhost.style.top = (e.clientY + 10) + 'px';
            } else if (dragType === 'marker') {
                const container = document.getElementById('markersContainer');
                if (!container) return;
                
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left - dragOffset.x;
                const y = e.clientY - rect.top - dragOffset.y;
                
                // Update marker position in real-time
                dragData.x = Math.max(0, Math.min(x, rect.width - 50));
                dragData.y = Math.max(0, Math.min(y, rect.height - 20));
                
                const markerEl = document.querySelector(`[data-marker-id="${dragData.id}"]`);
                if (markerEl) {
                    markerEl.style.left = dragData.x + 'px';
                    markerEl.style.top = dragData.y + 'px';
                }
            }
        }

        function onDragEnd(e) {
            if (!isDragging) return;
            
            document.removeEventListener('mousemove', onDragMove);
            document.removeEventListener('mouseup', onDragEnd);
            
            if (dragType === 'placeholder') {
                // Remove ghost
                if (dragGhost) {
                    dragGhost.remove();
                    dragGhost = null;
                }
                
                // Check if dropped on PDF
                const pdfPage = document.getElementById('pdfPage');
                if (pdfPage) {
                    const rect = pdfPage.getBoundingClientRect();
                    if (e.clientX >= rect.left && e.clientX <= rect.right &&
                        e.clientY >= rect.top && e.clientY <= rect.bottom) {
                        
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        markers.push({
                            id: 'marker_' + Date.now(),
                            field: dragData.field,
                            label: dragData.label,
                            sampleData: dragData.sampleData,
                            page: currentPage,
                            x,
                            y
                        });
                        
                        renderMarkers();
                    }
                }
            } else if (dragType === 'marker') {
                // Marker already updated in real-time
                document.querySelectorAll('.field-marker').forEach(el => el.classList.remove('dragging'));
            }
            
            isDragging = false;
            dragType = null;
            dragData = null;
        }

        function addCustomPlaceholder() {
            const name = document.getElementById('newPlaceholderName').value.trim();
            const field = document.getElementById('newPlaceholderField').value.trim().toLowerCase().replace(/\s+/g, '_');
            const sampleData = document.getElementById('newPlaceholderSample').value.trim();
            
            if (!name || !field) {
                showToast('Lỗi', 'Vui lòng nhập đầy đủ thông tin', 'error');
                return;
            }

            // Check duplicate
            const allPlaceholders = getAllPlaceholders();
            if (allPlaceholders.some(p => p.field === field)) {
                showToast('Lỗi', 'Tên biến đã tồn tại', 'error');
                return;
            }

            customPlaceholders.push({
                field,
                label: name,
                icon: 'bi-tag-fill',
                isDefault: false,
                sampleData: sampleData || name
            });

            saveCustomPlaceholders();
            renderPlaceholders();
            
            document.getElementById('newPlaceholderName').value = '';
            document.getElementById('newPlaceholderField').value = '';
            document.getElementById('newPlaceholderSample').value = '';
            
            showToast('Thành công', `Đã thêm placeholder: ${name}`, 'success');
        }

        function deleteCustomPlaceholder(field) {
            if (confirm('Bạn có chắc muốn xóa placeholder này?')) {
                customPlaceholders = customPlaceholders.filter(p => p.field !== field);
                saveCustomPlaceholders();
                renderPlaceholders();
                showToast('Đã xóa', 'Placeholder đã được xóa', 'success');
            }
        }

        function clearCustomPlaceholders() {
            if (customPlaceholders.length === 0) {
                showToast('Thông báo', 'Không có placeholder tùy chỉnh nào để xóa', 'warning');
                return;
            }
            
            if (confirm(`Bạn có chắc muốn xóa tất cả ${customPlaceholders.length} placeholder tùy chỉnh? Các placeholder mặc định sẽ được giữ lại.`)) {
                const count = customPlaceholders.length;
                customPlaceholders = [];
                saveCustomPlaceholders();
                renderPlaceholders();
                showToast('Đã xóa', `Đã xóa ${count} placeholder tùy chỉnh`, 'success');
            }
        }

        // ========== PDF LOADING & RENDERING ==========
        function getPdfUrl(originalUrl) {
            // If it's a data URL (local file), return as is
            if (originalUrl.startsWith('data:')) {
                return originalUrl;
            }
            
            // If it's a direct PDF link (not Google Drive), return as is
            if (!originalUrl.includes('drive.google.com')) {
                return originalUrl;
            }
            
            // Google Drive is not supported for direct loading
            // Return null to show error message
            return null;
        }

        async function loadContract() {
            const select = document.getElementById('contractSelect');
            const index = parseInt(select.value);
            
            if (isNaN(index)) {
                document.getElementById('deleteContractBtn').style.display = 'none';
                return;
            }
            
            document.getElementById('deleteContractBtn').style.display = 'block';
            
            currentContract = contracts[index];
            markers = currentContract.markers || [];
            
            // Determine file type
            const fileType = currentContract.fileType || 'pdf';
            
            if (fileType === 'word') {
                await loadWordDocument();
            } else {
                await loadPdfDocument();
            }
        }

        async function loadPdfDocument() {
            try {
                document.getElementById('pdfContainer').innerHTML = `
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3">Đang tải PDF...</p>
                    </div>
                `;
                
                // Initialize PDF.js
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                // Get PDF URL
                const pdfUrl = getPdfUrl(currentContract.url);
                
                if (pdfUrl === null) {
                    document.getElementById('pdfContainer').innerHTML = `
                        <div class="alert alert-danger m-4">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Không thể tải PDF từ Google Drive</strong>
                            <br><br>
                            Google Drive không cho phép tải trực tiếp từ web. Vui lòng:
                            <ol class="mt-2 mb-0">
                                <li>Tải file PDF về máy tính</li>
                                <li>Dùng tab <strong>"Upload từ máy tính"</strong> để upload lên</li>
                            </ol>
                        </div>
                    `;
                    return;
                }
                
                console.log('Loading PDF from:', pdfUrl.substring(0, 100) + '...');
                
                // Load PDF
                currentPdf = await pdfjsLib.getDocument(pdfUrl).promise;
                totalPages = currentPdf.numPages;
                currentPage = 1;
                pdfScale = 1.5; // PDF scale
                
                await renderPage(currentPage);
                
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('clearMarkersBtn').disabled = false;
                document.getElementById('aiDetectBtn').disabled = false;
                document.getElementById('pageNavigation').style.display = totalPages > 1 ? 'flex' : 'none';
                document.getElementById('pageInfo').style.display = 'block';
                document.getElementById('totalPages').textContent = totalPages;
                
                updatePageNavigation();
                
            } catch (error) {
                console.error('Error loading PDF:', error);
                document.getElementById('pdfContainer').innerHTML = `
                    <div class="alert alert-danger m-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Lỗi khi tải PDF: ${error.message}
                        <br><small>URL: ${currentContract.url}</small>
                    </div>
                `;
            }
        }

        async function loadWordDocument() {
            try {
                document.getElementById('pdfContainer').innerHTML = `
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3">Đang tải file Word...</p>
                    </div>
                `;
                
                // Convert base64 to Blob
                const base64Data = currentContract.url.split(',')[1];
                const binaryString = window.atob(base64Data);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
                
                // Create container
                const container = document.getElementById('pdfContainer');
                container.innerHTML = '';
                
                // Create document wrapper
                const docWrapper = document.createElement('div');
                docWrapper.className = 'word-document';
                docWrapper.id = 'pdfPage';
                docWrapper.style.position = 'relative';
                
                // Create content container for docx-preview
                const contentDiv = document.createElement('div');
                contentDiv.id = 'wordContent';
                contentDiv.className = 'word-content';
                docWrapper.appendChild(contentDiv);
                
                // Create markers container
                const markersContainer = document.createElement('div');
                markersContainer.id = 'markersContainer';
                markersContainer.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;';
                docWrapper.appendChild(markersContainer);
                
                container.appendChild(docWrapper);
                
                // Render Word document using docx-preview
                const docxLib = window.docx || window.docxPreview || window['docx-preview'];
                if (!docxLib) {
                    throw new Error('Thư viện docx-preview chưa được tải');
                }
                await docxLib.renderAsync(blob, contentDiv, null, {
                    className: 'docx',
                    inWrapper: true,
                    ignoreWidth: false,
                    ignoreHeight: false,
                    ignoreFonts: false,
                    breakPages: true,
                    experimental: true,
                    useBase64URL: true
                });
                
                // Store original content for reset
                originalWordContent = contentDiv.innerHTML;
                
                // Load placeholder mappings
                loadPlaceholderMappings();
                
                // If there's modified content saved, restore it
                if (currentContract.modifiedContent) {
                    contentDiv.innerHTML = currentContract.modifiedContent;
                }
                
                // Enable drop on Word content
                setupWordDropZone(contentDiv);
                
                // Render markers - Word không scale nên dùng scale = 1
                currentPage = 1;
                totalPages = 1;
                currentPdf = null;
                pdfScale = 1; // Word không scale như PDF
                renderMarkers();
                
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('clearMarkersBtn').disabled = false;
                document.getElementById('aiDetectBtn').disabled = false;
                document.getElementById('pageNavigation').style.display = 'none';
                document.getElementById('pageInfo').style.display = 'block';
                document.getElementById('totalPages').textContent = '1';
                document.getElementById('currentPageNum').textContent = '1';
                
            } catch (error) {
                console.error('Error loading Word document:', error);
                document.getElementById('pdfContainer').innerHTML = `
                    <div class="alert alert-danger m-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Lỗi khi tải file Word: ${error.message}
                        <br><br>
                        <small>Lưu ý: Chỉ hỗ trợ file .docx (Word 2007 trở lên). File .doc cũ không được hỗ trợ.</small>
                    </div>
                `;
            }
        }

        async function renderPage(pageNum) {
            const page = await currentPdf.getPage(pageNum);
            const scale = 1.5;
            const viewport = page.getViewport({ scale });
            
            const container = document.getElementById('pdfContainer');
            container.innerHTML = '';
            
            // Create page wrapper
            const pageWrapper = document.createElement('div');
            pageWrapper.className = 'pdf-page';
            pageWrapper.id = 'pdfPage';
            pageWrapper.style.width = viewport.width + 'px';
            pageWrapper.style.height = viewport.height + 'px';
            pageWrapper.style.position = 'relative';
            
            // Create canvas
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            const context = canvas.getContext('2d');
            await page.render({ canvasContext: context, viewport }).promise;
            
            pageWrapper.appendChild(canvas);
            
            // Create markers container
            const markersContainer = document.createElement('div');
            markersContainer.id = 'markersContainer';
            markersContainer.style.position = 'absolute';
            markersContainer.style.top = '0';
            markersContainer.style.left = '0';
            markersContainer.style.width = '100%';
            markersContainer.style.height = '100%';
            pageWrapper.appendChild(markersContainer);
            
            container.appendChild(pageWrapper);
            
            // Render existing markers for this page
            renderMarkers();
            
            document.getElementById('currentPageNum').textContent = pageNum;
        }

        function renderMarkers() {
            const container = document.getElementById('markersContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Only show markers for current page
            const pageMarkers = markers.filter(m => m.page === currentPage);
            
            pageMarkers.forEach(marker => {
                const div = document.createElement('div');
                div.className = 'field-marker';
                div.dataset.markerId = marker.id;
                div.style.left = marker.x + 'px';
                div.style.top = marker.y + 'px';
                div.style.fontFamily = fontSettings.fontFamily;
                // Apply scale to font size so it matches document text
                div.style.fontSize = (fontSettings.fontSize * fontSettings.fontScale) + 'px';
                div.innerHTML = `
                    <span class="marker-text">${marker.sampleData || marker.label}</span><i class="bi bi-x-circle remove-marker" style="margin-left: 5px; color: #dc3545; font-size: 11px;" onclick="event.stopPropagation(); removeMarker('${marker.id}')"></i>
                `;
                
                // Mouse events for dragging
                div.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('remove-marker')) return;
                    startDragMarker(e, marker, div);
                });
                
                container.appendChild(div);
            });
        }

        function removeMarker(markerId) {
            markers = markers.filter(m => m.id !== markerId);
            renderMarkers();
        }

        function clearAllMarkers() {
            const fileType = currentContract?.fileType || 'pdf';
            
            if (fileType === 'word') {
                // For Word: reset to original content
                if (confirm('Bạn có chắc muốn xóa tất cả placeholder đã chèn và khôi phục văn bản gốc?')) {
                    if (originalWordContent) {
                        const wordContent = document.getElementById('wordContent');
                        if (wordContent) {
                            wordContent.innerHTML = originalWordContent;
                        }
                    }
                    placeholderMappings = [];
                    savePlaceholderMappings();
                    showToast('Đã xóa', 'Đã khôi phục văn bản gốc', 'success');
                }
            } else {
                // For PDF: clear markers
                if (confirm('Bạn có chắc muốn xóa tất cả marker?')) {
                    markers = [];
                    renderMarkers();
                    showToast('Đã xóa', 'Tất cả marker đã được xóa', 'success');
                }
            }
        }

        // ========== PAGE NAVIGATION ==========
        async function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                await renderPage(currentPage);
                updatePageNavigation();
            }
        }

        async function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                await renderPage(currentPage);
                updatePageNavigation();
            }
        }

        function updatePageNavigation() {
            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
            document.getElementById('pageIndicator').textContent = `${currentPage} / ${totalPages}`;
        }

        // ========== SAVE CONFIG ==========
        function saveContractConfig() {
            if (!currentContract) return;
            
            const select = document.getElementById('contractSelect');
            const index = parseInt(select.value);
            
            const fileType = currentContract.fileType || 'pdf';
            
            if (fileType === 'word') {
                // For Word: save both display content and template
                const wordContent = document.getElementById('wordContent');
                if (wordContent) {
                    // Save current display content
                    contracts[index].modifiedContent = wordContent.innerHTML;
                    
                    // Generate template with {{placeholders}} for later use
                    const template = generateTemplate(wordContent);
                    contracts[index].template = template;
                }
                contracts[index].placeholderMappings = placeholderMappings;
            } else {
                // For PDF: save markers
                contracts[index].markers = markers;
            }
            
            saveContracts();
            
            showToast('Đã lưu', 'Cấu hình đã được lưu thành công', 'success');
        }

        function generateTemplate(container) {
            // Clone the container to not affect the display
            const clone = container.cloneNode(true);
            
            // Replace all placeholder spans with {{field}} syntax
            const placeholders = clone.querySelectorAll('.placeholder-inline');
            placeholders.forEach(span => {
                const field = span.dataset.field;
                const textNode = document.createTextNode(`{{${field}}}`);
                span.parentNode.replaceChild(textNode, span);
            });
            
            return clone.innerHTML;
        }

        // ========== TOAST NOTIFICATION ==========
        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastTitle = document.getElementById('toastTitle');
            const toastBody = document.getElementById('toastBody');
            const toastIcon = document.getElementById('toastIcon');
            
            toastTitle.textContent = title;
            toastBody.textContent = message;
            
            toastIcon.className = 'bi me-2';
            if (type === 'success') {
                toastIcon.classList.add('bi-check-circle-fill', 'text-success');
            } else if (type === 'error') {
                toastIcon.classList.add('bi-x-circle-fill', 'text-danger');
            } else if (type === 'warning') {
                toastIcon.classList.add('bi-exclamation-circle-fill', 'text-warning');
            }
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // ========== AI AUTO DETECT PLACEHOLDERS ==========
        async function autoDetectPlaceholders() {
            if (!currentContract) {
                showToast('Lỗi', 'Vui lòng chọn hợp đồng trước', 'error');
                return;
            }

            const fileType = currentContract.fileType || 'pdf';
            if (fileType !== 'word') {
                showToast('Thông báo', 'Tính năng AI chèn placeholder chỉ hỗ trợ file Word (.docx). File PDF sử dụng hệ thống marker overlay.', 'warning');
                return;
            }

            const btn = document.getElementById('aiDetectBtn');
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>AI đang phân tích...';
            btn.disabled = true;

            try {
                const wordContent = document.getElementById('wordContent');
                if (!wordContent) {
                    throw new Error('Không tìm thấy nội dung Word');
                }

                // Save original content if not saved
                if (!originalWordContent) {
                    originalWordContent = wordContent.innerHTML;
                }

                // Get text content
                const documentText = wordContent.innerText || wordContent.textContent;
                
                if (!documentText || documentText.trim().length < 50) {
                    throw new Error('Không thể đọc nội dung hợp đồng');
                }

                // Call Gemini API
                const placeholderSuggestions = await callGeminiAPI(documentText);
                
                if (placeholderSuggestions && placeholderSuggestions.length > 0) {
                    // Replace dots with placeholders in Word document
                    insertPlaceholdersInWord(placeholderSuggestions);
                } else {
                    showToast('Thông báo', 'AI không tìm thấy vị trí phù hợp để đặt placeholder', 'warning');
                }

            } catch (error) {
                console.error('AI Error:', error);
                showToast('Lỗi', 'Lỗi AI: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            }
        }

        function insertPlaceholdersInWord(suggestions) {
            const wordContent = document.getElementById('wordContent');
            if (!wordContent) return;

            const allPlaceholders = getAllPlaceholders();

            // Process each suggestion - add to custom placeholders
            suggestions.forEach(suggestion => {
                // Add to custom placeholders if not exists
                if (!allPlaceholders.some(p => p.field === suggestion.field)) {
                    customPlaceholders.push({
                        field: suggestion.field,
                        label: suggestion.label,
                        icon: 'bi-robot',
                        isDefault: false,
                        sampleData: suggestion.sampleData || suggestion.label
                    });
                }

                // Add to placeholderMappings
                if (!placeholderMappings.some(m => m.field === suggestion.field)) {
                    placeholderMappings.push({
                        field: suggestion.field,
                        label: suggestion.label,
                        sampleData: suggestion.sampleData || suggestion.label,
                        contextBefore: suggestion.contextBefore || ''
                    });
                }
            });

            // Replace dots with placeholder spans in the HTML
            replaceDotsWithPlaceholders(wordContent, suggestions);

            // Setup drag for newly inserted placeholders
            setupExistingPlaceholdersDrag(wordContent);

            // Save
            saveCustomPlaceholders();
            savePlaceholderMappings();
            renderPlaceholders();
            
            const insertedCount = document.querySelectorAll('.placeholder-inline').length;
            showToast('Thành công', `AI đã chèn ${insertedCount} placeholder. Kéo thả để di chuyển, click để chỉnh sửa.`, 'success');
        }

        function createPlaceholderSpan(field, label, sampleData) {
            // Tạo placeholder giống n8n - hiển thị label hoặc sample tùy viewMode
            const displayText = viewMode === 'label' ? label : sampleData;
            const sampleClass = viewMode === 'sample' ? ' sample-view' : '';
            const draggableAttr = viewMode === 'label' ? 'draggable="true"' : '';
            const removeIcon = viewMode === 'label' ? `<i class="bi bi-x remove-placeholder-inline" onclick="event.stopPropagation(); removeInlinePlaceholder(this)"></i>` : '';
            return `<span class="placeholder-inline${sampleClass}" ${draggableAttr} data-field="${escapeHtml(field)}" data-label="${escapeHtml(label)}" data-sample="${escapeHtml(sampleData)}" onclick="editInlinePlaceholder(this)" title="{{${field}}}">${escapeHtml(displayText)}${removeIcon}</span>`;
        }

        // Setup drop zone for Word content - giống n8n
        function setupWordDropZone(contentDiv) {
            // Make content editable for cursor positioning
            contentDiv.style.cursor = 'text';
            
            // Handle click to set cursor position
            contentDiv.addEventListener('click', function(e) {
                if (e.target.classList.contains('placeholder-inline') || 
                    e.target.closest('.placeholder-inline')) {
                    return;
                }
                
                // Get click position and create range
                const range = document.caretRangeFromPoint(e.clientX, e.clientY);
                if (range) {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    window.lastCaretRange = range.cloneRange();
                }
            });

            // Handle dragover
            contentDiv.addEventListener('dragover', function(e) {
                e.preventDefault();
                // Cho phép cả copy (từ sidebar) và move (di chuyển trong content)
                e.dataTransfer.dropEffect = 'copy';
                contentDiv.classList.add('drop-active');
                
                // Show drop position indicator
                const range = document.caretRangeFromPoint(e.clientX, e.clientY);
                if (range) {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            });

            // Handle dragleave
            contentDiv.addEventListener('dragleave', function(e) {
                contentDiv.classList.remove('drop-active');
            });

            // Handle drop - hỗ trợ cả thêm mới và di chuyển placeholder
            contentDiv.addEventListener('drop', function(e) {
                e.preventDefault();
                contentDiv.classList.remove('drop-active');
                
                // Get dropped placeholder data
                const field = e.dataTransfer.getData('field');
                const label = e.dataTransfer.getData('label');
                const sampleData = e.dataTransfer.getData('sampleData');
                const isMoving = e.dataTransfer.getData('isMoving') === 'true';
                
                if (!field) return;
                
                // Get drop position
                const range = document.caretRangeFromPoint(e.clientX, e.clientY);
                if (!range) return;
                
                // If moving existing placeholder, remove it first
                if (isMoving) {
                    const existingPlaceholder = contentDiv.querySelector(`.placeholder-inline[data-moving="true"]`);
                    if (existingPlaceholder) {
                        existingPlaceholder.remove();
                    }
                }
                
                // Create new placeholder element
                const placeholder = document.createElement('span');
                placeholder.className = viewMode === 'sample' ? 'placeholder-inline sample-view' : 'placeholder-inline';
                placeholder.dataset.field = field;
                placeholder.dataset.label = label;
                placeholder.dataset.sample = sampleData;
                placeholder.title = `{{${field}}}`;
                placeholder.draggable = viewMode === 'label';
                placeholder.onclick = function() { editInlinePlaceholder(this); };
                
                const displayText = viewMode === 'label' ? label : sampleData;
                if (viewMode === 'label') {
                    placeholder.innerHTML = `${escapeHtml(displayText)}<i class="bi bi-x remove-placeholder-inline" onclick="event.stopPropagation(); removeInlinePlaceholder(this)"></i>`;
                } else {
                    placeholder.textContent = displayText;
                }
                
                // Setup drag for new placeholder
                setupPlaceholderDrag(placeholder);
                
                // Insert at drop position
                range.insertNode(placeholder);
                
                // Move cursor after placeholder
                range.setStartAfter(placeholder);
                range.collapse(true);
                
                showToast('Đã thêm', `Đã chèn "${label}"`, 'success');
            });
            
            // Setup drag for existing placeholders
            setupExistingPlaceholdersDrag(contentDiv);
        }
        
        // Setup drag cho một placeholder
        function setupPlaceholderDrag(placeholder) {
            placeholder.addEventListener('dragstart', function(e) {
                if (viewMode !== 'label') {
                    e.preventDefault();
                    return;
                }
                
                e.dataTransfer.setData('field', this.dataset.field);
                e.dataTransfer.setData('label', this.dataset.label);
                e.dataTransfer.setData('sampleData', this.dataset.sample);
                e.dataTransfer.setData('isMoving', 'true');
                e.dataTransfer.effectAllowed = 'copyMove';
                
                this.classList.add('dragging');
                this.dataset.moving = 'true';
            });
            
            placeholder.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                delete this.dataset.moving;
            });
        }
        
        // Setup drag cho tất cả placeholders hiện có trong content
        function setupExistingPlaceholdersDrag(contentDiv) {
            const placeholders = contentDiv.querySelectorAll('.placeholder-inline');
            placeholders.forEach(placeholder => {
                setupPlaceholderDrag(placeholder);
            });
        }

        function editInlinePlaceholder(span) {
            // Close any existing popup
            const existingPopup = document.querySelector('.placeholder-edit-popup');
            if (existingPopup) existingPopup.remove();
            
            const field = span.dataset.field;
            const label = span.dataset.label;
            const sample = span.dataset.sample;
            
            // Create edit popup
            const popup = document.createElement('div');
            popup.className = 'placeholder-edit-popup';
            popup.innerHTML = `
                <div class="mb-2">
                    <label class="form-label small mb-1">Tên hiển thị</label>
                    <input type="text" class="form-control form-control-sm" id="editLabel" value="${escapeHtml(label)}">
                </div>
                <div class="mb-2">
                    <label class="form-label small mb-1">Tên biến (field)</label>
                    <input type="text" class="form-control form-control-sm" id="editField" value="${escapeHtml(field)}">
                </div>
                <div class="mb-2">
                    <label class="form-label small mb-1">Dữ liệu mẫu</label>
                    <input type="text" class="form-control form-control-sm" id="editSample" value="${escapeHtml(sample)}">
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-primary flex-fill" onclick="saveInlinePlaceholder(this)">
                        <i class="bi bi-check me-1"></i>Lưu
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="this.closest('.placeholder-edit-popup').remove()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            
            span.style.position = 'relative';
            span.appendChild(popup);
            
            // Focus on first input
            popup.querySelector('#editLabel').focus();
            
            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', function closePopup(e) {
                    if (!popup.contains(e.target) && e.target !== span) {
                        popup.remove();
                        document.removeEventListener('click', closePopup);
                    }
                });
            }, 100);
        }

        function saveInlinePlaceholder(btn) {
            const popup = btn.closest('.placeholder-edit-popup');
            const span = popup.parentElement;
            
            const newLabel = popup.querySelector('#editLabel').value.trim();
            const newField = popup.querySelector('#editField').value.trim().replace(/\s+/g, '_');
            const newSample = popup.querySelector('#editSample').value.trim();
            
            if (!newLabel || !newField) {
                showToast('Lỗi', 'Vui lòng nhập đầy đủ thông tin', 'error');
                return;
            }
            
            // Update span data
            span.dataset.field = newField;
            span.dataset.label = newLabel;
            span.dataset.sample = newSample;
            
            // Update display
            const displayText = viewMode === 'sample' ? newSample : `{{${newField}}}`;
            const labelSpan = span.querySelector('.placeholder-label');
            if (labelSpan) labelSpan.textContent = newLabel;
            const smallEl = span.querySelector('small');
            if (smallEl) smallEl.textContent = displayText;
            
            // Update custom placeholders list
            const existingIdx = customPlaceholders.findIndex(p => p.field === span.dataset.field);
            if (existingIdx >= 0) {
                customPlaceholders[existingIdx] = {
                    field: newField,
                    label: newLabel,
                    icon: 'bi-robot',
                    isDefault: false,
                    sampleData: newSample
                };
            }
            saveCustomPlaceholders();
            renderPlaceholders();
            
            popup.remove();
            showToast('Đã lưu', 'Placeholder đã được cập nhật', 'success');
        }

        function toggleViewMode(mode) {
            viewMode = mode;
            
            // Update button states
            document.getElementById('btnViewSample').classList.toggle('active', mode === 'sample');
            document.getElementById('btnViewLabel').classList.toggle('active', mode === 'label');
            
            // Update all placeholder spans - hiển thị label hoặc sample
            const placeholderSpans = document.querySelectorAll('.placeholder-inline');
            placeholderSpans.forEach(span => {
                const label = span.dataset.label;
                const sample = span.dataset.sample;
                const displayText = mode === 'sample' ? sample : label;
                
                // Toggle sample-view class để hiển thị text thuần hoặc tag
                if (mode === 'sample') {
                    span.classList.add('sample-view');
                    span.textContent = displayText;
                    span.draggable = false;
                } else {
                    span.classList.remove('sample-view');
                    span.textContent = displayText;
                    span.draggable = true;
                    // Thêm lại icon x
                    const icon = document.createElement('i');
                    icon.className = 'bi bi-x remove-placeholder-inline';
                    icon.onclick = function(e) {
                        e.stopPropagation();
                        removeInlinePlaceholder(this);
                    };
                    span.appendChild(icon);
                }
            });
        }

        function removeInlinePlaceholder(element) {
            event.stopPropagation();
            const span = element.parentElement;
            if (span && span.classList.contains('placeholder-inline')) {
                // Thay placeholder bằng dấu ... để có thể chèn lại
                const textNode = document.createTextNode('...........');
                span.parentNode.replaceChild(textNode, span);
                showToast('Đã xóa', 'Placeholder đã được xóa', 'success');
            }
        }

        function replaceDotsWithPlaceholders(container, suggestions) {
            // Get HTML content
            let html = container.innerHTML;
            
            // Track which suggestions have been used
            const usedSuggestions = new Set();
            
            // First pass: Use contextBefore from AI suggestions to match
            suggestions.forEach(suggestion => {
                if (usedSuggestions.has(suggestion.field)) return;
                
                const contextBefore = suggestion.contextBefore || '';
                if (contextBefore.length >= 2) {
                    // Escape special regex characters
                    const escapedContext = contextBefore.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    // Match context followed by dots/underscores/ellipsis
                    const regex = new RegExp(`(${escapedContext}[:\\s]*)([\.…_]{2,}|\\.\\.+)`, 'gi');
                    
                    html = html.replace(regex, (match, prefix, dots) => {
                        if (usedSuggestions.has(suggestion.field)) return match;
                        
                        usedSuggestions.add(suggestion.field);
                        return `${prefix}${createPlaceholderSpan(suggestion.field, suggestion.label, suggestion.sampleData)}`;
                    });
                }
            });
            
            // Second pass: Pattern-based matching for common fields
            const patterns = [
                { regex: /(Ông|Bà|Họ và tên|Họ tên)[:\s]*([\.…_]{2,})/gi, type: 'fullname' },
                { regex: /(Địa chỉ[^:]*|Thường trú|Nơi ở|tại địa chỉ)[:\s]*([\.…_]{2,})/gi, type: 'address' },
                { regex: /(CCCD|CMND|Căn cước|số CCCD|số CMND)[:\s]*([\.…_]{2,})/gi, type: 'idcard' },
                { regex: /(Điện thoại|Số ĐT|Phone|SĐT|Di động)[:\s]*([\.…_]{2,})/gi, type: 'phone' },
                { regex: /(Ngày sinh|Sinh ngày|Năm sinh)[:\s]*([\.…_]{2,})/gi, type: 'birthday' },
                { regex: /(Email|E-mail|Thư điện tử)[:\s]*([\.…_]{2,})/gi, type: 'email' },
                { regex: /(Số tiền|Giá trị|Trị giá|Tổng tiền)[:\s]*([\.…_]{2,})/gi, type: 'money' },
                { regex: /(cấp ngày|Ngày cấp)[:\s]*([\.…_]{2,})/gi, type: 'issue_date' },
            ];

            patterns.forEach(({ regex, type }) => {
                html = html.replace(regex, (match, prefix, dots) => {
                    // Find matching suggestion that hasn't been used
                    const suggestion = suggestions.find(s => 
                        !usedSuggestions.has(s.field) && 
                        (s.field.toLowerCase().includes(type) || 
                         s.label.toLowerCase().includes(type) ||
                         type.includes(s.field.toLowerCase()))
                    );
                    
                    if (suggestion) {
                        usedSuggestions.add(suggestion.field);
                        return `${prefix} ${createPlaceholderSpan(suggestion.field, suggestion.label, suggestion.sampleData)}`;
                    }
                    return match;
                });
            });

            // Third pass: Replace remaining dots with unused suggestions
            const remainingSuggestions = suggestions.filter(s => !usedSuggestions.has(s.field));
            let suggestionIndex = 0;
            
            // Match any sequence of 3+ dots/underscores that hasn't been replaced
            html = html.replace(/([\.…_]{3,})/g, (match) => {
                // Skip if already inside a placeholder span
                if (suggestionIndex < remainingSuggestions.length) {
                    const suggestion = remainingSuggestions[suggestionIndex++];
                    usedSuggestions.add(suggestion.field);
                    return createPlaceholderSpan(suggestion.field, suggestion.label, suggestion.sampleData);
                }
                return match;
            });

            container.innerHTML = html;
            
            console.log(`Replaced ${usedSuggestions.size}/${suggestions.length} placeholders`);
        }

        function savePlaceholderMappings() {
            if (currentContract) {
                currentContract.placeholderMappings = placeholderMappings;
                saveContracts();
            }
        }

        function loadPlaceholderMappings() {
            if (currentContract && currentContract.placeholderMappings) {
                placeholderMappings = currentContract.placeholderMappings;
            } else {
                placeholderMappings = [];
            }
        }

        async function extractPdfText() {
            if (!currentPdf) return '';
            
            let fullText = '';
            for (let i = 1; i <= currentPdf.numPages; i++) {
                const page = await currentPdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
            }
            return fullText;
        }

        async function callGeminiAPI(documentText) {
            const prompt = `Bạn là chuyên gia phân tích hợp đồng/văn bản pháp lý Việt Nam. Nhiệm vụ: tìm CHÍNH XÁC các vị trí cần điền thông tin.

NGUYÊN TẮC QUAN TRỌNG:
1. Phân tích NGỮ CẢNH xung quanh để xác định ĐÚNG loại thông tin cần điền
2. Ví dụ: "Ngày...tháng...năm" → điền ngày/tháng/năm, KHÔNG phải họ tên hay số CCCD
3. "Ông/Bà:..." hoặc "Họ và tên:..." → điền họ tên
4. "Số CCCD/CMND:..." → điền số CCCD
5. "Sinh ngày:..." → điền ngày sinh
6. "Địa chỉ:..." → điền địa chỉ
7. "Số tiền:...đồng" hoặc "...VNĐ" → điền số tiền
8. Nếu có "Bên A", "Bên B", "Bên thuê", "Bên cho thuê" → đánh số rõ ràng

Hợp đồng:
"""
${documentText.substring(0, 15000)}
"""

Yêu cầu:
1. Tìm TẤT CẢ vị trí có dấu "...", "…", "___" hoặc chỗ trống cần điền
2. Đọc KỸ từ/cụm từ TRƯỚC chỗ điền để xác định loại thông tin CHÍNH XÁC
3. Phân biệt rõ các loại:
   - HỌ TÊN: sau "Ông/Bà:", "Họ và tên:", "Tên:"
   - NGÀY THÁNG: sau "ngày", "tháng", "năm", "Ngày ký:"
   - NGÀY SINH: sau "sinh ngày", "ngày sinh"
   - SỐ CCCD: sau "CCCD số:", "CMND số:", "Số CCCD:"
   - ĐỊA CHỈ: sau "Địa chỉ:", "thường trú:", "ĐKTT:", "tại:"
   - SỐ TIỀN: sau "Số tiền:", "giá:", trước "đồng", "VNĐ"
   - SỐ ĐIỆN THOẠI: sau "SĐT:", "Điện thoại:"
   - NGÀY CẤP: sau "cấp ngày:", "ngày cấp:"
   - NƠI CẤP: sau "cấp tại:", "nơi cấp:", "do...cấp"

4. contextBefore: từ/cụm từ NGAY TRƯỚC chỗ cần điền (5-20 ký tự)
5. Đánh số: fullname_ben_a, fullname_ben_b, address_ben_a, v.v.

Trả về JSON array:
[
  {
    "contextBefore": "Ông/Bà:",
    "field": "fullname_ben_a",
    "label": "Họ tên bên A",
    "sampleData": "Nguyễn Văn A"
  },
  {
    "contextBefore": "CCCD số:",
    "field": "cccd_ben_a",
    "label": "Số CCCD bên A",
    "sampleData": "001234567890"
  },
  {
    "contextBefore": "Ngày",
    "field": "ngay_ky",
    "label": "Ngày ký",
    "sampleData": "15"
  },
  {
    "contextBefore": "tháng",
    "field": "thang_ky",
    "label": "Tháng ký",
    "sampleData": "06"
  },
  {
    "contextBefore": "năm",
    "field": "nam_ky",
    "label": "Năm ký",
    "sampleData": "2024"
  }
]

CHÚ Ý: 
- Mỗi chỗ "..." là một placeholder RIÊNG
- KHÔNG nhầm lẫn giữa các loại thông tin
- Dữ liệu mẫu phải PHÙ HỢP với loại thông tin (ngày thì là số ngày, tên thì là tên người...)

Chỉ trả về JSON array, không có text khác.`;

            const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 8192
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Lỗi gọi Gemini API');
            }

            const data = await response.json();
            const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            
            // Parse JSON from response
            try {
                // Extract JSON from response (may have markdown code blocks)
                let jsonStr = responseText;
                if (responseText.includes('```json')) {
                    jsonStr = responseText.split('```json')[1].split('```')[0];
                } else if (responseText.includes('```')) {
                    jsonStr = responseText.split('```')[1].split('```')[0];
                }
                return JSON.parse(jsonStr.trim());
            } catch (e) {
                console.error('Parse error:', e, responseText);
                throw new Error('Không thể phân tích kết quả từ AI');
            }
        }

        function showAISuggestions(suggestions) {
            // Create modal
            const modalHtml = `
                <div class="modal fade" id="aiSuggestionsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title"><i class="bi bi-robot me-2"></i>AI đề xuất Placeholder</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-muted mb-3">AI đã tìm thấy ${suggestions.length} vị trí có thể đặt placeholder. Chọn các mục bạn muốn thêm:</p>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="40"><input type="checkbox" id="selectAllSuggestions" checked></th>
                                                <th>Text gốc</th>
                                                <th>Placeholder</th>
                                                <th>Dữ liệu mẫu</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${suggestions.map((s, i) => `
                                                <tr>
                                                    <td><input type="checkbox" class="suggestion-check" data-index="${i}" checked></td>
                                                    <td><small class="text-muted">${escapeHtml(s.originalText?.substring(0, 50) || '')}</small></td>
                                                    <td><strong>${escapeHtml(s.label)}</strong><br><code>${escapeHtml(s.field)}</code></td>
                                                    <td>${escapeHtml(s.sampleData)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                <button type="button" class="btn btn-primary" onclick="applyAISuggestions()">
                                    <i class="bi bi-check-lg me-1"></i>Áp dụng đã chọn
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove old modal if exists
            const oldModal = document.getElementById('aiSuggestionsModal');
            if (oldModal) oldModal.remove();

            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Store suggestions for later
            window.aiSuggestions = suggestions;

            // Setup select all checkbox
            document.getElementById('selectAllSuggestions').addEventListener('change', function() {
                document.querySelectorAll('.suggestion-check').forEach(cb => cb.checked = this.checked);
            });

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('aiSuggestionsModal'));
            modal.show();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function applyAISuggestions() {
            const suggestions = window.aiSuggestions || [];
            const selectedIndexes = [];
            
            document.querySelectorAll('.suggestion-check:checked').forEach(cb => {
                selectedIndexes.push(parseInt(cb.dataset.index));
            });

            if (selectedIndexes.length === 0) {
                showToast('Thông báo', 'Vui lòng chọn ít nhất một placeholder', 'warning');
                return;
            }

            // Add placeholders to custom list
            let addedCount = 0;
            const allPlaceholders = getAllPlaceholders();
            
            selectedIndexes.forEach(index => {
                const s = suggestions[index];
                if (s && !allPlaceholders.some(p => p.field === s.field)) {
                    customPlaceholders.push({
                        field: s.field,
                        label: s.label,
                        icon: 'bi-robot',
                        isDefault: false,
                        sampleData: s.sampleData || s.label,
                        originalText: s.originalText
                    });
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                saveCustomPlaceholders();
                renderPlaceholders();
                showToast('Thành công', `Đã thêm ${addedCount} placeholder từ AI`, 'success');
            } else {
                showToast('Thông báo', 'Các placeholder đã tồn tại', 'warning');
            }

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('aiSuggestionsModal')).hide();
        }

        // ========== EXPOSE FOR N8N ==========
        window.addContractFromN8n = addContract;
    </script>
</body>
</html>
