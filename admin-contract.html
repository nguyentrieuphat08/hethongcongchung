<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Mẫu Hợp đồng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .sidebar {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .nav-link.active {
            background-color: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .placeholder-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: grab;
            font-size: 13px;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
        }
        .placeholder-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .placeholder-item:active {
            cursor: grabbing;
        }
        .drag-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0.9;
        }
        .placeholder-item .delete-placeholder {
            float: right;
            cursor: pointer;
            opacity: 0.7;
        }
        .placeholder-item .delete-placeholder:hover {
            opacity: 1;
        }
        .custom-placeholder {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .pdf-container {
            position: relative;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            min-height: 600px;
            background-color: #f8f9fa;
            overflow: auto;
        }
        .pdf-container.drag-over {
            border-color: #667eea;
            background-color: #f0f4ff;
        }
        .pdf-page {
            position: relative;
            margin: 20px auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .field-marker {
            position: absolute;
            background-color: transparent;
            color: #000;
            padding: 2px 4px;
            border: none;
            cursor: grab;
            white-space: nowrap;
            z-index: 100;
            user-select: none;
        }
        .field-marker:hover {
            background-color: rgba(102, 126, 234, 0.15);
            border: 1px dashed #667eea;
            border-radius: 2px;
        }
        .field-marker:active, .field-marker.dragging {
            cursor: grabbing;
            background-color: rgba(102, 126, 234, 0.25);
            border: 2px solid #667eea;
            z-index: 1000;
        }
        .field-marker .remove-marker {
            display: none;
        }
        .field-marker:hover .remove-marker {
            display: inline;
        }
        .field-marker .remove-marker {
            margin-left: 8px;
            cursor: pointer;
            opacity: 0.8;
        }
        .field-marker .remove-marker:hover {
            opacity: 1;
        }
        .add-placeholder-form {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        .contract-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .contract-item:hover {
            background-color: #e9ecef;
        }
        .page-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .word-document {
            position: relative;
            background: white;
            margin: 20px auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-height: 800px;
            overflow: hidden;
        }
        .word-document .docx-wrapper {
            background: white !important;
            padding: 0 !important;
        }
        .word-document section.docx {
            box-shadow: none !important;
            margin-bottom: 0 !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar text-white p-0">
                <div class="p-3">
                    <h4 class="mb-4">MENU</h4>
                    <div class="nav flex-column" id="mainMenu">
                        <a href="admin-contract.html" class="nav-link text-white active mb-2">
                            <i class="bi bi-gear-fill me-2"></i>Quản lý Mẫu Hợp đồng
                        </a>
                        <a href="user-extract.html" class="nav-link text-white mb-2">
                            <i class="bi bi-card-image me-2"></i>Trích xuất thông tin
                        </a>
                        <a href="user-chat.html" class="nav-link text-white mb-2">
                            <i class="bi bi-chat-dots-fill me-2"></i>Chat AI
                        </a>
                    </div>
                    <div class="mt-4 text-center">
                        <small>Phiên bản 1.0</small>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4 main-content">
                <div class="bg-white rounded shadow-sm p-4">
                    <h3 class="mb-4">
                        <i class="bi bi-file-earmark-text me-2"></i>Quản lý Mẫu Hợp đồng
                    </h3>

                    <!-- API Endpoint Info -->
                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>API Endpoint để n8n gửi hợp đồng</h6>
                        <p class="mb-1"><strong>URL:</strong> <code id="apiEndpoint"></code></p>
                        <p class="mb-1"><strong>Method:</strong> <code>POST</code></p>
                        <p class="mb-0"><strong>Body:</strong> <code>{ "name": "Tên hợp đồng", "url": "https://link-to-pdf...", "description": "Mô tả" }</code></p>
                    </div>

                    <!-- Thêm hợp đồng thủ công -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-plus-circle me-2"></i>Thêm hợp đồng mới
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-5">
                                    <label class="form-label">Tên hợp đồng</label>
                                    <input type="text" class="form-control" id="uploadContractName" placeholder="VD: Hợp đồng mua bán nhà">
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label">Chọn file PDF hoặc Word</label>
                                    <input type="file" class="form-control" id="uploadContractFile" accept=".pdf,.docx,.doc">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" onclick="uploadContractFile()">
                                        <i class="bi bi-upload me-1"></i>Upload
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Contract Selection and Editor -->
                    <div class="row">
                        <!-- Left Panel: Contract Selection & Placeholders -->
                        <div class="col-md-3">
                            <!-- Chọn hợp đồng -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-file-text me-2"></i>Chọn hợp đồng
                                </label>
                                <select class="form-select" id="contractSelect" onchange="loadContract()">
                                    <option value="">-- Chọn hợp đồng --</option>
                                </select>
                                <button class="btn btn-outline-danger btn-sm w-100 mt-2" onclick="deleteSelectedContract()" id="deleteContractBtn" style="display: none;">
                                    <i class="bi bi-trash me-1"></i>Xóa hợp đồng này
                                </button>
                            </div>

                            <!-- Thêm placeholder tùy chỉnh -->
                            <div class="add-placeholder-form">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-plus-circle me-2"></i>Thêm Placeholder mới
                                </label>
                                <div class="input-group input-group-sm mb-2">
                                    <input type="text" class="form-control" id="newPlaceholderName" placeholder="Tên hiển thị">
                                </div>
                                <div class="input-group input-group-sm mb-2">
                                    <input type="text" class="form-control" id="newPlaceholderField" placeholder="Tên biến (VD: so_hop_dong)">
                                </div>
                                <div class="input-group input-group-sm mb-2">
                                    <input type="text" class="form-control" id="newPlaceholderSample" placeholder="Dữ liệu mẫu (VD: HD-001)">
                                </div>
                                <button class="btn btn-success btn-sm w-100" onclick="addCustomPlaceholder()">
                                    <i class="bi bi-plus-lg me-1"></i>Thêm Placeholder
                                </button>
                            </div>

                            <!-- Cài đặt font chữ -->
                            <div class="card mb-3">
                                <div class="card-header py-2">
                                    <small class="fw-bold"><i class="bi bi-fonts me-1"></i>Cài đặt font chữ</small>
                                </div>
                                <div class="card-body py-2">
                                    <div class="mb-2">
                                        <label class="form-label small mb-1">Font chữ</label>
                                        <select class="form-select form-select-sm" id="fontFamily" onchange="updateFontSettings()">
                                            <option value="'Times New Roman', Times, serif">Times New Roman</option>
                                            <option value="Arial, sans-serif">Arial</option>
                                            <option value="'Courier New', monospace">Courier New</option>
                                            <option value="Georgia, serif">Georgia</option>
                                            <option value="Verdana, sans-serif">Verdana</option>
                                            <option value="Tahoma, sans-serif">Tahoma</option>
                                            <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                                            <option value="'Palatino Linotype', serif">Palatino</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="form-label small mb-1">Cỡ chữ gốc (px)</label>
                                        <input type="number" class="form-control form-control-sm" id="fontSize" value="13" min="8" max="36" onchange="updateFontSettings()">
                                        <small class="text-muted">Sẽ tự động scale theo PDF</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Danh sách placeholder -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-tags me-2"></i>Các biến Placeholder
                                </label>
                                <small class="d-block text-muted mb-2">Kéo thả vào hợp đồng bên phải</small>
                            </div>

                            <div id="placeholdersList"></div>

                            <div class="mt-4">
                                <button class="btn btn-success w-100" onclick="saveContractConfig()" id="saveBtn" disabled>
                                    <i class="bi bi-save me-2"></i>Lưu cấu hình
                                </button>
                                <button class="btn btn-warning w-100 mt-2" onclick="clearAllMarkers()" id="clearMarkersBtn" disabled>
                                    <i class="bi bi-eraser me-2"></i>Xóa tất cả marker
                                </button>
                            </div>
                        </div>

                        <!-- Right Panel: Contract Canvas -->
                        <div class="col-md-9">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label fw-bold mb-0">
                                    <i class="bi bi-file-pdf me-2"></i>Hợp đồng mẫu
                                </label>
                                <div id="pageInfo" style="display: none;">
                                    <span class="badge bg-secondary">Trang <span id="currentPageNum">1</span> / <span id="totalPages">1</span></span>
                                </div>
                            </div>

                            <div class="pdf-container" id="pdfContainer">
                                <div class="alert alert-secondary text-center m-4">
                                    <i class="bi bi-arrow-left-circle me-2"></i>
                                    Chọn một hợp đồng từ menu bên trái để bắt đầu chỉnh sửa
                                </div>
                            </div>

                            <!-- Page Navigation -->
                            <div class="page-navigation" id="pageNavigation" style="display: none;">
                                <button class="btn btn-outline-primary btn-sm" onclick="prevPage()" id="prevPageBtn">
                                    <i class="bi bi-chevron-left"></i> Trang trước
                                </button>
                                <span id="pageIndicator">1 / 1</span>
                                <button class="btn btn-outline-primary btn-sm" onclick="nextPage()" id="nextPageBtn">
                                    Trang sau <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-check-circle-fill text-success me-2" id="toastIcon"></i>
                <strong class="me-auto" id="toastTitle">Thông báo</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx-preview@0.1.4/dist/docx-preview.min.js"></script>
    <script>
        // ========== CONFIGURATION ==========
        const CONTRACTS_KEY = 'contracts';
        const PLACEHOLDERS_KEY = 'custom_placeholders';
        const API_ENDPOINT = window.location.origin + '/api/receive-contract';
        const CONTRACTS_API = window.location.origin + '/api/contracts';
        
        // Multiple CORS proxies to try
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://proxy.cors.sh/'
        ];

        // Default placeholders with sample data
        const DEFAULT_PLACEHOLDERS = [
            { field: 'fullname', label: 'Họ và tên', icon: 'bi-person-fill', isDefault: true, sampleData: 'Nguyễn Văn A' },
            { field: 'birthday', label: 'Ngày sinh', icon: 'bi-calendar-event', isDefault: true, sampleData: '01/01/1990' },
            { field: 'idcard', label: 'Số CMND/CCCD', icon: 'bi-credit-card-2-front', isDefault: true, sampleData: '001234567890' },
            { field: 'issue_date', label: 'Ngày cấp', icon: 'bi-calendar-check', isDefault: true, sampleData: '01/01/2020' },
            { field: 'expiry_date', label: 'Ngày hết hạn', icon: 'bi-calendar-x', isDefault: true, sampleData: '01/01/2030' },
            { field: 'address', label: 'Địa chỉ', icon: 'bi-geo-alt-fill', isDefault: true, sampleData: '123 Đường ABC, Quận 1, TP.HCM' },
            { field: 'phone', label: 'Số điện thoại', icon: 'bi-telephone-fill', isDefault: true, sampleData: '0901234567' },
            { field: 'email', label: 'Email', icon: 'bi-envelope-fill', isDefault: true, sampleData: 'email@example.com' }
        ];

        // ========== STATE ==========
        let contracts = [];
        let customPlaceholders = [];
        let currentContract = null;
        let currentPdf = null;
        let currentPage = 1;
        let totalPages = 1;
        let markers = [];
        let fontSettings = {
            fontFamily: "'Times New Roman', Times, serif",
            fontSize: 13
        };
        let pdfScale = 1.5; // PDF render scale
        
        // Drag state
        let isDragging = false;
        let dragType = null; // 'placeholder' or 'marker'
        let dragData = null;
        let dragGhost = null;
        let dragOffset = { x: 0, y: 0 };

        // ========== INITIALIZATION ==========
        window.addEventListener('load', async () => {
            document.getElementById('apiEndpoint').textContent = API_ENDPOINT;
            loadFontSettings();
            await loadContracts();
            loadCustomPlaceholders();
            renderPlaceholders();
            setupReceiveContract();
            
            // Auto-refresh contracts every 10 seconds
            setInterval(fetchContractsFromAPI, 10000);
        });

        // ========== FONT SETTINGS ==========
        function loadFontSettings() {
            const saved = localStorage.getItem('fontSettings');
            if (saved) {
                fontSettings = JSON.parse(saved);
                document.getElementById('fontFamily').value = fontSettings.fontFamily;
                document.getElementById('fontSize').value = fontSettings.fontSize;
            }
        }

        function saveFontSettings() {
            localStorage.setItem('fontSettings', JSON.stringify(fontSettings));
        }

        function updateFontSettings() {
            fontSettings.fontFamily = document.getElementById('fontFamily').value;
            fontSettings.fontSize = parseInt(document.getElementById('fontSize').value) || 13;
            saveFontSettings();
            renderMarkers();
        }

        // Setup to receive contract from n8n (via URL params or postMessage)
        function setupReceiveContract() {
            // Check URL params
            const urlParams = new URLSearchParams(window.location.search);
            const name = urlParams.get('name');
            const url = urlParams.get('url');
            
            if (name && url) {
                addContract({ name: decodeURIComponent(name), url: decodeURIComponent(url) });
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // Listen for postMessage
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'add-contract') {
                    addContract(event.data.contract);
                }
            });
        }

        // ========== CONTRACTS MANAGEMENT ==========
        async function loadContracts() {
            // Load from localStorage first
            const saved = localStorage.getItem(CONTRACTS_KEY);
            contracts = saved ? JSON.parse(saved) : [];
            
            // Then fetch from API to get contracts from n8n
            await fetchContractsFromAPI();
            
            renderContractSelect();
        }

        async function fetchContractsFromAPI() {
            try {
                const response = await fetch(CONTRACTS_API);
                const data = await response.json();
                
                if (data.success && data.contracts && data.contracts.length > 0) {
                    // Merge with existing contracts (avoid duplicates)
                    data.contracts.forEach(apiContract => {
                        const exists = contracts.some(c => c.url === apiContract.url);
                        if (!exists) {
                            contracts.push(apiContract);
                        }
                    });
                    
                    saveContracts();
                    renderContractSelect();
                }
            } catch (error) {
                console.log('Could not fetch contracts from API:', error);
            }
        }

        function saveContracts() {
            localStorage.setItem(CONTRACTS_KEY, JSON.stringify(contracts));
        }

        function renderContractSelect() {
            const select = document.getElementById('contractSelect');
            select.innerHTML = '<option value="">-- Chọn hợp đồng --</option>';
            
            contracts.forEach((contract, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = contract.name;
                select.appendChild(option);
            });
        }

        function addContract(contractData) {
            const { name, url, description } = contractData;
            
            if (!name || !url) {
                showToast('Lỗi', 'Thiếu tên hoặc URL hợp đồng', 'error');
                return;
            }

            // Check duplicate
            if (contracts.some(c => c.url === url)) {
                showToast('Thông báo', 'Hợp đồng này đã tồn tại', 'warning');
                return;
            }

            contracts.push({
                id: 'contract_' + Date.now(),
                name,
                url,
                description: description || '',
                markers: [],
                createdAt: new Date().toISOString()
            });

            saveContracts();
            renderContractSelect();
            showToast('Thành công', `Đã thêm hợp đồng: ${name}`, 'success');
        }

        function addContractManually() {
            const name = document.getElementById('newContractName').value.trim();
            const url = document.getElementById('newContractUrl').value.trim();

            if (!name || !url) {
                showToast('Lỗi', 'Vui lòng nhập đầy đủ tên và URL', 'error');
                return;
            }

            addContract({ name, url });
            
            document.getElementById('newContractName').value = '';
            document.getElementById('newContractUrl').value = '';
        }

        function deleteSelectedContract() {
            const select = document.getElementById('contractSelect');
            const index = parseInt(select.value);
            
            if (isNaN(index)) return;
            
            if (confirm(`Bạn có chắc muốn xóa hợp đồng "${contracts[index].name}"?`)) {
                contracts.splice(index, 1);
                saveContracts();
                renderContractSelect();
                currentContract = null;
                currentPdf = null;
                markers = [];
                
                document.getElementById('pdfContainer').innerHTML = `
                    <div class="alert alert-secondary text-center m-4">
                        <i class="bi bi-arrow-left-circle me-2"></i>
                        Chọn một hợp đồng từ menu bên trái để bắt đầu chỉnh sửa
                    </div>
                `;
                document.getElementById('deleteContractBtn').style.display = 'none';
                document.getElementById('pageNavigation').style.display = 'none';
                document.getElementById('pageInfo').style.display = 'none';
                document.getElementById('saveBtn').disabled = true;
                document.getElementById('clearMarkersBtn').disabled = true;
                
                showToast('Đã xóa', 'Hợp đồng đã được xóa', 'success');
            }
        }

        // Upload PDF or Word file from computer
        function uploadContractFile() {
            const name = document.getElementById('uploadContractName').value.trim();
            const fileInput = document.getElementById('uploadContractFile');
            const file = fileInput.files[0];

            if (!name) {
                showToast('Lỗi', 'Vui lòng nhập tên hợp đồng', 'error');
                return;
            }

            if (!file) {
                showToast('Lỗi', 'Vui lòng chọn file', 'error');
                return;
            }

            const isPdf = file.type === 'application/pdf' || file.name.endsWith('.pdf');
            const isWord = file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || 
                          file.name.endsWith('.docx') || file.name.endsWith('.doc');

            if (!isPdf && !isWord) {
                showToast('Lỗi', 'Vui lòng chọn file PDF hoặc Word (.docx)', 'error');
                return;
            }

            // Check if duplicate
            if (contracts.some(c => c.name === name)) {
                showToast('Lỗi', 'Tên hợp đồng đã tồn tại', 'error');
                return;
            }

            // Read file
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                
                contracts.push({
                    id: 'contract_' + Date.now(),
                    name,
                    url: dataUrl,
                    fileType: isPdf ? 'pdf' : 'word',
                    isLocal: true,
                    description: '',
                    markers: [],
                    createdAt: new Date().toISOString()
                });

                saveContracts();
                renderContractSelect();
                showToast('Thành công', `Đã upload hợp đồng: ${name}`, 'success');
                
                // Clear form
                document.getElementById('uploadContractName').value = '';
                fileInput.value = '';
            };

            reader.onerror = function() {
                showToast('Lỗi', 'Không thể đọc file', 'error');
            };

            reader.readAsDataURL(file);
        }

        // ========== PLACEHOLDERS MANAGEMENT ==========
        function loadCustomPlaceholders() {
            const saved = localStorage.getItem(PLACEHOLDERS_KEY);
            customPlaceholders = saved ? JSON.parse(saved) : [];
        }

        function saveCustomPlaceholders() {
            localStorage.setItem(PLACEHOLDERS_KEY, JSON.stringify(customPlaceholders));
        }

        function getAllPlaceholders() {
            return [...DEFAULT_PLACEHOLDERS, ...customPlaceholders];
        }

        function renderPlaceholders() {
            const container = document.getElementById('placeholdersList');
            container.innerHTML = '';
            
            const allPlaceholders = getAllPlaceholders();
            
            allPlaceholders.forEach((placeholder, index) => {
                const div = document.createElement('div');
                div.className = `placeholder-item ${placeholder.isDefault ? '' : 'custom-placeholder'}`;
                div.dataset.field = placeholder.field;
                div.dataset.label = placeholder.label;
                
                div.innerHTML = `
                    <i class="${placeholder.icon || 'bi-tag'} me-2"></i>
                    <span>${placeholder.label}</span>
                    <small class="d-block text-light opacity-75" style="font-size: 10px;">${placeholder.sampleData || ''}</small>
                    ${!placeholder.isDefault ? `<i class="bi bi-x-circle delete-placeholder" onclick="event.stopPropagation(); deleteCustomPlaceholder('${placeholder.field}')"></i>` : ''}
                `;
                
                // Mouse down - start drag
                div.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('delete-placeholder')) return;
                    e.preventDefault();
                    startDragPlaceholder(e, placeholder);
                });
                
                container.appendChild(div);
            });
        }

        // ========== IMPROVED DRAG SYSTEM ==========
        function startDragPlaceholder(e, placeholder) {
            isDragging = true;
            dragType = 'placeholder';
            dragData = {
                field: placeholder.field,
                label: placeholder.label,
                sampleData: placeholder.sampleData || placeholder.label
            };
            
            // Create ghost element
            createDragGhost(placeholder.label, e.clientX, e.clientY);
            
            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('mouseup', onDragEnd);
        }

        function startDragMarker(e, marker, markerElement) {
            e.preventDefault();
            e.stopPropagation();
            
            isDragging = true;
            dragType = 'marker';
            dragData = marker;
            
            const rect = markerElement.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            markerElement.classList.add('dragging');
            
            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('mouseup', onDragEnd);
        }

        function createDragGhost(text, x, y) {
            dragGhost = document.createElement('div');
            dragGhost.className = 'drag-ghost';
            dragGhost.textContent = text;
            dragGhost.style.left = (x + 10) + 'px';
            dragGhost.style.top = (y + 10) + 'px';
            document.body.appendChild(dragGhost);
        }

        function onDragMove(e) {
            if (!isDragging) return;
            
            if (dragType === 'placeholder' && dragGhost) {
                dragGhost.style.left = (e.clientX + 10) + 'px';
                dragGhost.style.top = (e.clientY + 10) + 'px';
            } else if (dragType === 'marker') {
                const container = document.getElementById('markersContainer');
                if (!container) return;
                
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left - dragOffset.x;
                const y = e.clientY - rect.top - dragOffset.y;
                
                // Update marker position in real-time
                dragData.x = Math.max(0, Math.min(x, rect.width - 50));
                dragData.y = Math.max(0, Math.min(y, rect.height - 20));
                
                const markerEl = document.querySelector(`[data-marker-id="${dragData.id}"]`);
                if (markerEl) {
                    markerEl.style.left = dragData.x + 'px';
                    markerEl.style.top = dragData.y + 'px';
                }
            }
        }

        function onDragEnd(e) {
            if (!isDragging) return;
            
            document.removeEventListener('mousemove', onDragMove);
            document.removeEventListener('mouseup', onDragEnd);
            
            if (dragType === 'placeholder') {
                // Remove ghost
                if (dragGhost) {
                    dragGhost.remove();
                    dragGhost = null;
                }
                
                // Check if dropped on PDF
                const pdfPage = document.getElementById('pdfPage');
                if (pdfPage) {
                    const rect = pdfPage.getBoundingClientRect();
                    if (e.clientX >= rect.left && e.clientX <= rect.right &&
                        e.clientY >= rect.top && e.clientY <= rect.bottom) {
                        
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        markers.push({
                            id: 'marker_' + Date.now(),
                            field: dragData.field,
                            label: dragData.label,
                            sampleData: dragData.sampleData,
                            page: currentPage,
                            x,
                            y
                        });
                        
                        renderMarkers();
                    }
                }
            } else if (dragType === 'marker') {
                // Marker already updated in real-time
                document.querySelectorAll('.field-marker').forEach(el => el.classList.remove('dragging'));
            }
            
            isDragging = false;
            dragType = null;
            dragData = null;
        }

        function addCustomPlaceholder() {
            const name = document.getElementById('newPlaceholderName').value.trim();
            const field = document.getElementById('newPlaceholderField').value.trim().toLowerCase().replace(/\s+/g, '_');
            const sampleData = document.getElementById('newPlaceholderSample').value.trim();
            
            if (!name || !field) {
                showToast('Lỗi', 'Vui lòng nhập đầy đủ thông tin', 'error');
                return;
            }

            // Check duplicate
            const allPlaceholders = getAllPlaceholders();
            if (allPlaceholders.some(p => p.field === field)) {
                showToast('Lỗi', 'Tên biến đã tồn tại', 'error');
                return;
            }

            customPlaceholders.push({
                field,
                label: name,
                icon: 'bi-tag-fill',
                isDefault: false,
                sampleData: sampleData || name
            });

            saveCustomPlaceholders();
            renderPlaceholders();
            
            document.getElementById('newPlaceholderName').value = '';
            document.getElementById('newPlaceholderField').value = '';
            document.getElementById('newPlaceholderSample').value = '';
            
            showToast('Thành công', `Đã thêm placeholder: ${name}`, 'success');
        }

        function deleteCustomPlaceholder(field) {
            if (confirm('Bạn có chắc muốn xóa placeholder này?')) {
                customPlaceholders = customPlaceholders.filter(p => p.field !== field);
                saveCustomPlaceholders();
                renderPlaceholders();
                showToast('Đã xóa', 'Placeholder đã được xóa', 'success');
            }
        }

        // ========== PDF LOADING & RENDERING ==========
        function getPdfUrl(originalUrl) {
            // If it's a data URL (local file), return as is
            if (originalUrl.startsWith('data:')) {
                return originalUrl;
            }
            
            // If it's a direct PDF link (not Google Drive), return as is
            if (!originalUrl.includes('drive.google.com')) {
                return originalUrl;
            }
            
            // Google Drive is not supported for direct loading
            // Return null to show error message
            return null;
        }

        async function loadContract() {
            const select = document.getElementById('contractSelect');
            const index = parseInt(select.value);
            
            if (isNaN(index)) {
                document.getElementById('deleteContractBtn').style.display = 'none';
                return;
            }
            
            document.getElementById('deleteContractBtn').style.display = 'block';
            
            currentContract = contracts[index];
            markers = currentContract.markers || [];
            
            // Determine file type
            const fileType = currentContract.fileType || 'pdf';
            
            if (fileType === 'word') {
                await loadWordDocument();
            } else {
                await loadPdfDocument();
            }
        }

        async function loadPdfDocument() {
            try {
                document.getElementById('pdfContainer').innerHTML = `
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3">Đang tải PDF...</p>
                    </div>
                `;
                
                // Initialize PDF.js
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                // Get PDF URL
                const pdfUrl = getPdfUrl(currentContract.url);
                
                if (pdfUrl === null) {
                    document.getElementById('pdfContainer').innerHTML = `
                        <div class="alert alert-danger m-4">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Không thể tải PDF từ Google Drive</strong>
                            <br><br>
                            Google Drive không cho phép tải trực tiếp từ web. Vui lòng:
                            <ol class="mt-2 mb-0">
                                <li>Tải file PDF về máy tính</li>
                                <li>Dùng tab <strong>"Upload từ máy tính"</strong> để upload lên</li>
                            </ol>
                        </div>
                    `;
                    return;
                }
                
                console.log('Loading PDF from:', pdfUrl.substring(0, 100) + '...');
                
                // Load PDF
                currentPdf = await pdfjsLib.getDocument(pdfUrl).promise;
                totalPages = currentPdf.numPages;
                currentPage = 1;
                pdfScale = 1.5; // PDF scale
                
                await renderPage(currentPage);
                
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('clearMarkersBtn').disabled = false;
                document.getElementById('pageNavigation').style.display = totalPages > 1 ? 'flex' : 'none';
                document.getElementById('pageInfo').style.display = 'block';
                document.getElementById('totalPages').textContent = totalPages;
                
                updatePageNavigation();
                
            } catch (error) {
                console.error('Error loading PDF:', error);
                document.getElementById('pdfContainer').innerHTML = `
                    <div class="alert alert-danger m-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Lỗi khi tải PDF: ${error.message}
                        <br><small>URL: ${currentContract.url}</small>
                    </div>
                `;
            }
        }

        async function loadWordDocument() {
            try {
                document.getElementById('pdfContainer').innerHTML = `
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3">Đang tải file Word...</p>
                    </div>
                `;
                
                // Convert base64 to Blob
                const base64Data = currentContract.url.split(',')[1];
                const binaryString = window.atob(base64Data);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
                
                // Create container
                const container = document.getElementById('pdfContainer');
                container.innerHTML = '';
                
                // Create document wrapper
                const docWrapper = document.createElement('div');
                docWrapper.className = 'word-document';
                docWrapper.id = 'pdfPage';
                docWrapper.style.position = 'relative';
                
                // Create content container for docx-preview
                const contentDiv = document.createElement('div');
                contentDiv.id = 'wordContent';
                contentDiv.className = 'word-content';
                docWrapper.appendChild(contentDiv);
                
                // Create markers container
                const markersContainer = document.createElement('div');
                markersContainer.id = 'markersContainer';
                markersContainer.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;';
                docWrapper.appendChild(markersContainer);
                
                container.appendChild(docWrapper);
                
                // Render Word document using docx-preview
                const docxLib = window.docx || window.docxPreview || window['docx-preview'];
                if (!docxLib) {
                    throw new Error('Thư viện docx-preview chưa được tải');
                }
                await docxLib.renderAsync(blob, contentDiv, null, {
                    className: 'docx',
                    inWrapper: true,
                    ignoreWidth: false,
                    ignoreHeight: false,
                    ignoreFonts: false,
                    breakPages: true,
                    experimental: true,
                    useBase64URL: true
                });
                
                // Enable pointer events for markers after render
                markersContainer.style.pointerEvents = 'auto';
                
                // Render markers - Word không scale nên dùng scale = 1
                currentPage = 1;
                totalPages = 1;
                currentPdf = null;
                pdfScale = 1; // Word không scale như PDF
                renderMarkers();
                
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('clearMarkersBtn').disabled = false;
                document.getElementById('pageNavigation').style.display = 'none';
                document.getElementById('pageInfo').style.display = 'block';
                document.getElementById('totalPages').textContent = '1';
                document.getElementById('currentPageNum').textContent = '1';
                
            } catch (error) {
                console.error('Error loading Word document:', error);
                document.getElementById('pdfContainer').innerHTML = `
                    <div class="alert alert-danger m-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Lỗi khi tải file Word: ${error.message}
                        <br><br>
                        <small>Lưu ý: Chỉ hỗ trợ file .docx (Word 2007 trở lên). File .doc cũ không được hỗ trợ.</small>
                    </div>
                `;
            }
        }

        async function renderPage(pageNum) {
            const page = await currentPdf.getPage(pageNum);
            const scale = 1.5;
            const viewport = page.getViewport({ scale });
            
            const container = document.getElementById('pdfContainer');
            container.innerHTML = '';
            
            // Create page wrapper
            const pageWrapper = document.createElement('div');
            pageWrapper.className = 'pdf-page';
            pageWrapper.id = 'pdfPage';
            pageWrapper.style.width = viewport.width + 'px';
            pageWrapper.style.height = viewport.height + 'px';
            pageWrapper.style.position = 'relative';
            
            // Create canvas
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            const context = canvas.getContext('2d');
            await page.render({ canvasContext: context, viewport }).promise;
            
            pageWrapper.appendChild(canvas);
            
            // Create markers container
            const markersContainer = document.createElement('div');
            markersContainer.id = 'markersContainer';
            markersContainer.style.position = 'absolute';
            markersContainer.style.top = '0';
            markersContainer.style.left = '0';
            markersContainer.style.width = '100%';
            markersContainer.style.height = '100%';
            pageWrapper.appendChild(markersContainer);
            
            container.appendChild(pageWrapper);
            
            // Render existing markers for this page
            renderMarkers();
            
            document.getElementById('currentPageNum').textContent = pageNum;
        }

        function renderMarkers() {
            const container = document.getElementById('markersContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Only show markers for current page
            const pageMarkers = markers.filter(m => m.page === currentPage);
            
            pageMarkers.forEach(marker => {
                const div = document.createElement('div');
                div.className = 'field-marker';
                div.dataset.markerId = marker.id;
                div.style.left = marker.x + 'px';
                div.style.top = marker.y + 'px';
                div.style.fontFamily = fontSettings.fontFamily;
                // Apply scale to font size so it matches PDF text
                div.style.fontSize = (fontSettings.fontSize * pdfScale) + 'px';
                div.innerHTML = `
                    <span class="marker-text">${marker.sampleData || marker.label}</span><i class="bi bi-x-circle remove-marker" style="margin-left: 5px; color: #dc3545; font-size: 11px;" onclick="event.stopPropagation(); removeMarker('${marker.id}')"></i>
                `;
                
                // Mouse events for dragging
                div.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('remove-marker')) return;
                    startDragMarker(e, marker, div);
                });
                
                container.appendChild(div);
            });
        }

        function removeMarker(markerId) {
            markers = markers.filter(m => m.id !== markerId);
            renderMarkers();
        }

        function clearAllMarkers() {
            if (confirm('Bạn có chắc muốn xóa tất cả marker?')) {
                markers = [];
                renderMarkers();
                showToast('Đã xóa', 'Tất cả marker đã được xóa', 'success');
            }
        }

        // ========== PAGE NAVIGATION ==========
        async function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                await renderPage(currentPage);
                updatePageNavigation();
            }
        }

        async function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                await renderPage(currentPage);
                updatePageNavigation();
            }
        }

        function updatePageNavigation() {
            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
            document.getElementById('pageIndicator').textContent = `${currentPage} / ${totalPages}`;
        }

        // ========== SAVE CONFIG ==========
        function saveContractConfig() {
            if (!currentContract) return;
            
            const select = document.getElementById('contractSelect');
            const index = parseInt(select.value);
            
            contracts[index].markers = markers;
            saveContracts();
            
            showToast('Đã lưu', 'Cấu hình đã được lưu thành công', 'success');
        }

        // ========== TOAST NOTIFICATION ==========
        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastTitle = document.getElementById('toastTitle');
            const toastBody = document.getElementById('toastBody');
            const toastIcon = document.getElementById('toastIcon');
            
            toastTitle.textContent = title;
            toastBody.textContent = message;
            
            toastIcon.className = 'bi me-2';
            if (type === 'success') {
                toastIcon.classList.add('bi-check-circle-fill', 'text-success');
            } else if (type === 'error') {
                toastIcon.classList.add('bi-x-circle-fill', 'text-danger');
            } else if (type === 'warning') {
                toastIcon.classList.add('bi-exclamation-circle-fill', 'text-warning');
            }
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // ========== EXPOSE FOR N8N ==========
        window.addContractFromN8n = addContract;
    </script>
</body>
</html>
